'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _immutable = require('immutable');

var _readtable = require('readtable');

var _readIdentifier = require('./read-identifier');

var _readIdentifier2 = _interopRequireDefault(_readIdentifier);

var _readNumeric = require('./read-numeric');

var _readNumeric2 = _interopRequireDefault(_readNumeric);

var _readString = require('./read-string');

var _readString2 = _interopRequireDefault(_readString);

var _readTemplate = require('./read-template');

var _readTemplate2 = _interopRequireDefault(_readTemplate);

var _readRegexp = require('./read-regexp.js');

var _readRegexp2 = _interopRequireDefault(_readRegexp);

var _readComment = require('./read-comment');

var _readComment2 = _interopRequireDefault(_readComment);

var _readDispatch = require('./read-dispatch');

var _tokens = require('../tokens');

var _utils = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// use https://github.com/mathiasbynens/regenerate to generate the Unicode code points when implementing modes

function eatWhitespace(stream) {
  stream.readString();
  return _tokens.EmptyToken;
}

const punctuatorTable = Object.keys(_tokens.punctuatorTable).reduce(_utils.insertSequence, {});

function readPunctuator(stream) {
  const len = (0, _utils.retrieveSequenceLength)(punctuatorTable, stream, 0);
  if (len > 0) {
    return new _tokens.PunctuatorToken({
      value: stream.readString(len)
    });
  }
  throw Error('Unknown punctuator');
}

const punctuatorEntries = Object.keys(punctuatorTable).map(p => ({
  key: p,
  mode: 'terminating',
  action: readPunctuator
}));

const whiteSpaceTable = [0x20, 0x09, 0x0B, 0x0C, 0xA0, 0x1680, 0x2000, 0x2001, 0x2002, 0x2003, 0x2004, 0x2005, 0x2006, 0x2007, 0x2008, 0x2009, 0x200A, 0x202F, 0x205F, 0x3000, 0xFEFF];

const whiteSpaceEntries = whiteSpaceTable.map(w => ({
  key: w,
  mode: 'terminating',
  action: eatWhitespace
}));

const lineTerminatorTable = [0x0A, 0x0D, 0x2028, 0x2029];

const lineTerminatorEntries = lineTerminatorTable.map(lt => ({
  key: lt,
  mode: 'terminating',
  action: function readLineTerminator(stream) {
    this.incrementLine();
    return eatWhitespace(stream);
  }
}));

const digits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

const numericEntries = digits.map(d => ({
  key: d,
  mode: 'non-terminating',
  action: _readNumeric2.default
}));

const quotes = ['\'', '"'];

const stringEntries = quotes.map(q => ({
  key: q,
  mode: 'terminating',
  action: _readString2.default
}));

const identifierEntry = {
  mode: 'non-terminating',
  action: _readIdentifier2.default
};

const templateEntry = {
  key: '`',
  mode: 'terminating',
  action: _readTemplate2.default
};

const primitiveReadtable = (0, _readtable.getCurrentReadtable)().extend(...[identifierEntry, ...whiteSpaceEntries, templateEntry, ...punctuatorEntries, ...lineTerminatorEntries, ...numericEntries, ...stringEntries]);

const dotEntry = {
  key: '.',
  mode: 'terminating',
  action: function readDot(stream, ...rest) {
    const nxt = stream.peek(1).charCodeAt(0);
    if ((0, _utils.isDecimalDigit)(nxt)) {
      return (0, _readNumeric2.default)(stream, ...rest);
    }
    return readPunctuator.call(this, stream);
  }
};

const keywordTable = Object.keys(_tokens.keywordTable).reduce(_utils.insertSequence, {});

const keywordEntries = Object.keys(keywordTable).map(k => ({
  key: k,
  mode: 'non-terminating',
  action: function readKeyword(stream) {
    const len = (0, _utils.retrieveSequenceLength)(keywordTable, stream, 0);
    if (len > 0 && !(0, _utils.isIdentifierPart)(stream.peek(len).charCodeAt(0))) {
      return new _tokens.KeywordToken({
        value: stream.readString(len)
      });
    }
    return _readIdentifier2.default.call(this, stream);
  }
}));

const delimiterPairs = [['[', ']'], ['(', ')']];

function readDelimiters(closing, stream, prefix, b) {
  const currentReadtable = (0, _readtable.getCurrentReadtable)();
  (0, _readtable.setCurrentReadtable)(primitiveReadtable);

  let results = _immutable.List.of(this.readToken(stream, (0, _immutable.List)(), b));

  (0, _readtable.setCurrentReadtable)(currentReadtable);
  return this.readUntil(closing, stream, results, b);
}

const delimiterEntries = delimiterPairs.map(p => ({
  key: p[0],
  mode: 'terminating',
  action: function readDefaultDelimiters(stream, prefix, b) {
    return readDelimiters.call(this, p[1], stream, prefix, true);
  }
}));

const bracesEntry = {
  key: '{',
  mode: 'terminating',
  action: function readBraces(stream, prefix, b) {
    const line = this.locationInfo.line;
    const innerB = (0, _utils.isExprPrefix)(line, b)(prefix);
    return readDelimiters.call(this, '}', stream, prefix, innerB);
  }
};

function readClosingDelimiter(opening, closing, stream, prefix, b) {
  if (prefix.first().token.value !== opening) {
    throw Error('Unmatched delimiter:', closing);
  }
  return readPunctuator.call(this, stream);
}

const unmatchedDelimiterEntries = [['{', '}'], ['[', ']'], ['(', ')']].map(p => ({
  key: p[1],
  mode: 'terminating',
  action: function readClosingDelimiters(stream, prefix, b) {
    return readClosingDelimiter.call(this, ...p, stream, prefix, b);
  }
}));

const divEntry = {
  key: '/',
  mode: 'terminating',
  action: function readDiv(stream, prefix, b) {
    let nxt = stream.peek(1);
    if (nxt === '/' || nxt === '*') {
      const result = _readComment2.default.call(this, stream);
      return result;
    }
    if ((0, _utils.isRegexPrefix)(b)(prefix)) {
      return _readRegexp2.default.call(this, stream, prefix, b);
    }
    return readPunctuator.call(this, stream);
  }
};

const dispatchBacktickEntry = {
  key: '`',
  mode: 'dispatch',
  action: _readDispatch.readSyntaxTemplate
};

const defaultDispatchEntry = {
  mode: 'dispatch',
  action: function readDefaultDispatch(...args) {
    this.readToken(...args);
    return _tokens.EmptyToken;
  }
};

const dispatchWhiteSpaceEntries = whiteSpaceTable.concat(lineTerminatorTable).map(w => ({
  key: w,
  mode: 'dispatch',
  action: function readDispatchWhitespace(stream, prefix, allowExprs, dispatchKey) {
    this.readToken(stream, prefix, allowExprs);
    return new _tokens.IdentifierToken({ value: dispatchKey });
  }
}));

const atEntry = {
  key: '@',
  mode: 'terminating',
  action: function readAt(stream, prefix) {
    const nxt = stream.peek(1),
          nxtCode = nxt.charCodeAt(0);
    if ((0, _readtable.isEOS)(nxt) || (0, _utils.isWhiteSpace)(nxtCode) || (0, _utils.isLineTerminator)(nxtCode)) {
      return new _tokens.IdentifierToken({ value: stream.readString() });
    }
    throw new SyntaxError('Invalid or unexpected token');
  }
};

const defaultReadtable = primitiveReadtable.extend(...[dotEntry, ...delimiterEntries, ...unmatchedDelimiterEntries, bracesEntry, divEntry, ...keywordEntries, defaultDispatchEntry, dispatchBacktickEntry, ...dispatchWhiteSpaceEntries, atEntry]);

exports.default = defaultReadtable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yZWFkZXIvZGVmYXVsdC1yZWFkdGFibGUuanMiXSwibmFtZXMiOlsiZWF0V2hpdGVzcGFjZSIsInN0cmVhbSIsInJlYWRTdHJpbmciLCJwdW5jdHVhdG9yVGFibGUiLCJPYmplY3QiLCJrZXlzIiwicmVkdWNlIiwicmVhZFB1bmN0dWF0b3IiLCJsZW4iLCJ2YWx1ZSIsIkVycm9yIiwicHVuY3R1YXRvckVudHJpZXMiLCJtYXAiLCJwIiwia2V5IiwibW9kZSIsImFjdGlvbiIsIndoaXRlU3BhY2VUYWJsZSIsIndoaXRlU3BhY2VFbnRyaWVzIiwidyIsImxpbmVUZXJtaW5hdG9yVGFibGUiLCJsaW5lVGVybWluYXRvckVudHJpZXMiLCJsdCIsInJlYWRMaW5lVGVybWluYXRvciIsImluY3JlbWVudExpbmUiLCJkaWdpdHMiLCJudW1lcmljRW50cmllcyIsImQiLCJxdW90ZXMiLCJzdHJpbmdFbnRyaWVzIiwicSIsImlkZW50aWZpZXJFbnRyeSIsInRlbXBsYXRlRW50cnkiLCJwcmltaXRpdmVSZWFkdGFibGUiLCJleHRlbmQiLCJkb3RFbnRyeSIsInJlYWREb3QiLCJyZXN0Iiwibnh0IiwicGVlayIsImNoYXJDb2RlQXQiLCJjYWxsIiwia2V5d29yZFRhYmxlIiwia2V5d29yZEVudHJpZXMiLCJrIiwicmVhZEtleXdvcmQiLCJkZWxpbWl0ZXJQYWlycyIsInJlYWREZWxpbWl0ZXJzIiwiY2xvc2luZyIsInByZWZpeCIsImIiLCJjdXJyZW50UmVhZHRhYmxlIiwicmVzdWx0cyIsIm9mIiwicmVhZFRva2VuIiwicmVhZFVudGlsIiwiZGVsaW1pdGVyRW50cmllcyIsInJlYWREZWZhdWx0RGVsaW1pdGVycyIsImJyYWNlc0VudHJ5IiwicmVhZEJyYWNlcyIsImxpbmUiLCJsb2NhdGlvbkluZm8iLCJpbm5lckIiLCJyZWFkQ2xvc2luZ0RlbGltaXRlciIsIm9wZW5pbmciLCJmaXJzdCIsInRva2VuIiwidW5tYXRjaGVkRGVsaW1pdGVyRW50cmllcyIsInJlYWRDbG9zaW5nRGVsaW1pdGVycyIsImRpdkVudHJ5IiwicmVhZERpdiIsInJlc3VsdCIsImRpc3BhdGNoQmFja3RpY2tFbnRyeSIsImRlZmF1bHREaXNwYXRjaEVudHJ5IiwicmVhZERlZmF1bHREaXNwYXRjaCIsImFyZ3MiLCJkaXNwYXRjaFdoaXRlU3BhY2VFbnRyaWVzIiwiY29uY2F0IiwicmVhZERpc3BhdGNoV2hpdGVzcGFjZSIsImFsbG93RXhwcnMiLCJkaXNwYXRjaEtleSIsImF0RW50cnkiLCJyZWFkQXQiLCJueHRDb2RlIiwiU3ludGF4RXJyb3IiLCJkZWZhdWx0UmVhZHRhYmxlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFFQTs7OztBQUlBOztBQUVBLFNBQVNBLGFBQVQsQ0FBdUJDLE1BQXZCLEVBQTJDO0FBQ3pDQSxTQUFPQyxVQUFQO0FBQ0E7QUFDRDs7QUFFRCxNQUFNQyxrQkFBa0JDLE9BQU9DLElBQVAsMEJBQStCQyxNQUEvQix3QkFBc0QsRUFBdEQsQ0FBeEI7O0FBRUEsU0FBU0MsY0FBVCxDQUF3Qk4sTUFBeEIsRUFBZ0M7QUFDOUIsUUFBTU8sTUFBTSxtQ0FBdUJMLGVBQXZCLEVBQXdDRixNQUF4QyxFQUFnRCxDQUFoRCxDQUFaO0FBQ0EsTUFBSU8sTUFBTSxDQUFWLEVBQWE7QUFDWCxXQUFPLDRCQUFvQjtBQUN6QkMsYUFBT1IsT0FBT0MsVUFBUCxDQUFrQk0sR0FBbEI7QUFEa0IsS0FBcEIsQ0FBUDtBQUdEO0FBQ0QsUUFBTUUsTUFBTSxvQkFBTixDQUFOO0FBQ0Q7O0FBRUQsTUFBTUMsb0JBQW9CUCxPQUFPQyxJQUFQLENBQVlGLGVBQVosRUFBNkJTLEdBQTdCLENBQWlDQyxNQUFNO0FBQy9EQyxPQUFLRCxDQUQwRDtBQUUvREUsUUFBTSxhQUZ5RDtBQUcvREMsVUFBUVQ7QUFIdUQsQ0FBTixDQUFqQyxDQUExQjs7QUFNQSxNQUFN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QW5CLENBQ3ZCLEdBQUcsQ0FBQ0MsUUFBRCxFQUNELEdBQUdxQixnQkFERixFQUVELEdBQUdXLHlCQUZGLEVBR0RULFdBSEMsRUFJRFcsUUFKQyxFQUtELEdBQUcxQixjQUxGLEVBTUQ4QixvQkFOQyxFQU9ERCxxQkFQQyxFQVFELEdBQUdJLHlCQVJGLEVBU0RLLE9BVEMsQ0FEb0IsQ0FBekI7O2tCQVllSSxnQiIsImZpbGUiOiJkZWZhdWx0LXJlYWR0YWJsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7IExpc3QgfSBmcm9tICdpbW11dGFibGUnO1xuaW1wb3J0IHsgaXNFT1MsIGdldEN1cnJlbnRSZWFkdGFibGUsIHNldEN1cnJlbnRSZWFkdGFibGUgfSBmcm9tICdyZWFkdGFibGUnO1xuaW1wb3J0IHJlYWRJZGVudGlmaWVyIGZyb20gJy4vcmVhZC1pZGVudGlmaWVyJztcbmltcG9ydCByZWFkTnVtZXJpY0xpdGVyYWwgZnJvbSAnLi9yZWFkLW51bWVyaWMnO1xuaW1wb3J0IHJlYWRTdHJpbmdMaXRlcmFsIGZyb20gJy4vcmVhZC1zdHJpbmcnO1xuaW1wb3J0IHJlYWRUZW1wbGF0ZUxpdGVyYWwgZnJvbSAnLi9yZWFkLXRlbXBsYXRlJztcbmltcG9ydCByZWFkUmVnRXhwIGZyb20gJy4vcmVhZC1yZWdleHAuanMnO1xuaW1wb3J0IHJlYWRDb21tZW50IGZyb20gJy4vcmVhZC1jb21tZW50JztcbmltcG9ydCB7IHJlYWRTeW50YXhUZW1wbGF0ZSB9IGZyb20gJy4vcmVhZC1kaXNwYXRjaCc7XG5pbXBvcnQgeyBwdW5jdHVhdG9yVGFibGUgYXMgcHVuY3R1YXRvck1hcHBpbmcsIGtleXdvcmRUYWJsZSBhcyBrZXl3b3JkTWFwcGluZyxcbiAgICAgICAgIEtleXdvcmRUb2tlbiwgUHVuY3R1YXRvclRva2VuLCBFbXB0eVRva2VuLCBJZGVudGlmaWVyVG9rZW4gfSBmcm9tICcuLi90b2tlbnMnO1xuaW1wb3J0IHsgaW5zZXJ0U2VxdWVuY2UsIHJldHJpZXZlU2VxdWVuY2VMZW5ndGgsIGlzRXhwclByZWZpeCwgaXNSZWdleFByZWZpeCwgaXNJZGVudGlmaWVyUGFydCwgaXNXaGl0ZVNwYWNlLCBpc0xpbmVUZXJtaW5hdG9yLCBpc0RlY2ltYWxEaWdpdCB9IGZyb20gJy4vdXRpbHMnO1xuXG5pbXBvcnQgdHlwZSAgeyBDaGFyU3RyZWFtIH0gZnJvbSAncmVhZHRhYmxlJztcblxuLy8gdXNlIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXRoaWFzYnluZW5zL3JlZ2VuZXJhdGUgdG8gZ2VuZXJhdGUgdGhlIFVuaWNvZGUgY29kZSBwb2ludHMgd2hlbiBpbXBsZW1lbnRpbmcgbW9kZXNcblxuZnVuY3Rpb24gZWF0V2hpdGVzcGFjZShzdHJlYW06IENoYXJTdHJlYW0pIHtcbiAgc3RyZWFtLnJlYWRTdHJpbmcoKTtcbiAgcmV0dXJuIEVtcHR5VG9rZW47XG59XG5cbmNvbnN0IHB1bmN0dWF0b3JUYWJsZSA9IE9iamVjdC5rZXlzKHB1bmN0dWF0b3JNYXBwaW5nKS5yZWR1Y2UoaW5zZXJ0U2VxdWVuY2UsIHt9KTtcblxuZnVuY3Rpb24gcmVhZFB1bmN0dWF0b3Ioc3RyZWFtKSB7XG4gIGNvbnN0IGxlbiA9IHJldHJpZXZlU2VxdWVuY2VMZW5ndGgocHVuY3R1YXRvclRhYmxlLCBzdHJlYW0sIDApO1xuICBpZiAobGVuID4gMCkge1xuICAgIHJldHVybiBuZXcgUHVuY3R1YXRvclRva2VuKHtcbiAgICAgIHZhbHVlOiBzdHJlYW0ucmVhZFN0cmluZyhsZW4pXG4gICAgfSk7XG4gIH1cbiAgdGhyb3cgRXJyb3IoJ1Vua25vd24gcHVuY3R1YXRvcicpO1xufVxuXG5jb25zdCBwdW5jdHVhdG9yRW50cmllcyA9IE9iamVjdC5rZXlzKHB1bmN0dWF0b3JUYWJsZSkubWFwKHAgPT4gKHtcbiAga2V5OiBwLFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IHJlYWRQdW5jdHVhdG9yXG59KSk7XG5cbmNvbnN0IHdoaXRlU3BhY2VUYWJsZSA9IFsweDIwLCAweDA5LCAweDBCLCAweDBDLCAweEEwLCAweDE2ODAsIDB4MjAwMCwgMHgyMDAxLCAweDIwMDIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgMHgyMDAzLCAweDIwMDQsIDB4MjAwNSwgMHgyMDA2LCAweDIwMDcsIDB4MjAwOCwgMHgyMDA5LCAweDIwMEEsXG4gICAgICAgICAgICAgICAgICAgICAgICAgMHgyMDJGLCAweDIwNUYsIDB4MzAwMCwgMHhGRUZGXTtcblxuY29uc3Qgd2hpdGVTcGFjZUVudHJpZXMgPSB3aGl0ZVNwYWNlVGFibGUubWFwKHcgPT4gKHtcbiAga2V5OiB3LFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IGVhdFdoaXRlc3BhY2Vcbn0pKTtcblxuY29uc3QgbGluZVRlcm1pbmF0b3JUYWJsZSA9IFsweDBBLCAweDBELCAweDIwMjgsIDB4MjAyOV07XG5cbmNvbnN0IGxpbmVUZXJtaW5hdG9yRW50cmllcyA9IGxpbmVUZXJtaW5hdG9yVGFibGUubWFwKGx0ID0+ICh7XG4gIGtleTogbHQsXG4gIG1vZGU6ICd0ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogZnVuY3Rpb24gcmVhZExpbmVUZXJtaW5hdG9yKHN0cmVhbSkge1xuICAgIHRoaXMuaW5jcmVtZW50TGluZSgpO1xuICAgIHJldHVybiBlYXRXaGl0ZXNwYWNlKHN0cmVhbSk7XG4gIH1cbn0pKTtcblxuY29uc3QgZGlnaXRzID0gWycwJywgJzEnLCAnMicsICczJywgJzQnLCAnNScsICc2JywgJzcnLCAnOCcsICc5J107XG5cbmNvbnN0IG51bWVyaWNFbnRyaWVzID0gZGlnaXRzLm1hcChkID0+ICh7XG4gIGtleTogZCxcbiAgbW9kZTogJ25vbi10ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogcmVhZE51bWVyaWNMaXRlcmFsXG59KSk7XG5cbmNvbnN0IHF1b3RlcyA9IFsnXFwnJywgJ1wiJ107XG5cbmNvbnN0IHN0cmluZ0VudHJpZXMgPSBxdW90ZXMubWFwKHEgPT4gKHtcbiAga2V5OiBxLFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IHJlYWRTdHJpbmdMaXRlcmFsXG59KSk7XG5cbmNvbnN0IGlkZW50aWZpZXJFbnRyeSA9IHtcbiAgbW9kZTogJ25vbi10ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogcmVhZElkZW50aWZpZXJcbn07XG5cbmNvbnN0IHRlbXBsYXRlRW50cnkgPSB7XG4gIGtleTogJ2AnLFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IHJlYWRUZW1wbGF0ZUxpdGVyYWxcbn07XG5cbmNvbnN0IHByaW1pdGl2ZVJlYWR0YWJsZSA9IGdldEN1cnJlbnRSZWFkdGFibGUoKS5leHRlbmQoXG4gICAgLi4uW2lkZW50aWZpZXJFbnRyeSxcbiAgICAgICAgLi4ud2hpdGVTcGFjZUVudHJpZXMsXG4gICAgICAgIHRlbXBsYXRlRW50cnksXG4gICAgICAgIC4uLnB1bmN0dWF0b3JFbnRyaWVzLFxuICAgICAgICAuLi5saW5lVGVybWluYXRvckVudHJpZXMsXG4gICAgICAgIC4uLm51bWVyaWNFbnRyaWVzLFxuICAgICAgICAuLi5zdHJpbmdFbnRyaWVzXSk7XG5cbmNvbnN0IGRvdEVudHJ5ID0ge1xuICBrZXk6ICcuJyxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkRG90KHN0cmVhbSwgLi4ucmVzdCkge1xuICAgIGNvbnN0IG54dCA9IHN0cmVhbS5wZWVrKDEpLmNoYXJDb2RlQXQoMCk7XG4gICAgaWYgKGlzRGVjaW1hbERpZ2l0KG54dCkpIHtcbiAgICAgIHJldHVybiByZWFkTnVtZXJpY0xpdGVyYWwoc3RyZWFtLCAuLi5yZXN0KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlYWRQdW5jdHVhdG9yLmNhbGwodGhpcywgc3RyZWFtKTtcbiAgfVxufTtcblxuY29uc3Qga2V5d29yZFRhYmxlID0gT2JqZWN0LmtleXMoa2V5d29yZE1hcHBpbmcpLnJlZHVjZShpbnNlcnRTZXF1ZW5jZSwge30pO1xuXG5jb25zdCBrZXl3b3JkRW50cmllcyA9IE9iamVjdC5rZXlzKGtleXdvcmRUYWJsZSkubWFwKGsgPT4gKHtcbiAga2V5OiBrLFxuICBtb2RlOiAnbm9uLXRlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkS2V5d29yZChzdHJlYW0pIHtcbiAgICBjb25zdCBsZW4gPSByZXRyaWV2ZVNlcXVlbmNlTGVuZ3RoKGtleXdvcmRUYWJsZSwgc3RyZWFtLCAwKTtcbiAgICBpZiAobGVuID4gMCAmJiAhaXNJZGVudGlmaWVyUGFydChzdHJlYW0ucGVlayhsZW4pLmNoYXJDb2RlQXQoMCkpKSB7XG4gICAgICByZXR1cm4gbmV3IEtleXdvcmRUb2tlbih7XG4gICAgICAgIHZhbHVlOiBzdHJlYW0ucmVhZFN0cmluZyhsZW4pXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlYWRJZGVudGlmaWVyLmNhbGwodGhpcywgc3RyZWFtKTtcbiAgfVxufSkpO1xuXG5jb25zdCBkZWxpbWl0ZXJQYWlycyA9IFtbJ1snLCddJ10sIFsnKCcsJyknXV07XG5cbmZ1bmN0aW9uIHJlYWREZWxpbWl0ZXJzKGNsb3NpbmcsIHN0cmVhbSwgcHJlZml4LCBiKSB7XG4gIGNvbnN0IGN1cnJlbnRSZWFkdGFibGUgPSBnZXRDdXJyZW50UmVhZHRhYmxlKCk7XG4gIHNldEN1cnJlbnRSZWFkdGFibGUocHJpbWl0aXZlUmVhZHRhYmxlKTtcblxuICBsZXQgcmVzdWx0cyA9IExpc3Qub2YodGhpcy5yZWFkVG9rZW4oc3RyZWFtLCBMaXN0KCksIGIpKTtcblxuICBzZXRDdXJyZW50UmVhZHRhYmxlKGN1cnJlbnRSZWFkdGFibGUpO1xuICByZXR1cm4gdGhpcy5yZWFkVW50aWwoY2xvc2luZywgc3RyZWFtLCByZXN1bHRzLCBiKTtcbn1cblxuY29uc3QgZGVsaW1pdGVyRW50cmllcyA9IGRlbGltaXRlclBhaXJzLm1hcChwID0+ICh7XG4gIGtleTogcFswXSxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkRGVmYXVsdERlbGltaXRlcnMoc3RyZWFtLCBwcmVmaXgsIGIpIHtcbiAgICByZXR1cm4gcmVhZERlbGltaXRlcnMuY2FsbCh0aGlzLCBwWzFdLCBzdHJlYW0sIHByZWZpeCwgdHJ1ZSk7XG4gIH1cbn0pKTtcblxuY29uc3QgYnJhY2VzRW50cnkgPSB7XG4gIGtleTogJ3snLFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IGZ1bmN0aW9uIHJlYWRCcmFjZXMoc3RyZWFtLCBwcmVmaXgsIGIpIHtcbiAgICBjb25zdCBsaW5lID0gdGhpcy5sb2NhdGlvbkluZm8ubGluZTtcbiAgICBjb25zdCBpbm5lckIgPSBpc0V4cHJQcmVmaXgobGluZSwgYikocHJlZml4KTtcbiAgICByZXR1cm4gcmVhZERlbGltaXRlcnMuY2FsbCh0aGlzLCAnfScsIHN0cmVhbSwgcHJlZml4LCBpbm5lckIpO1xuICB9XG59O1xuXG5mdW5jdGlvbiByZWFkQ2xvc2luZ0RlbGltaXRlcihvcGVuaW5nLCBjbG9zaW5nLCBzdHJlYW0sIHByZWZpeCwgYikge1xuICBpZiAocHJlZml4LmZpcnN0KCkudG9rZW4udmFsdWUgIT09IG9wZW5pbmcpIHtcbiAgICB0aHJvdyBFcnJvcignVW5tYXRjaGVkIGRlbGltaXRlcjonLCBjbG9zaW5nKTtcbiAgfVxuICByZXR1cm4gcmVhZFB1bmN0dWF0b3IuY2FsbCh0aGlzLCBzdHJlYW0pO1xufVxuXG5jb25zdCB1bm1hdGNoZWREZWxpbWl0ZXJFbnRyaWVzID0gW1sneycsJ30nXSwgWydbJywnXSddLCBbJygnLCcpJ11dLm1hcChwID0+ICh7XG4gIGtleTogcFsxXSxcbiAgbW9kZTogJ3Rlcm1pbmF0aW5nJyxcbiAgYWN0aW9uOiBmdW5jdGlvbiByZWFkQ2xvc2luZ0RlbGltaXRlcnMoc3RyZWFtLCBwcmVmaXgsIGIpIHtcbiAgICByZXR1cm4gcmVhZENsb3NpbmdEZWxpbWl0ZXIuY2FsbCh0aGlzLCAuLi5wLCBzdHJlYW0sIHByZWZpeCwgYik7XG4gIH1cbn0pKTtcblxuY29uc3QgZGl2RW50cnkgPSB7XG4gIGtleTogJy8nLFxuICBtb2RlOiAndGVybWluYXRpbmcnLFxuICBhY3Rpb246IGZ1bmN0aW9uIHJlYWREaXYoc3RyZWFtLCBwcmVmaXgsIGIpIHtcbiAgICBsZXQgbnh0ID0gc3RyZWFtLnBlZWsoMSk7XG4gICAgaWYgKG54dCA9PT0gJy8nIHx8IG54dCA9PT0gJyonKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSByZWFkQ29tbWVudC5jYWxsKHRoaXMsIHN0cmVhbSk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBpZiAoaXNSZWdleFByZWZpeChiKShwcmVmaXgpKSB7XG4gICAgICByZXR1cm4gcmVhZFJlZ0V4cC5jYWxsKHRoaXMsIHN0cmVhbSwgcHJlZml4LCBiKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlYWRQdW5jdHVhdG9yLmNhbGwodGhpcywgc3RyZWFtKTtcbiAgfVxufTtcblxuY29uc3QgZGlzcGF0Y2hCYWNrdGlja0VudHJ5ID0ge1xuICBrZXk6ICdgJyxcbiAgbW9kZTogJ2Rpc3BhdGNoJyxcbiAgYWN0aW9uOiByZWFkU3ludGF4VGVtcGxhdGVcbn07XG5cbmNvbnN0IGRlZmF1bHREaXNwYXRjaEVudHJ5ID0ge1xuICBtb2RlOiAnZGlzcGF0Y2gnLFxuICBhY3Rpb246IGZ1bmN0aW9uIHJlYWREZWZhdWx0RGlzcGF0Y2goLi4uYXJncykge1xuICAgIHRoaXMucmVhZFRva2VuKC4uLmFyZ3MpO1xuICAgIHJldHVybiBFbXB0eVRva2VuO1xuICB9XG59O1xuXG5jb25zdCBkaXNwYXRjaFdoaXRlU3BhY2VFbnRyaWVzID0gd2hpdGVTcGFjZVRhYmxlLmNvbmNhdChsaW5lVGVybWluYXRvclRhYmxlKS5tYXAodyA9PiAoe1xuICBrZXk6IHcsXG4gIG1vZGU6ICdkaXNwYXRjaCcsXG4gIGFjdGlvbjogZnVuY3Rpb24gcmVhZERpc3BhdGNoV2hpdGVzcGFjZShzdHJlYW0sIHByZWZpeCwgYWxsb3dFeHBycywgZGlzcGF0Y2hLZXkpIHtcbiAgICB0aGlzLnJlYWRUb2tlbihzdHJlYW0sIHByZWZpeCwgYWxsb3dFeHBycyk7XG4gICAgcmV0dXJuIG5ldyBJZGVudGlmaWVyVG9rZW4oeyB2YWx1ZTogZGlzcGF0Y2hLZXkgfSk7XG4gIH1cbn0pKTtcblxuY29uc3QgYXRFbnRyeSA9IHtcbiAga2V5OiAnQCcsXG4gIG1vZGU6ICd0ZXJtaW5hdGluZycsXG4gIGFjdGlvbjogZnVuY3Rpb24gcmVhZEF0KHN0cmVhbSwgcHJlZml4KSB7XG4gICAgY29uc3Qgbnh0ID0gc3RyZWFtLnBlZWsoMSksIG54dENvZGUgPSBueHQuY2hhckNvZGVBdCgwKTtcbiAgICBpZiAoaXNFT1Mobnh0KSB8fCBpc1doaXRlU3BhY2Uobnh0Q29kZSkgfHwgaXNMaW5lVGVybWluYXRvcihueHRDb2RlKSkge1xuICAgICAgcmV0dXJuIG5ldyBJZGVudGlmaWVyVG9rZW4oeyB2YWx1ZTogc3RyZWFtLnJlYWRTdHJpbmcoKSB9KTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCdJbnZhbGlkIG9yIHVuZXhwZWN0ZWQgdG9rZW4nKTtcbiAgfVxufTtcblxuY29uc3QgZGVmYXVsdFJlYWR0YWJsZSA9IHByaW1pdGl2ZVJlYWR0YWJsZS5leHRlbmQoXG4gIC4uLltkb3RFbnRyeSxcbiAgICAuLi5kZWxpbWl0ZXJFbnRyaWVzLFxuICAgIC4uLnVubWF0Y2hlZERlbGltaXRlckVudHJpZXMsXG4gICAgYnJhY2VzRW50cnksXG4gICAgZGl2RW50cnksXG4gICAgLi4ua2V5d29yZEVudHJpZXMsXG4gICAgZGVmYXVsdERpc3BhdGNoRW50cnksXG4gICAgZGlzcGF0Y2hCYWNrdGlja0VudHJ5LFxuICAgIC4uLmRpc3BhdGNoV2hpdGVTcGFjZUVudHJpZXMsXG4gICAgYXRFbnRyeV0pO1xuXG5leHBvcnQgZGVmYXVsdCBkZWZhdWx0UmVhZHRhYmxlO1xuIl19