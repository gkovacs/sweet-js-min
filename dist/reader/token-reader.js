'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSlice = getSlice;
exports.default = read;

var _readtable = require('readtable');

var _defaultReadtable = require('./default-readtable');

var _defaultReadtable2 = _interopRequireDefault(_defaultReadtable);

var _immutable = require('immutable');

var _tokens = require('../tokens');

var _syntax = require('../syntax');

var _syntax2 = _interopRequireDefault(_syntax);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _readtable.setCurrentReadtable)(_defaultReadtable2.default);

function getSlice(stream, startLocation) {
  return {
    text: stream.getSlice(startLocation.position),
    start: startLocation.position,
    startLocation,
    end: stream.sourceInfo.position
  };
}

const streams = new WeakMap();

class ReadError extends Error {
  constructor({ index, line, column, message }) {
    super(message);
    this.index = index;
    this.line = line;
    this.column = column;
    this.message = `[${ line }:${ column }] ${ message }`;
  }
}

class TokenReader extends _readtable.Reader {
  constructor(stream, context) {
    super();
    this.context = context;
    streams.set(this, stream);
    this.locationInfo = {
      line: 1,
      column: 1
    };
  }

  createError(msg) {
    let message = msg.replace(/\{(\d+)\}/g, (_, n) => JSON.stringify(arguments[+n + 1]));
    // $FlowFixMe: decide on how to handle possible nullability
    return new ReadError({ message, index: streams.get(this).sourceInfo.position, line: this.locationInfo.line, column: this.locationInfo.column });
  }

  createILLEGAL(char) {
    return !(0, _readtable.isEOS)(char) ? this.createError('Unexpected {0}', char) : this.createError('Unexpected end of input');
  }

  readToken(stream, ...rest) {
    const startLocation = Object.assign({}, this.locationInfo, stream.sourceInfo);
    const result = super.read(stream, ...rest);

    if (startLocation.column === this.locationInfo.column && startLocation.line === this.locationInfo.line) {
      this.locationInfo.column += stream.sourceInfo.position - startLocation.position;
    }

    if (result === _tokens.EmptyToken) return result;

    if (!_immutable.List.isList(result)) result.slice = getSlice(stream, startLocation);

    return new _syntax2.default(result, this.context);
  }

  readUntil(close, stream, results, exprAllowed) {
    let result,
        done = false;
    do {
      if ((0, _readtable.isEOS)(stream.peek())) break;
      done = typeof close === 'function' ? close() : stream.peek() === close;
      result = this.readToken(stream, results, exprAllowed);

      if (result !== _tokens.EmptyToken) {
        results = results.push(result);
      }
    } while (!done);
    return results;
  }

  incrementLine() {
    this.locationInfo.line += 1;
    this.locationInfo.column = 1;
  }
}

function read(source, context) {
  const stream = typeof source === 'string' ? new _readtable.CharStream(source) : source;
  if ((0, _readtable.isEOS)(stream.peek())) return (0, _immutable.List)();
  return new TokenReader(stream, context).readUntil(null, stream, (0, _immutable.List)(), false);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yZWFkZXIvdG9rZW4tcmVhZGVyLmpzIl0sIm5hbWVzIjpbImdldFNsaWNlIiwicmVhZCIsInN0cmVhbSIsInN0YXJ0TG9jYXRpb24iLCJ0ZXh0IiwicG9zaXRpb24iLCJzdGFydCIsImVuZCIsInNvdXJjZUluZm8iLCJzdHJlYW1zIiwiV2Vha01hcCIsIlJlYWRFcnJvciIsIkVycm9yIiwiY29uc3RydWN0b3IiLCJpbmRleCIsImxpbmUiLCJjb2x1bW4iLCJtZXNzYWdlIiwiVG9rZW5SZWFkZXIiLCJjb250ZXh0Iiwic2V0IiwibG9jYXRpb25JbmZvIiwiY3JlYXRlRXJyb3IiLCJtc2ciLCJyZXBsYWNlIiwiXyIsIm4iLCJKU09OIiwic3RyaW5naWZ5IiwiYXJndW1lbnRzIiwiZ2V0IiwiY3JlYXRlSUxMRUdBTCIsImNoYXIiLCJyZWFkVG9rZW4iLCJyZXN0IiwiT2JqZWN0IiwiYXNzaWduIiwicmVzdWx0IiwiaXNMaXN0Iiwic2xpY2UiLCJyZWFkVW50aWwiLCJjbG9zZSIsInJlc3VsdHMiLCJleHByQWxsb3dlZCIsImRvbmUiLCJwZWVrIiwicHVzaCIsImluY3JlbWVudExpbmUiLCJzb3VyY2UiXSwibWFwcGluZ3MiOiI7Ozs7O1FBc0JnQkEsUSxHQUFBQSxRO2tCQXNGUUMsSTs7QUExR3hCOztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUlBOztBQVlPLFNBQVNELFFBQVQsQ0FBa0JFLE1BQWxCLEVBQXNDQyxhQUF0QyxFQUEyRTtBQUNoRixTQUFPO0FBQ0xDLFVBQU1GLE9BQU9GLFFBQVAsQ0FBZ0JHLGNBQWNFLFFBQTlCLENBREQ7QUFFTEMsV0FBT0gsY0FBY0UsUUFGaEI7QUFHTEYsaUJBSEs7QUFJTEksU0FBS0wsT0FBT00sVUFBUCxDQUFrQkg7QUFKbEIsR0FBUDtBQU1EOztBQUVELE1BQU1JLFVBQVUsSUFBSUMsT0FBSixFQUFoQjs7QUFFQSxNQUFNQyxTQUFOLFNBQXdCQyxLQUF4QixDQUE4QjtBQUs1QkMsY0FBWSxFQUFFQyxLQUFGLEVBQVNDLElBQVQsRUFBZUMsTUFBZixFQUF1QkMsT0FBdkIsRUFBWixFQUFnSDtBQUM5RyxVQUFNQSxPQUFOO0FBQ0EsU0FBS0gsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsU0FBS0MsSUFBTCxHQUFZQSxJQUFaO0FBQ0EsU0FBS0MsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0MsT0FBTCxHQUFnQixLQUFHRixJQUFLLE1BQUdDLE1BQU8sT0FBSUMsT0FBUSxHQUE5QztBQUNEO0FBWDJCOztBQWM5QixNQUFNQyxXQUFOLDJCQUFpQztBQUcvQkwsY0FBWVgsTUFBWixFQUFnQ2lCLE9BQWhDLEVBQW1EO0FBQ2pEO0FBQ0EsU0FBS0EsT0FBTCxHQUFlQSxPQUFmO0FBQ0FWLFlBQVFXLEdBQVIsQ0FBWSxJQUFaLEVBQWtCbEIsTUFBbEI7QUFDQSxTQUFLbUIsWUFBTCxHQUFvQjtBQUNsQk4sWUFBTSxDQURZO0FBRWxCQyxjQUFRO0FBRlUsS0FBcEI7QUFJRDs7QUFFRE0sY0FBWUMsR0FBWixFQUFvQztBQUNsQyxRQUFJTixVQUFVTSxJQUFJQyxPQUFKLENBQVksWUFBWixFQUEwQixDQUFDQyxDQUFELEVBQUlDLENBQUosS0FBVUMsS0FBS0MsU0FBTCxDQUFlQyxVQUFVLENBQUNILENBQUQsR0FBSyxDQUFmLENBQWYsQ0FBcEMsQ0FBZDtBQUNBO0FBQ0EsV0FBTyxJQUFJZixTQUFKLENBQWMsRUFBRU0sT0FBRixFQUFXSCxPQUFPTCxRQUFRcUIsR0FBUixDQUFZLElBQVosRUFBa0J0QixVQUFsQixDQUE2QkgsUUFBL0MsRUFBeURVLE1BQU0sS0FBS00sWUFBTCxDQUFrQk4sSUFBakYsRUFBdUZDLFFBQVEsS0FBS0ssWUFBTCxDQUFrQkwsTUFBakgsRUFBZCxDQUFQO0FBQ0Q7O0FBRURlLGdCQUFjQyxJQUFkLEVBQW9CO0FBQ2xCLFdBQU8sQ0FBQyxzQkFBTUEsSUFBTixDQUFELEdBQ0gsS0FBS1YsV0FBTCxDQUFpQixnQkFBakIsRUFBbUNVLElBQW5DLENBREcsR0FFTCxLQUFLVixXQUFMLENBQWlCLHlCQUFqQixDQUZGO0FBR0Q7O0FBRURXLFlBQVUvQixNQUFWLEVBQThCLEdBQUdnQyxJQUFqQyxFQUEyRDtBQUN6RCxVQUFNL0IsZ0JBQWdCZ0MsT0FBT0MsTUFBUCxDQUFjLEVBQWQsRUFBa0IsS0FBS2YsWUFBdkIsRUFBcUNuQixPQUFPTSxVQUE1QyxDQUF0QjtBQUNBLFVBQU02QixTQUFTLE1BQU1wQyxJQUFOLENBQVdDLE1BQVgsRUFBbUIsR0FBR2dDLElBQXRCLENBQWY7O0FBR0EsUUFBSS9CLGNBQWNhLE1BQWQsS0FBeUIsS0FBS0ssWUFBTCxDQUFrQkwsTUFBM0MsSUFBcURiLGNBQWNZLElBQWQsS0FBdUIsS0FBS00sWUFBTCxDQUFrQk4sSUFBbEcsRUFBd0c7QUFDdEcsV0FBS00sWUFBTCxDQUFrQkwsTUFBbEIsSUFBNEJkLE9BQU9NLFVBQVAsQ0FBa0JILFFBQWxCLEdBQTZCRixjQUFjRSxRQUF2RTtBQUNEOztBQUVELFFBQUlnQyw2QkFBSixFQUEyQixPQUFPQSxNQUFQOztBQUUzQixRQUFJLENBQUMsZ0JBQUtDLE1BQUwsQ0FBWUQsTUFBWixDQUFMLEVBQTBCQSxPQUFPRSxLQUFQLEdBQWV2QyxTQUFTRSxNQUFULEVBQWlCQyxhQUFqQixDQUFmOztBQUUxQixXQUFPLHFCQUFXa0MsTUFBWCxFQUFtQixLQUFLbEIsT0FBeEIsQ0FBUDtBQUNEOztBQUVEcUIsWUFBVUMsS0FBVixFQUFzQ3ZDLE1BQXRDLEVBQTBEd0MsT0FBMUQsRUFBaUZDLFdBQWpGLEVBQXFIO0FBQ25ILFFBQUlOLE1BQUo7QUFBQSxRQUFZTyxPQUFPLEtBQW5CO0FBQ0EsT0FBRztBQUNELFVBQUksc0JBQU0xQyxPQUFPMkMsSUFBUCxFQUFOLENBQUosRUFBMEI7QUFDMUJELGFBQU8sT0FBT0gsS0FBUCxLQUFpQixVQUFqQixHQUE4QkEsT0FBOUIsR0FBd0N2QyxPQUFPMkMsSUFBUCxPQUFrQkosS0FBakU7QUFDQUosZUFBUyxLQUFLSixTQUFMLENBQWUvQixNQUFmLEVBQXVCd0MsT0FBdkIsRUFBZ0NDLFdBQWhDLENBQVQ7O0FBRUEsVUFBSU4sNkJBQUosRUFBMkI7QUFDekJLLGtCQUFVQSxRQUFRSSxJQUFSLENBQWFULE1BQWIsQ0FBVjtBQUNEO0FBQ0YsS0FSRCxRQVFRLENBQUNPLElBUlQ7QUFTQSxXQUFPRixPQUFQO0FBQ0Q7O0FBRURLLGtCQUFzQjtBQUNwQixTQUFLMUIsWUFBTCxDQUFrQk4sSUFBbEIsSUFBMEIsQ0FBMUI7QUFDQSxTQUFLTSxZQUFMLENBQWtCTCxNQUFsQixHQUEyQixDQUEzQjtBQUNEO0FBMUQ4Qjs7QUE2RGxCLFNBQVNmLElBQVQsQ0FBYytDLE1BQWQsRUFBMkM3QixPQUEzQyxFQUE0RTtBQUN6RixRQUFNakIsU0FBVSxPQUFPOEMsTUFBUCxLQUFrQixRQUFuQixHQUErQiwwQkFBZUEsTUFBZixDQUEvQixHQUF3REEsTUFBdkU7QUFDQSxNQUFJLHNCQUFNOUMsT0FBTzJDLElBQVAsRUFBTixDQUFKLEVBQTBCLE9BQU8sc0JBQVA7QUFDMUIsU0FBTyxJQUFJM0IsV0FBSixDQUFnQmhCLE1BQWhCLEVBQXdCaUIsT0FBeEIsRUFBaUNxQixTQUFqQyxDQUEyQyxJQUEzQyxFQUFpRHRDLE1BQWpELEVBQXlELHNCQUF6RCxFQUFpRSxLQUFqRSxDQUFQO0FBQ0QiLCJmaWxlIjoidG9rZW4tcmVhZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgQ2hhclN0cmVhbSwgaXNFT1MsIFJlYWRlciwgc2V0Q3VycmVudFJlYWR0YWJsZSB9IGZyb20gJ3JlYWR0YWJsZSc7XG5pbXBvcnQgZGVmYXVsdFJlYWR0YWJsZSBmcm9tICcuL2RlZmF1bHQtcmVhZHRhYmxlJztcbmltcG9ydCB7IExpc3QgfSBmcm9tICdpbW11dGFibGUnO1xuaW1wb3J0IHsgRW1wdHlUb2tlbiB9IGZyb20gJy4uL3Rva2Vucyc7XG5pbXBvcnQgU3ludGF4IGZyb20gJy4uL3N5bnRheCc7XG5cbmltcG9ydCB0eXBlIHsgU3RhcnRMb2NhdGlvbiwgU2xpY2UgfSBmcm9tICcuLi90b2tlbnMnO1xuXG5zZXRDdXJyZW50UmVhZHRhYmxlKGRlZmF1bHRSZWFkdGFibGUpO1xuXG5leHBvcnQgdHlwZSBMb2NhdGlvbkluZm8gPSB7XG4gIGxpbmU6IG51bWJlcixcbiAgY29sdW1uOiBudW1iZXJcbn07XG5cbnR5cGUgQ29udGV4dCA9IHtcbiAgYmluZGluZ3M6IGFueSxcbiAgc2NvcGVzZXRzOiBhbnlcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTbGljZShzdHJlYW06IENoYXJTdHJlYW0sIHN0YXJ0TG9jYXRpb246IFN0YXJ0TG9jYXRpb24pOiBTbGljZSB7XG4gIHJldHVybiB7XG4gICAgdGV4dDogc3RyZWFtLmdldFNsaWNlKHN0YXJ0TG9jYXRpb24ucG9zaXRpb24pLFxuICAgIHN0YXJ0OiBzdGFydExvY2F0aW9uLnBvc2l0aW9uLFxuICAgIHN0YXJ0TG9jYXRpb24sXG4gICAgZW5kOiBzdHJlYW0uc291cmNlSW5mby5wb3NpdGlvblxuICB9O1xufVxuXG5jb25zdCBzdHJlYW1zID0gbmV3IFdlYWtNYXAoKTtcblxuY2xhc3MgUmVhZEVycm9yIGV4dGVuZHMgRXJyb3Ige1xuICBpbmRleDogbnVtYmVyO1xuICBsaW5lOiBudW1iZXI7XG4gIGNvbHVtbjogbnVtYmVyO1xuICBtZXNzYWdlOiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKHsgaW5kZXgsIGxpbmUsIGNvbHVtbiwgbWVzc2FnZSB9OiB7IGluZGV4OiBudW1iZXIsIGxpbmU6IG51bWJlciwgY29sdW1uOiBudW1iZXIsIG1lc3NhZ2U6IHN0cmluZyB9KSB7XG4gICAgc3VwZXIobWVzc2FnZSk7XG4gICAgdGhpcy5pbmRleCA9IGluZGV4O1xuICAgIHRoaXMubGluZSA9IGxpbmU7XG4gICAgdGhpcy5jb2x1bW4gPSBjb2x1bW47XG4gICAgdGhpcy5tZXNzYWdlID0gYFske2xpbmV9OiR7Y29sdW1ufV0gJHttZXNzYWdlfWA7XG4gIH1cbn1cblxuY2xhc3MgVG9rZW5SZWFkZXIgZXh0ZW5kcyBSZWFkZXIge1xuICBsb2NhdGlvbkluZm86IExvY2F0aW9uSW5mbztcbiAgY29udGV4dDogP0NvbnRleHQ7XG4gIGNvbnN0cnVjdG9yKHN0cmVhbTogQ2hhclN0cmVhbSwgY29udGV4dD86IENvbnRleHQpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XG4gICAgc3RyZWFtcy5zZXQodGhpcywgc3RyZWFtKTtcbiAgICB0aGlzLmxvY2F0aW9uSW5mbyA9IHtcbiAgICAgIGxpbmU6IDEsXG4gICAgICBjb2x1bW46IDFcbiAgICB9O1xuICB9XG5cbiAgY3JlYXRlRXJyb3IobXNnOiBzdHJpbmcpOiBSZWFkRXJyb3Ige1xuICAgIGxldCBtZXNzYWdlID0gbXNnLnJlcGxhY2UoL1xceyhcXGQrKVxcfS9nLCAoXywgbikgPT4gSlNPTi5zdHJpbmdpZnkoYXJndW1lbnRzWytuICsgMV0pKTtcbiAgICAvLyAkRmxvd0ZpeE1lOiBkZWNpZGUgb24gaG93IHRvIGhhbmRsZSBwb3NzaWJsZSBudWxsYWJpbGl0eVxuICAgIHJldHVybiBuZXcgUmVhZEVycm9yKHsgbWVzc2FnZSwgaW5kZXg6IHN0cmVhbXMuZ2V0KHRoaXMpLnNvdXJjZUluZm8ucG9zaXRpb24sIGxpbmU6IHRoaXMubG9jYXRpb25JbmZvLmxpbmUsIGNvbHVtbjogdGhpcy5sb2NhdGlvbkluZm8uY29sdW1uIH0pO1xuICB9XG5cbiAgY3JlYXRlSUxMRUdBTChjaGFyKSB7XG4gICAgcmV0dXJuICFpc0VPUyhjaGFyKVxuICAgICAgPyB0aGlzLmNyZWF0ZUVycm9yKCdVbmV4cGVjdGVkIHswfScsIGNoYXIpXG4gICAgOiB0aGlzLmNyZWF0ZUVycm9yKCdVbmV4cGVjdGVkIGVuZCBvZiBpbnB1dCcpO1xuICB9XG5cbiAgcmVhZFRva2VuKHN0cmVhbTogQ2hhclN0cmVhbSwgLi4ucmVzdDogQXJyYXk8YW55Pik6IFN5bnRheCB7XG4gICAgY29uc3Qgc3RhcnRMb2NhdGlvbiA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMubG9jYXRpb25JbmZvLCBzdHJlYW0uc291cmNlSW5mbyk7XG4gICAgY29uc3QgcmVzdWx0ID0gc3VwZXIucmVhZChzdHJlYW0sIC4uLnJlc3QpO1xuXG5cbiAgICBpZiAoc3RhcnRMb2NhdGlvbi5jb2x1bW4gPT09IHRoaXMubG9jYXRpb25JbmZvLmNvbHVtbiAmJiBzdGFydExvY2F0aW9uLmxpbmUgPT09IHRoaXMubG9jYXRpb25JbmZvLmxpbmUpIHtcbiAgICAgIHRoaXMubG9jYXRpb25JbmZvLmNvbHVtbiArPSBzdHJlYW0uc291cmNlSW5mby5wb3NpdGlvbiAtIHN0YXJ0TG9jYXRpb24ucG9zaXRpb247XG4gICAgfVxuXG4gICAgaWYgKHJlc3VsdCA9PT0gRW1wdHlUb2tlbikgcmV0dXJuIHJlc3VsdDtcblxuICAgIGlmICghTGlzdC5pc0xpc3QocmVzdWx0KSkgcmVzdWx0LnNsaWNlID0gZ2V0U2xpY2Uoc3RyZWFtLCBzdGFydExvY2F0aW9uKTtcblxuICAgIHJldHVybiBuZXcgU3ludGF4KHJlc3VsdCwgdGhpcy5jb250ZXh0KTtcbiAgfVxuXG4gIHJlYWRVbnRpbChjbG9zZTogP0Z1bmN0aW9uIHwgP3N0cmluZywgc3RyZWFtOiBDaGFyU3RyZWFtLCByZXN1bHRzOiBMaXN0PFN5bnRheD4sIGV4cHJBbGxvd2VkOiBib29sZWFuKTogTGlzdDxTeW50YXg+IHtcbiAgICBsZXQgcmVzdWx0LCBkb25lID0gZmFsc2U7XG4gICAgZG8ge1xuICAgICAgaWYgKGlzRU9TKHN0cmVhbS5wZWVrKCkpKSBicmVhaztcbiAgICAgIGRvbmUgPSB0eXBlb2YgY2xvc2UgPT09ICdmdW5jdGlvbicgPyBjbG9zZSgpIDogc3RyZWFtLnBlZWsoKSA9PT0gY2xvc2U7XG4gICAgICByZXN1bHQgPSB0aGlzLnJlYWRUb2tlbihzdHJlYW0sIHJlc3VsdHMsIGV4cHJBbGxvd2VkKTtcblxuICAgICAgaWYgKHJlc3VsdCAhPT0gRW1wdHlUb2tlbikge1xuICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5wdXNoKHJlc3VsdCk7XG4gICAgICB9XG4gICAgfSB3aGlsZSghZG9uZSk7XG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICBpbmNyZW1lbnRMaW5lKCk6IHZvaWQge1xuICAgIHRoaXMubG9jYXRpb25JbmZvLmxpbmUgKz0gMTtcbiAgICB0aGlzLmxvY2F0aW9uSW5mby5jb2x1bW4gPSAxO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHJlYWQoc291cmNlOiBzdHJpbmcgfCBDaGFyU3RyZWFtLCBjb250ZXh0PzogQ29udGV4dCk6IExpc3Q8U3ludGF4PiB7XG4gIGNvbnN0IHN0cmVhbSA9ICh0eXBlb2Ygc291cmNlID09PSAnc3RyaW5nJykgPyBuZXcgQ2hhclN0cmVhbShzb3VyY2UpIDogc291cmNlO1xuICBpZiAoaXNFT1Moc3RyZWFtLnBlZWsoKSkpIHJldHVybiBMaXN0KCk7XG4gIHJldHVybiBuZXcgVG9rZW5SZWFkZXIoc3RyZWFtLCBjb250ZXh0KS5yZWFkVW50aWwobnVsbCwgc3RyZWFtLCBMaXN0KCksIGZhbHNlKTtcbn1cbiJdfQ==