'use strict';Object.defineProperty(exports,'__esModule',{value:!0}),exports.phaseInModulePathRegexp=void 0;var _tokenReader=require('./reader/token-reader'),_tokenReader2=_interopRequireDefault(_tokenReader),_scope=require('./scope'),_env=require('./env'),_env2=_interopRequireDefault(_env),_immutable=require('immutable'),_compiler=require('./compiler'),_compiler2=_interopRequireDefault(_compiler),_syntax=require('./syntax'),_bindingMap=require('./binding-map.js'),_bindingMap2=_interopRequireDefault(_bindingMap),_sweetSpec=require('sweet-spec'),_sweetSpec2=_interopRequireDefault(_sweetSpec),_sweetModule=require('./sweet-module'),_sweetModule2=_interopRequireDefault(_sweetModule),_ramda=require('ramda'),_=_interopRequireWildcard(_ramda),_scopeReducer=require('./scope-reducer'),_scopeReducer2=_interopRequireDefault(_scopeReducer),_macroContext=require('./macro-context'),_babelCore=require('babel-core'),_store=require('./store'),_store2=_interopRequireDefault(_store);function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&(b[d]=a[d]);return b.default=a,b}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}const phaseInModulePathRegexp=exports.phaseInModulePathRegexp=/(.*):(\d+)\s*$/;class SweetLoader{constructor(a,b=!1){this.sourceCache=new Map,this.compiledCache=new Map,this.baseDir=a;let d=new _bindingMap2.default,e=new Map,f=0;this.context={phase:0,bindings:d,templateMap:e,getTemplateIdentifier:()=>++f,loader:this,transform:g=>{return b?{code:g}:(0,_babelCore.transform)(g,{babelrc:!0})}}}normalize(a){return phaseInModulePathRegexp.test(a)?a:`${a}:0`}locate({name:a,metadata:b}){let d=a.match(phaseInModulePathRegexp);if(d&&3<=d.length)return{path:d[1],phase:parseInt(d[2],10)};throw new Error(`Module ${a} is missing phase information`)}fetch({name:a,address:b,metadata:d}){throw new Error('No default fetch defined')}translate({name:a,address:b,source:d,metadata:e}){let f=this.compiledCache.get(b.path);if(null!=f)return f;let g=this.compileSource(d);return this.compiledCache.set(b.path,g),g}instantiate({name:a,address:b,source:d,metadata:e}){throw new Error('Not implemented yet')}eval(a){return(0,eval)(a)}load(a){let b={},d=this.normalize(a),e=this.locate({name:d,metadata:b}),f=this.fetch({name:d,address:e,metadata:b});return f=this.translate({name:d,address:e,source:f,metadata:b}),this.instantiate({name:d,address:e,source:f,metadata:b})}compile(a,b){let d={},e=this.normalize(a,b),f=this.locate({name:e,metadata:d}),g=this.fetch({name:e,address:f,metadata:d});return this.translate({name:e,address:f,source:g,metadata:d})}get(a,b){return this.compile(`${a}:${b}`)}read(a){return(0,_macroContext.wrapInTerms)((0,_tokenReader2.default)(a))}freshStore(){return new _store2.default({})}compileSource(a){let b=this.read(a),d=(0,_scope.freshScope)('outsideEdge'),e=(0,_scope.freshScope)('insideEdge0'),f=new _compiler2.default(0,new _env2.default(),this.freshStore(),_.merge(this.context,{currentScope:[d,e]}));return new _sweetModule2.default(f.compile(b.map(g=>g.reduce(new _scopeReducer2.default([{scope:d,phase:_syntax.ALL_PHASES,flip:!1},{scope:e,phase:0,flip:!1}],this.context.bindings)))))}}exports.default=SweetLoader;

