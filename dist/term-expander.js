"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _immutable=require("immutable"),_terms=require("./terms"),_terms2=_interopRequireDefault(_terms),_scope=require("./scope"),_applyScopeInParamsReducer=require("./apply-scope-in-params-reducer"),_applyScopeInParamsReducer2=_interopRequireDefault(_applyScopeInParamsReducer),_compiler=require("./compiler"),_compiler2=_interopRequireDefault(_compiler),_syntax=require("./syntax"),_syntax2=_interopRequireDefault(_syntax),_serializer=require("./serializer"),_enforester=require("./enforester"),_templateProcessor=require("./template-processor.js"),_astDispatcher=require("./ast-dispatcher"),_astDispatcher2=_interopRequireDefault(_astDispatcher);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class TermExpander extends _astDispatcher2.default{constructor(a){super("expand",!0),this.context=a}expand(a){return this.dispatch(a)}expandPragma(a){return a}expandTemplateExpression(a){return new _terms2.default("TemplateExpression",{tag:null==a.tag?null:this.expand(a.tag),elements:a.elements.toArray()})}expandBreakStatement(a){return new _terms2.default("BreakStatement",{label:a.label?a.label.val():null})}expandDoWhileStatement(a){return new _terms2.default("DoWhileStatement",{body:this.expand(a.body),test:this.expand(a.test)})}expandWithStatement(a){return new _terms2.default("WithStatement",{body:this.expand(a.body),object:this.expand(a.object)})}expandDebuggerStatement(a){return a}expandContinueStatement(a){return new _terms2.default("ContinueStatement",{label:a.label?a.label.val():null})}expandSwitchStatementWithDefault(a){return new _terms2.default("SwitchStatementWithDefault",{discriminant:this.expand(a.discriminant),preDefaultCases:a.preDefaultCases.map(e=>this.expand(e)).toArray(),defaultCase:this.expand(a.defaultCase),postDefaultCases:a.postDefaultCases.map(e=>this.expand(e)).toArray()})}expandComputedMemberExpression(a){return new _terms2.default("ComputedMemberExpression",{object:this.expand(a.object),expression:this.expand(a.expression)})}expandSwitchStatement(a){return new _terms2.default("SwitchStatement",{discriminant:this.expand(a.discriminant),cases:a.cases.map(e=>this.expand(e)).toArray()})}expandFormalParameters(a){let e=null==a.rest?null:this.expand(a.rest);return new _terms2.default("FormalParameters",{items:a.items.map(f=>this.expand(f)),rest:e})}expandArrowExpression(a){return this.doFunctionExpansion(a,"ArrowExpression")}expandSwitchDefault(a){return new _terms2.default("SwitchDefault",{consequent:a.consequent.map(e=>this.expand(e)).toArray()})}expandSwitchCase(a){return new _terms2.default("SwitchCase",{test:this.expand(a.test),consequent:a.consequent.map(e=>this.expand(e)).toArray()})}expandForInStatement(a){return new _terms2.default("ForInStatement",{left:this.expand(a.left),right:this.expand(a.right),body:this.expand(a.body)})}expandTryCatchStatement(a){return new _terms2.default("TryCatchStatement",{body:this.expand(a.body),catchClause:this.expand(a.catchClause)})}expandTryFinallyStatement(a){let e=null==a.catchClause?null:this.expand(a.catchClause);return new _terms2.default("TryFinallyStatement",{body:this.expand(a.body),catchClause:e,finalizer:this.expand(a.finalizer)})}expandCatchClause(a){return new _terms2.default("CatchClause",{binding:this.expand(a.binding),body:this.expand(a.body)})}expandThrowStatement(a){return new _terms2.default("ThrowStatement",{expression:this.expand(a.expression)})}expandForOfStatement(a){return new _terms2.default("ForOfStatement",{left:this.expand(a.left),right:this.expand(a.right),body:this.expand(a.body)})}expandBindingIdentifier(a){return a}expandBindingPropertyIdentifier(a){return a}expandBindingPropertyProperty(a){return new _terms2.default("BindingPropertyProperty",{name:this.expand(a.name),binding:this.expand(a.binding)})}expandComputedPropertyName(a){return new _terms2.default("ComputedPropertyName",{expression:this.expand(a.expression)})}expandObjectBinding(a){return new _terms2.default("ObjectBinding",{properties:a.properties.map(e=>this.expand(e)).toArray()})}expandArrayBinding(a){let e=null==a.restElement?null:this.expand(a.restElement);return new _terms2.default("ArrayBinding",{elements:a.elements.map(f=>null==f?null:this.expand(f)).toArray(),restElement:e})}expandBindingWithDefault(a){return new _terms2.default("BindingWithDefault",{binding:this.expand(a.binding),init:this.expand(a.init)})}expandShorthandProperty(a){return new _terms2.default("DataProperty",{name:new _terms2.default("StaticPropertyName",{value:a.name}),expression:new _terms2.default("IdentifierExpression",{name:a.name})})}expandForStatement(a){let e=null==a.init?null:this.expand(a.init),f=null==a.test?null:this.expand(a.test),g=null==a.update?null:this.expand(a.update),h=this.expand(a.body);return new _terms2.default("ForStatement",{init:e,test:f,update:g,body:h})}expandYieldExpression(a){let e=null==a.expression?null:this.expand(a.expression);return new _terms2.default("YieldExpression",{expression:e})}expandYieldGeneratorExpression(a){let e=null==a.expression?null:this.expand(a.expression);return new _terms2.default("YieldGeneratorExpression",{expression:e})}expandWhileStatement(a){return new _terms2.default("WhileStatement",{test:this.expand(a.test),body:this.expand(a.body)})}expandIfStatement(a){let e=null==a.consequent?null:this.expand(a.consequent),f=null==a.alternate?null:this.expand(a.alternate);return new _terms2.default("IfStatement",{test:this.expand(a.test),consequent:e,alternate:f})}expandBlockStatement(a){return new _terms2.default("BlockStatement",{block:this.expand(a.block)})}expandBlock(a){let e=(0,_scope.freshScope)("block");this.context.currentScope.push(e);let g,h,f=new _compiler2.default(this.context.phase,this.context.env,this.context.store,this.context);return g=a.statements.map(j=>j.addScope(e,this.context.bindings,_syntax.ALL_PHASES)),h=new _terms2.default("Block",{statements:f.compile(g)}),this.context.currentScope.pop(),h}expandVariableDeclarationStatement(a){return new _terms2.default("VariableDeclarationStatement",{declaration:this.expand(a.declaration)})}expandReturnStatement(a){return null==a.expression?a:new _terms2.default("ReturnStatement",{expression:this.expand(a.expression)})}expandClassDeclaration(a){return new _terms2.default("ClassDeclaration",{name:null==a.name?null:this.expand(a.name),super:null==a.super?null:this.expand(a.super),elements:a.elements.map(e=>this.expand(e)).toArray()})}expandClassExpression(a){return new _terms2.default("ClassExpression",{name:null==a.name?null:this.expand(a.name),super:null==a.super?null:this.expand(a.super),elements:a.elements.map(e=>this.expand(e)).toArray()})}expandClassElement(a){return new _terms2.default("ClassElement",{isStatic:a.isStatic,method:this.expand(a.method)})}expandThisExpression(a){return a}expandSyntaxTemplate(a){let e=(0,_templateProcessor.processTemplate)(a.template.inner()),f=_syntax2.default.from("string",_serializer.serializer.write(e.template)),g=new _terms2.default("IdentifierExpression",{name:_syntax2.default.from("identifier","syntaxTemplate")}),h=e.interp.map(k=>{let l=new _enforester.Enforester(k,(0,_immutable.List)(),this.context);return this.expand(l.enforest("expression"))}),j=_immutable.List.of(new _terms2.default("LiteralStringExpression",{value:f})).concat(h);return new _terms2.default("CallExpression",{callee:g,arguments:j})}expandSyntaxQuote(a){let e=new _terms2.default("LiteralStringExpression",{value:_syntax2.default.from("string",_serializer.serializer.write(a.name))});return new _terms2.default("TemplateExpression",{tag:a.template.tag,elements:a.template.elements.push(e).push(new _terms2.default("TemplateElement",{rawValue:""})).toArray()})}expandStaticMemberExpression(a){return new _terms2.default("StaticMemberExpression",{object:this.expand(a.object),property:a.property})}expandArrayExpression(a){return new _terms2.default("ArrayExpression",{elements:a.elements.map(e=>null==e?e:this.expand(e))})}expandImport(a){return a}expandImportNamespace(a){return a}expandExport(a){return new _terms2.default("Export",{declaration:this.expand(a.declaration)})}expandExportDefault(a){return new _terms2.default("ExportDefault",{body:this.expand(a.body)})}expandExportFrom(a){return a}expandExportAllFrom(a){return a}expandExportSpecifier(a){return a}expandStaticPropertyName(a){return a}expandDataProperty(a){return new _terms2.default("DataProperty",{name:this.expand(a.name),expression:this.expand(a.expression)})}expandObjectExpression(a){return new _terms2.default("ObjectExpression",{properties:a.properties.map(e=>this.expand(e))})}expandVariableDeclarator(a){let e=null==a.init?null:this.expand(a.init);return new _terms2.default("VariableDeclarator",{binding:this.expand(a.binding),init:e})}expandVariableDeclaration(a){return"syntax"===a.kind||"syntaxrec"===a.kind?a:new _terms2.default("VariableDeclaration",{kind:a.kind,declarators:a.declarators.map(e=>this.expand(e))})}expandParenthesizedExpression(a){if(0===a.inner.size)throw new Error("unexpected end of input");let e=new _enforester.Enforester(a.inner,(0,_immutable.List)(),this.context),f=e.peek(),g=e.enforestExpression();if(null==g||0<e.rest.size)throw e.createError(f,"unexpected syntax");return this.expand(g)}expandUnaryExpression(a){return new _terms2.default("UnaryExpression",{operator:a.operator,operand:this.expand(a.operand)})}expandUpdateExpression(a){return new _terms2.default("UpdateExpression",{isPrefix:a.isPrefix,operator:a.operator,operand:this.expand(a.operand)})}expandBinaryExpression(a){let e=this.expand(a.left),f=this.expand(a.right);return new _terms2.default("BinaryExpression",{left:e,operator:a.operator,right:f})}expandConditionalExpression(a){return new _terms2.default("ConditionalExpression",{test:this.expand(a.test),consequent:this.expand(a.consequent),alternate:this.expand(a.alternate)})}expandNewTargetExpression(a){return a}expandNewExpression(a){let e=this.expand(a.callee),f=new _enforester.Enforester(a.arguments,(0,_immutable.List)(),this.context),g=f.enforestArgumentList().map(h=>this.expand(h));return new _terms2.default("NewExpression",{callee:e,arguments:g.toArray()})}expandSuper(a){return a}expandCallExpression(a){let e=this.expand(a.callee),f=new _enforester.Enforester(a.arguments,(0,_immutable.List)(),this.context),g=f.enforestArgumentList().map(h=>this.expand(h));return new _terms2.default("CallExpression",{callee:e,arguments:g})}expandSpreadElement(a){return new _terms2.default("SpreadElement",{expression:this.expand(a.expression)})}expandExpressionStatement(a){let e=this.expand(a.expression);return new _terms2.default("ExpressionStatement",{expression:e})}expandLabeledStatement(a){return new _terms2.default("LabeledStatement",{label:a.label.val(),body:this.expand(a.body)})}doFunctionExpansion(a,e){let h,f=(0,_scope.freshScope)("fun"),g=new _applyScopeInParamsReducer2.default(f,this.context);"Getter"!==e&&"Setter"!==e&&(h=g.transform(a.params),h=this.expand(h)),this.context.currentScope.push(f);let k,l,j=new _compiler2.default(this.context.phase,this.context.env,this.context.store,this.context);return(a.body instanceof _terms2.default?l=this.expand(a.body.addScope(f,this.context.bindings,_syntax.ALL_PHASES)):(k=a.body.map(m=>m.addScope(f,this.context.bindings,_syntax.ALL_PHASES)),l=new _terms2.default("FunctionBody",{directives:(0,_immutable.List)(),statements:j.compile(k)})),this.context.currentScope.pop(),"Getter"===e)?new _terms2.default(e,{name:this.expand(a.name),body:l}):"Setter"===e?new _terms2.default(e,{name:this.expand(a.name),param:a.param,body:l}):"ArrowExpression"===e?new _terms2.default(e,{params:h,body:l}):new _terms2.default(e,{name:a.name,isGenerator:a.isGenerator,params:h,body:l})}expandMethod(a){return this.doFunctionExpansion(a,"Method")}expandSetter(a){return this.doFunctionExpansion(a,"Setter")}expandGetter(a){return this.doFunctionExpansion(a,"Getter")}expandFunctionDeclaration(a){return this.doFunctionExpansion(a,"FunctionDeclaration")}expandFunctionExpression(a){return this.doFunctionExpansion(a,"FunctionExpression")}expandCompoundAssignmentExpression(a){return new _terms2.default("CompoundAssignmentExpression",{binding:this.expand(a.binding),operator:a.operator,expression:this.expand(a.expression)})}expandAssignmentExpression(a){return new _terms2.default("AssignmentExpression",{binding:this.expand(a.binding),expression:this.expand(a.expression)})}expandEmptyStatement(a){return a}expandLiteralBooleanExpression(a){return a}expandLiteralNumericExpression(a){return a}expandLiteralInfinityExpression(a){return a}expandIdentifierExpression(a){let e=this.context.env.get(a.name.resolve(this.context.phase));return e?new _terms2.default("IdentifierExpression",{name:e.id}):a}expandLiteralNullExpression(a){return a}expandLiteralStringExpression(a){return a}expandLiteralRegExpExpression(a){return a}}exports.default=TermExpander;

