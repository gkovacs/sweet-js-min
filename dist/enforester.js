'use strict';Object.defineProperty(exports,'__esModule',{value:!0}),exports.Enforester=void 0;var _terms=require('./terms'),_sweetSpec=require('sweet-spec'),T=_interopRequireWildcard(_sweetSpec),_ramdaFantasy=require('ramda-fantasy'),_scopeReducer=require('./scope-reducer'),_scopeReducer2=_interopRequireDefault(_scopeReducer),_transforms=require('./transforms'),_immutable=require('immutable'),_errors=require('./errors'),_operators=require('./operators'),_syntax=require('./syntax'),_syntax2=_interopRequireDefault(_syntax),_scope=require('./scope'),_loadSyntax=require('./load-syntax'),_macroContext=require('./macro-context'),_macroContext2=_interopRequireDefault(_macroContext);function _interopRequireDefault(c){return c&&c.__esModule?c:{default:c}}function _interopRequireWildcard(c){if(c&&c.__esModule)return c;var d={};if(null!=c)for(var e in c)Object.prototype.hasOwnProperty.call(c,e)&&(d[e]=c[e]);return d.default=c,d}const Just=_ramdaFantasy.Maybe.Just,Nothing=_ramdaFantasy.Maybe.Nothing,EXPR_LOOP_OPERATOR={},EXPR_LOOP_NO_CHANGE={},EXPR_LOOP_EXPANSION={};function getLineNumber(c){let d;if(c instanceof _syntax2.default)d=c;else if(c instanceof T.RawSyntax)d=c.value;else{if(c instanceof T.RawDelimiter)return getLineNumber(c.inner.first());throw new Error(`Not implemented yet ${c}`)}return d.lineNumber()}class Enforester{constructor(c,d,e){this.done=!1,(0,_errors.assert)(_immutable.List.isList(c),'expecting a list of terms to enforest'),(0,_errors.assert)(_immutable.List.isList(d),'expecting a list of terms to enforest'),(0,_errors.assert)(e,'expecting a context to enforest'),this.term=null,this.rest=c,this.prev=d,this.context=e}peek(c=0){return this.rest.get(c)}advance(){let c=this.rest.first();return this.rest=this.rest.rest(),c}enforest(c='Module'){if(this.term=null,0===this.rest.size)return this.done=!0,this.term;if(this.isEOF(this.peek()))return this.term=new T.EOF({}),this.advance(),this.term;let d;return d='expression'===c?this.enforestExpressionLoop():this.enforestModule(),0===this.rest.size&&(this.done=!0),d}enforestModule(){return this.enforestBody()}enforestBody(){return this.enforestModuleItem()}enforestModuleItem(){let c=this.peek();return this.isKeyword(c,'import')?(this.advance(),this.enforestImportDeclaration()):this.isKeyword(c,'export')?(this.advance(),this.enforestExportDeclaration()):this.enforestStatement()}enforestExportDeclaration(){let c=this.peek();if(this.isPunctuator(c,'*')){this.advance();let d=this.enforestFromClause();return new T.ExportAllFrom({moduleSpecifier:d})}if(this.isBraces(c)){let d=this.enforestExportClause(),e=null;return this.isIdentifier(this.peek(),'from')&&(e=this.enforestFromClause()),new T.ExportFrom({namedExports:d,moduleSpecifier:e})}if(this.isKeyword(c,'class'))return new T.Export({declaration:this.enforestClass({isExpr:!1})});if(this.isFnDeclTransform(c))return new T.Export({declaration:this.enforestFunction({isExpr:!1})});if(this.isKeyword(c,'default')){if(this.advance(),this.isFnDeclTransform(this.peek()))return new T.ExportDefault({body:this.enforestFunction({isExpr:!1,inDefault:!0})});if(this.isKeyword(this.peek(),'class'))return new T.ExportDefault({body:this.enforestClass({isExpr:!1,inDefault:!0})});let d=this.enforestExpressionLoop();return this.consumeSemicolon(),new T.ExportDefault({body:d})}if(this.isVarDeclTransform(c)||this.isLetDeclTransform(c)||this.isConstDeclTransform(c)||this.isSyntaxrecDeclTransform(c)||this.isSyntaxDeclTransform(c))return new T.Export({declaration:this.enforestVariableDeclaration()});throw this.createError(c,'unexpected syntax')}enforestExportClause(){let c=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context),d=[];for(;0!==c.rest.size;)d.push(c.enforestExportSpecifier()),c.consumeComma();return(0,_immutable.List)(d)}enforestExportSpecifier(){let c=this.enforestIdentifier();if(this.isIdentifier(this.peek(),'as')){this.advance();let d=this.enforestIdentifier();return new T.ExportSpecifier({name:c,exportedName:d})}return new T.ExportSpecifier({name:null,exportedName:c})}enforestImportDeclaration(){let c=this.peek(),d=null,e=(0,_immutable.List)(),f=!1;if(this.isStringLiteral(c)){let g=this.advance();return this.consumeSemicolon(),new T.Import({defaultBinding:d,namedImports:e,moduleSpecifier:g,forSyntax:f})}if((this.isIdentifier(c)||this.isKeyword(c))&&(d=this.enforestBindingIdentifier(),!this.isPunctuator(this.peek(),','))){let g=this.enforestFromClause();return this.isKeyword(this.peek(),'for')&&this.isIdentifier(this.peek(1),'syntax')&&(this.advance(),this.advance(),f=!0),new T.Import({defaultBinding:d,moduleSpecifier:g,namedImports:(0,_immutable.List)(),forSyntax:f})}if(this.consumeComma(),c=this.peek(),this.isBraces(c)){let g=this.enforestNamedImports(),h=this.enforestFromClause();return this.isKeyword(this.peek(),'for')&&this.isIdentifier(this.peek(1),'syntax')&&(this.advance(),this.advance(),f=!0),new T.Import({defaultBinding:d,forSyntax:f,namedImports:g,moduleSpecifier:h})}if(this.isPunctuator(c,'*')){let g=this.enforestNamespaceBinding(),h=this.enforestFromClause();return this.isKeyword(this.peek(),'for')&&this.isIdentifier(this.peek(1),'syntax')&&(this.advance(),this.advance(),f=!0),new T.ImportNamespace({defaultBinding:d,forSyntax:f,namespaceBinding:g,moduleSpecifier:h})}throw this.createError(c,'unexpected syntax')}enforestNamespaceBinding(){return this.matchPunctuator('*'),this.matchIdentifier('as'),this.enforestBindingIdentifier()}enforestNamedImports(){let c=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context),d=[];for(;0!==c.rest.size;)d.push(c.enforestImportSpecifiers()),c.consumeComma();return(0,_immutable.List)(d)}enforestImportSpecifiers(){let c=this.peek(),d;if(this.isIdentifier(c)||this.isKeyword(c)){if(d=this.matchRawSyntax(),!this.isIdentifier(this.peek(),'as'))return new T.ImportSpecifier({name:null,binding:new T.BindingIdentifier({name:d})});this.matchIdentifier('as')}else throw this.createError(c,'unexpected token in import specifier');return new T.ImportSpecifier({name:d,binding:this.enforestBindingIdentifier()})}enforestFromClause(){this.matchIdentifier('from');let c=this.matchStringLiteral();return this.consumeSemicolon(),c}enforestStatementListItem(){let c=this.peek();return this.isFnDeclTransform(c)?this.enforestFunction({isExpr:!1}):this.isKeyword(c,'class')?this.enforestClass({isExpr:!1}):this.enforestStatement()}enforestStatement(){let c=this.peek();if(null===this.term&&this.isCompiletimeTransform(c)&&(this.expandMacro(),c=this.peek()),null===this.term&&this.isTerm(c)&&c instanceof T.Statement)return this.advance();if(null===this.term&&this.isBraces(c))return this.enforestBlockStatement();if(null===this.term&&this.isWhileTransform(c))return this.enforestWhileStatement();if(null===this.term&&this.isIfTransform(c))return this.enforestIfStatement();if(null===this.term&&this.isForTransform(c))return this.enforestForStatement();if(null===this.term&&this.isSwitchTransform(c))return this.enforestSwitchStatement();if(null===this.term&&this.isBreakTransform(c))return this.enforestBreakStatement();if(null===this.term&&this.isContinueTransform(c))return this.enforestContinueStatement();if(null===this.term&&this.isDoTransform(c))return this.enforestDoStatement();if(null===this.term&&this.isDebuggerTransform(c))return this.enforestDebuggerStatement();if(null===this.term&&this.isWithTransform(c))return this.enforestWithStatement();if(null===this.term&&this.isTryTransform(c))return this.enforestTryStatement();if(null===this.term&&this.isThrowTransform(c))return this.enforestThrowStatement();if(null===this.term&&this.isKeyword(c,'class'))return this.enforestClass({isExpr:!1});if(null===this.term&&this.isFnDeclTransform(c))return this.enforestFunction({isExpr:!1});if(null===this.term&&this.isIdentifier(c)&&this.isPunctuator(this.peek(1),':'))return this.enforestLabeledStatement();if(null===this.term&&(this.isVarDeclTransform(c)||this.isLetDeclTransform(c)||this.isConstDeclTransform(c)||this.isSyntaxrecDeclTransform(c)||this.isSyntaxDeclTransform(c))){let d=new T.VariableDeclarationStatement({declaration:this.enforestVariableDeclaration()});return this.consumeSemicolon(),d}return null===this.term&&this.isReturnStmtTransform(c)?this.enforestReturnStatement():null===this.term&&this.isPunctuator(c,';')?(this.advance(),new T.EmptyStatement({})):this.enforestExpressionStatement()}enforestLabeledStatement(){let c=this.matchIdentifier();this.matchPunctuator(':');let d=this.enforestStatement();return new T.LabeledStatement({label:c,body:d})}enforestBreakStatement(){this.matchKeyword('break');let c=this.peek(),d=null;return 0===this.rest.size||this.isPunctuator(c,';')?(this.consumeSemicolon(),new T.BreakStatement({label:d})):((this.isIdentifier(c)||this.isKeyword(c,'yield')||this.isKeyword(c,'let'))&&(d=this.enforestIdentifier()),this.consumeSemicolon(),new T.BreakStatement({label:d}))}enforestTryStatement(){this.matchKeyword('try');let c=this.enforestBlock();if(this.isKeyword(this.peek(),'catch')){let d=this.enforestCatchClause();if(this.isKeyword(this.peek(),'finally')){this.advance();let e=this.enforestBlock();return new T.TryFinallyStatement({body:c,catchClause:d,finalizer:e})}return new T.TryCatchStatement({body:c,catchClause:d})}if(this.isKeyword(this.peek(),'finally')){this.advance();let d=this.enforestBlock();return new T.TryFinallyStatement({body:c,catchClause:null,finalizer:d})}throw this.createError(this.peek(),'try with no catch or finally')}enforestCatchClause(){this.matchKeyword('catch');let c=this.matchParens(),d=new Enforester(c,(0,_immutable.List)(),this.context),e=d.enforestBindingTarget(),f=this.enforestBlock();return new T.CatchClause({binding:e,body:f})}enforestThrowStatement(){this.matchKeyword('throw');let c=this.enforestExpression();return this.consumeSemicolon(),new T.ThrowStatement({expression:c})}enforestWithStatement(){this.matchKeyword('with');let c=this.matchParens(),d=new Enforester(c,(0,_immutable.List)(),this.context),e=d.enforestExpression(),f=this.enforestStatement();return new T.WithStatement({object:e,body:f})}enforestDebuggerStatement(){return this.matchKeyword('debugger'),new T.DebuggerStatement({})}enforestDoStatement(){this.matchKeyword('do');let c=this.enforestStatement();this.matchKeyword('while');let d=this.matchParens(),e=new Enforester(d,(0,_immutable.List)(),this.context),f=e.enforestExpression();return this.consumeSemicolon(),new T.DoWhileStatement({body:c,test:f})}enforestContinueStatement(){let c=this.matchKeyword('continue'),d=this.peek(),e=null;return 0===this.rest.size||this.isPunctuator(d,';')?(this.consumeSemicolon(),new T.ContinueStatement({label:e})):(d instanceof T.RawSyntax&&this.lineNumberEq(c,d)&&(this.isIdentifier(d)||this.isKeyword(d,'yield')||this.isKeyword(d,'let'))&&(e=this.enforestIdentifier()),this.consumeSemicolon(),new T.ContinueStatement({label:e}))}enforestSwitchStatement(){this.matchKeyword('switch');let c=this.matchParens(),d=new Enforester(c,(0,_immutable.List)(),this.context),e=d.enforestExpression(),f=this.matchCurlies();if(0===f.size)return new T.SwitchStatement({discriminant:e,cases:(0,_immutable.List)()});d=new Enforester(f,(0,_immutable.List)(),this.context);let g=d.enforestSwitchCases(),h=d.peek();if(d.isKeyword(h,'default')){let i=d.enforestSwitchDefault(),j=d.enforestSwitchCases();return new T.SwitchStatementWithDefault({discriminant:e,preDefaultCases:g,defaultCase:i,postDefaultCases:j})}return new T.SwitchStatement({discriminant:e,cases:g})}enforestSwitchCases(){let c=[];for(;!(0===this.rest.size||this.isKeyword(this.peek(),'default'));)c.push(this.enforestSwitchCase());return(0,_immutable.List)(c)}enforestSwitchCase(){return this.matchKeyword('case'),new T.SwitchCase({test:this.enforestExpression(),consequent:this.enforestSwitchCaseBody()})}enforestSwitchCaseBody(){return this.matchPunctuator(':'),this.enforestStatementListInSwitchCaseBody()}enforestStatementListInSwitchCaseBody(){let c=[];for(;!(0===this.rest.size||this.isKeyword(this.peek(),'default')||this.isKeyword(this.peek(),'case'));)c.push(this.enforestStatementListItem());return(0,_immutable.List)(c)}enforestSwitchDefault(){return this.matchKeyword('default'),new T.SwitchDefault({consequent:this.enforestSwitchCaseBody()})}enforestForStatement(){this.matchKeyword('for');let c=this.matchParens(),d=new Enforester(c,(0,_immutable.List)(),this.context),e,f,g,h,i,j,k;if(d.isPunctuator(d.peek(),';'))return d.advance(),d.isPunctuator(d.peek(),';')||(f=d.enforestExpression()),d.matchPunctuator(';'),0!==d.rest.size&&(h=d.enforestExpression()),new T.ForStatement({init:null,test:f,update:h,body:this.enforestStatement()});if(e=d.peek(),d.isVarDeclTransform(e)||d.isLetDeclTransform(e)||d.isConstDeclTransform(e)){if(g=d.enforestVariableDeclaration(),e=d.peek(),this.isKeyword(e,'in')||this.isIdentifier(e,'of'))return this.isKeyword(e,'in')?(d.advance(),h=d.enforestExpression(),k=T.ForInStatement):((0,_errors.assert)(this.isIdentifier(e,'of'),'expecting `of` keyword'),d.advance(),h=d.enforestExpression(),k=T.ForOfStatement),new k({left:g,right:h,body:this.enforestStatement()});d.matchPunctuator(';'),d.isPunctuator(d.peek(),';')?(d.advance(),f=null):(f=d.enforestExpression(),d.matchPunctuator(';')),j=d.enforestExpression()}else{if(this.isKeyword(d.peek(1),'in')||this.isIdentifier(d.peek(1),'of')){i=d.enforestBindingIdentifier();let l=d.advance();return k=this.isKeyword(l,'in')?T.ForInStatement:T.ForOfStatement,h=d.enforestExpression(),new k({left:i,right:h,body:this.enforestStatement()})}g=d.enforestExpression(),d.matchPunctuator(';'),d.isPunctuator(d.peek(),';')?(d.advance(),f=null):(f=d.enforestExpression(),d.matchPunctuator(';')),j=d.enforestExpression()}return new T.ForStatement({init:g,test:f,update:j,body:this.enforestStatement()})}enforestIfStatement(){this.matchKeyword('if');let c=this.matchParens(),d=new Enforester(c,(0,_immutable.List)(),this.context),e=d.peek(),f=d.enforestExpression();if(null===f)throw d.createError(e,'expecting an expression');let g=this.enforestStatement(),h=null;return this.isKeyword(this.peek(),'else')&&(this.advance(),h=this.enforestStatement()),new T.IfStatement({test:f,consequent:g,alternate:h})}enforestWhileStatement(){this.matchKeyword('while');let c=this.matchParens(),d=new Enforester(c,(0,_immutable.List)(),this.context),e=d.peek(),f=d.enforestExpression();if(null===f)throw d.createError(e,'expecting an expression');let g=this.enforestStatement();return new T.WhileStatement({test:f,body:g})}enforestBlockStatement(){return new T.BlockStatement({block:this.enforestBlock()})}enforestBlock(){return new T.Block({statements:this.matchCurlies()})}enforestClass({isExpr:c=!1,inDefault:d=!1}){let e=this.matchRawSyntax(),f=null,g=null;if(this.isIdentifier(this.peek()))f=this.enforestBindingIdentifier();else if(!c)if(d)f=new T.BindingIdentifier({name:_syntax2.default.fromIdentifier('_default',e)});else throw this.createError(this.peek(),'unexpected syntax');this.isKeyword(this.peek(),'extends')&&(this.advance(),g=this.enforestExpressionLoop());let h=[],i=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context);for(;0!==i.rest.size;){if(i.isPunctuator(i.peek(),';')){i.advance();continue}let j=!1,{methodOrKey:k,kind:l}=i.enforestMethodDefinition();if('identifier'===l&&'static'===k.value.val()&&(j=!0,({methodOrKey:k,kind:l}=i.enforestMethodDefinition())),'method'===l)h.push(new T.ClassElement({isStatic:j,method:k}));else throw this.createError(i.peek(),'Only methods are allowed in classes')}return new(c?T.ClassExpression:T.ClassDeclaration)({name:f,super:g,elements:(0,_immutable.List)(h)})}enforestBindingTarget({allowPunctuator:c=!1}={}){let d=this.peek();if(this.isIdentifier(d)||this.isKeyword(d)||c&&this.isPunctuator(d))return this.enforestBindingIdentifier({allowPunctuator:c});return this.isBrackets(d)?this.enforestArrayBinding():this.isBraces(d)?this.enforestObjectBinding():void(0,_errors.assert)(!1,'not implemented yet')}enforestObjectBinding(){let c=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context),d=[];for(;0!==c.rest.size;)d.push(c.enforestBindingProperty()),c.consumeComma();return new T.ObjectBinding({properties:(0,_immutable.List)(d)})}enforestBindingProperty(){let c=this.peek(),{name:d,binding:e}=this.enforestPropertyName();if((this.isIdentifier(c)||this.isKeyword(c,'let')||this.isKeyword(c,'yield'))&&!this.isPunctuator(this.peek(),':')){let f=null;if(this.isAssign(this.peek())){this.advance();let g=this.enforestExpressionLoop();f=g}return new T.BindingPropertyIdentifier({binding:e,init:f})}return this.matchPunctuator(':'),e=this.enforestBindingElement(),new T.BindingPropertyProperty({name:d,binding:e})}enforestArrayBinding(){let c=this.matchSquares(),d=new Enforester(c,(0,_immutable.List)(),this.context),e=[],f=null;for(;0!==d.rest.size;){let g;if(d.isPunctuator(d.peek(),','))d.consumeComma(),g=null;else{if(d.isPunctuator(d.peek(),'...')){d.advance(),f=d.enforestBindingTarget();break}else g=d.enforestBindingElement();d.consumeComma()}e.push(g)}return new T.ArrayBinding({elements:(0,_immutable.List)(e),restElement:f})}enforestBindingElement(){let c=this.enforestBindingTarget();if(this.isAssign(this.peek())){this.advance();let d=this.enforestExpressionLoop();c=new T.BindingWithDefault({binding:c,init:d})}return c}enforestBindingIdentifier({allowPunctuator:c}={}){let d;return d=c&&this.isPunctuator(this.peek())?this.enforestPunctuator():this.enforestIdentifier(),new T.BindingIdentifier({name:d})}enforestPunctuator(){let c=this.peek();if(this.isPunctuator(c))return this.matchRawSyntax();throw this.createError(c,'expecting a punctuator')}enforestIdentifier(){let c=this.peek();if(this.isIdentifier(c)||this.isKeyword(c))return this.matchRawSyntax();throw this.createError(c,'expecting an identifier')}enforestReturnStatement(){let c=this.matchRawSyntax(),d=this.peek();if(0===this.rest.size||d&&!this.lineNumberEq(c,d))return new T.ReturnStatement({expression:null});let e=null;return this.isPunctuator(d,';')||(e=this.enforestExpression(),(0,_errors.expect)(null!=e,'Expecting an expression to follow return keyword',d,this.rest)),this.consumeSemicolon(),new T.ReturnStatement({expression:e})}enforestVariableDeclaration(){let c,d=this.matchRawSyntax(),e=d,f=this.context.phase;e&&this.context.env.get(e.resolve(f))===_transforms.VariableDeclTransform?c='var':e&&this.context.env.get(e.resolve(f))===_transforms.LetDeclTransform?c='let':e&&this.context.env.get(e.resolve(f))===_transforms.ConstDeclTransform?c='const':e&&this.context.env.get(e.resolve(f))===_transforms.SyntaxDeclTransform?c='syntax':e&&this.context.env.get(e.resolve(f))===_transforms.SyntaxrecDeclTransform&&(c='syntaxrec');let g=(0,_immutable.List)();for(;;){let h=this.enforestVariableDeclarator({isSyntax:'syntax'===c||'syntaxrec'===c}),i=this.peek();if(g=g.concat(h),this.isPunctuator(i,','))this.advance();else break}return new T.VariableDeclaration({kind:c,declarators:g})}enforestVariableDeclarator({isSyntax:c}){let d=this.enforestBindingTarget({allowPunctuator:c}),e=this.peek(),f;if(this.isPunctuator(e,'=')){this.advance();let g=new Enforester(this.rest,(0,_immutable.List)(),this.context);f=g.enforest('expression'),this.rest=g.rest}else f=null;return new T.VariableDeclarator({binding:d,init:f})}enforestExpressionStatement(){let c=this.rest.get(0),d=this.enforestExpression();if(null===d)throw this.createError(c,'not a valid expression');return this.consumeSemicolon(),new T.ExpressionStatement({expression:d})}enforestExpression(){let c=this.enforestExpressionLoop(),d=this.peek();if(this.isPunctuator(d,','))for(;0!==this.rest.size&&!!this.isPunctuator(this.peek(),',');){let e=this.matchRawSyntax(),f=this.enforestExpressionLoop();c=new T.BinaryExpression({left:c,operator:e.val(),right:f})}return this.term=null,c}enforestExpressionLoop(){this.term=null,this.opCtx={prec:0,combine:c=>c,stack:(0,_immutable.List)()};do{let c=this.enforestAssignmentExpression();if(c===EXPR_LOOP_NO_CHANGE&&0<this.opCtx.stack.size){this.term=this.opCtx.combine(this.term);let{prec:d,combine:e}=this.opCtx.stack.last();this.opCtx.prec=d,this.opCtx.combine=e,this.opCtx.stack=this.opCtx.stack.pop()}else if(c===EXPR_LOOP_NO_CHANGE)break;else this.term=c===EXPR_LOOP_OPERATOR||c===EXPR_LOOP_EXPANSION?null:c}while(!0);return this.term}enforestAssignmentExpression(){let c=this.peek();if(null===this.term&&this.isModuleNamespaceTransform(c)){let d=this.getFromCompiletimeEnvironment(this.advance().value);this.matchPunctuator('.');let e=this.matchIdentifier(),f=d.mod.exportedNames.find(g=>g.exportedName.val()===e.val());this.rest=this.rest.unshift(new T.RawSyntax({value:_syntax2.default.fromIdentifier(e.val(),f.exportedName)})),c=this.peek()}if(null===this.term&&this.isCompiletimeTransform(c)&&(this.expandMacro(),c=this.peek()),null===this.term&&this.isTerm(c)&&c instanceof T.Expression)return this.advance();if(null===this.term&&this.isKeyword(c,'yield'))return this.enforestYieldExpression();if(null===this.term&&this.isKeyword(c,'class'))return this.enforestClass({isExpr:!0});if(null===this.term&&c&&(this.isIdentifier(c)||this.isParens(c))&&this.isPunctuator(this.peek(1),'=>')&&this.lineNumberEq(c,this.peek(1)))return this.enforestArrowExpression();if(null===this.term&&this.isSyntaxTemplate(c))return this.enforestSyntaxTemplate();if(null===this.term&&this.isParens(c))return new T.ParenthesizedExpression({inner:this.matchParens()});if(null===this.term&&(this.isKeyword(c,'this')||this.isIdentifier(c)||this.isKeyword(c,'let')||this.isKeyword(c,'yield')||this.isNumericLiteral(c)||this.isStringLiteral(c)||this.isTemplate(c)||this.isBooleanLiteral(c)||this.isNullLiteral(c)||this.isRegularExpression(c)||this.isFnDeclTransform(c)||this.isBraces(c)||this.isBrackets(c)))return this.enforestPrimaryExpression();if(null===this.term&&this.isOperator(c))return this.enforestUnaryExpression();if(null===this.term&&this.isVarBindingTransform(c)&&c instanceof T.RawSyntax){let d=c.value,e=this.getFromCompiletimeEnvironment(d).id;if(e!==d)return this.advance(),this.rest=_immutable.List.of(e).concat(this.rest),EXPR_LOOP_EXPANSION}if(null===this.term&&(this.isNewTransform(c)||this.isKeyword(c,'super'))||this.term&&(this.isPunctuator(c,'.')&&(this.isIdentifier(this.peek(1))||this.isKeyword(this.peek(1)))||this.isBrackets(c)||this.isParens(c)))return this.enforestLeftHandSideExpression({allowCall:!0});if(this.term&&this.isTemplate(c))return this.enforestTemplateLiteral();if(this.term&&this.isUpdateOperator(c))return this.enforestUpdateExpression();if(this.term&&this.isOperator(c))return this.enforestBinaryExpression();if(this.term&&this.isAssign(c)){let d=this.transformDestructuring(this.term),e=this.matchRawSyntax(),f=new Enforester(this.rest,(0,_immutable.List)(),this.context),g=f.enforest('expression');return this.rest=f.rest,'='===e.val()?new T.AssignmentExpression({binding:d,expression:g}):new T.CompoundAssignmentExpression({binding:d,operator:e.val(),expression:g})}return this.term&&this.isPunctuator(c,'?')?this.enforestConditionalExpression():EXPR_LOOP_NO_CHANGE}enforestPrimaryExpression(){let c=this.peek();return null===this.term&&this.isKeyword(c,'this')?this.enforestThisExpression():null===this.term&&(this.isIdentifier(c)||this.isKeyword(c,'let')||this.isKeyword(c,'yield'))?this.enforestIdentifierExpression():null===this.term&&this.isNumericLiteral(c)?this.enforestNumericLiteral():null===this.term&&this.isStringLiteral(c)?this.enforestStringLiteral():null===this.term&&this.isTemplate(c)?this.enforestTemplateLiteral():null===this.term&&this.isBooleanLiteral(c)?this.enforestBooleanLiteral():null===this.term&&this.isNullLiteral(c)?this.enforestNullLiteral():null===this.term&&this.isRegularExpression(c)?this.enforestRegularExpressionLiteral():null===this.term&&this.isFnDeclTransform(c)?this.enforestFunction({isExpr:!0}):null===this.term&&this.isBraces(c)?this.enforestObjectExpression():null===this.term&&this.isBrackets(c)?this.enforestArrayExpression():void(0,_errors.assert)(!1,'Not a primary expression')}enforestLeftHandSideExpression({allowCall:c}){let d=this.peek();for(this.isKeyword(d,'super')?(this.advance(),this.term=new T.Super({})):this.isNewTransform(d)?this.term=this.enforestNewExpression():this.isKeyword(d,'this')&&(this.term=this.enforestThisExpression());;)if(d=this.peek(),this.isParens(d)){if(!c){if(this.term&&((0,_terms.isIdentifierExpression)(this.term)||(0,_terms.isStaticMemberExpression)(this.term)||(0,_terms.isComputedMemberExpression)(this.term)))return this.term;this.term=this.enforestExpressionLoop()}else this.term=this.enforestCallExpression();}else if(this.isBrackets(d))this.term=this.term?this.enforestComputedMemberExpression():this.enforestPrimaryExpression();else if(this.isPunctuator(d,'.')&&(this.isIdentifier(this.peek(1))||this.isKeyword(this.peek(1))))this.term=this.enforestStaticMemberExpression();else if(this.isTemplate(d))this.term=this.enforestTemplateLiteral();else if(this.isBraces(d))this.term=this.enforestPrimaryExpression();else if(this.isIdentifier(d))this.term=new T.IdentifierExpression({name:this.enforestIdentifier()});else break;return this.term}enforestBooleanLiteral(){return new T.LiteralBooleanExpression({value:'true'===this.matchRawSyntax().val()})}enforestTemplateLiteral(){return new T.TemplateExpression({tag:this.term,elements:this.enforestTemplateElements()})}enforestStringLiteral(){return new T.LiteralStringExpression({value:this.matchRawSyntax().val()})}enforestNumericLiteral(){let c=this.matchRawSyntax();return c.val()===1/0?new T.LiteralInfinityExpression({}):new T.LiteralNumericExpression({value:c.val()})}enforestIdentifierExpression(){return new T.IdentifierExpression({name:this.matchRawSyntax()})}enforestRegularExpressionLiteral(){let c=this.matchRawSyntax(),d=c.token.value.lastIndexOf('/'),e=c.token.value.slice(1,d),f=c.token.value.slice(d+1);return new T.LiteralRegExpExpression({pattern:e,flags:f})}enforestNullLiteral(){return this.advance(),new T.LiteralNullExpression({})}enforestThisExpression(){return new T.ThisExpression({stx:this.matchRawSyntax()})}enforestArgumentList(){let c=[];for(;0<this.rest.size;){let d;this.isPunctuator(this.peek(),'...')?(this.advance(),d=new T.SpreadElement({expression:this.enforestExpressionLoop()})):d=this.enforestExpressionLoop(),0<this.rest.size&&this.matchPunctuator(','),c.push(d)}return(0,_immutable.List)(c)}enforestNewExpression(){if(this.matchKeyword('new'),this.isPunctuator(this.peek(),'.')&&this.isIdentifier(this.peek(1),'target'))return this.advance(),this.advance(),new T.NewTargetExpression({});let d,c=this.enforestLeftHandSideExpression({allowCall:!1});return d=this.isParens(this.peek())?this.matchParens():(0,_immutable.List)(),new T.NewExpression({callee:c,arguments:d})}enforestComputedMemberExpression(){let c=new Enforester(this.matchSquares(),(0,_immutable.List)(),this.context);return new T.ComputedMemberExpression({object:this.term,expression:c.enforestExpression()})}transformDestructuring(c){switch(c.type){case'IdentifierExpression':return new T.BindingIdentifier({name:c.name});case'ParenthesizedExpression':return 1===c.inner.size&&this.isIdentifier(c.inner.get(0))?new T.BindingIdentifier({name:c.inner.get(0).value}):c;case'DataProperty':return new T.BindingPropertyProperty({name:c.name,binding:this.transformDestructuringWithDefault(c.expression)});case'ShorthandProperty':return new T.BindingPropertyIdentifier({binding:new T.BindingIdentifier({name:c.name}),init:null});case'ObjectExpression':return new T.ObjectBinding({properties:c.properties.map(d=>this.transformDestructuring(d))});case'ArrayExpression':{let d=c.elements.last();return null!=d&&'SpreadElement'===d.type?new T.ArrayBinding({elements:c.elements.slice(0,-1).map(e=>e&&this.transformDestructuringWithDefault(e)),restElement:this.transformDestructuringWithDefault(d.expression)}):new T.ArrayBinding({elements:c.elements.map(e=>e&&this.transformDestructuringWithDefault(e)),restElement:null})}case'StaticPropertyName':return new T.BindingIdentifier({name:c.value});case'ComputedMemberExpression':case'StaticMemberExpression':case'ArrayBinding':case'BindingIdentifier':case'BindingPropertyIdentifier':case'BindingPropertyProperty':case'BindingWithDefault':case'ObjectBinding':return c;}(0,_errors.assert)(!1,'not implemented yet for '+c.type)}transformDestructuringWithDefault(c){switch(c.type){case'AssignmentExpression':return new T.BindingWithDefault({binding:this.transformDestructuring(c.binding),init:c.expression});}return this.transformDestructuring(c)}enforestCallExpression(){let c=this.matchParens();return new T.CallExpressionE({callee:this.term,arguments:c})}enforestArrowExpression(){let c;if(this.isIdentifier(this.peek()))c=new Enforester(_immutable.List.of(this.advance()),(0,_immutable.List)(),this.context);else{let f=this.matchParens();c=new Enforester(f,(0,_immutable.List)(),this.context)}let d=c.enforestFormalParameters();this.matchPunctuator('=>');let e;return this.isBraces(this.peek())?(e=this.matchCurlies(),new T.ArrowExpressionE({params:d,body:e})):(c=new Enforester(this.rest,(0,_immutable.List)(),this.context),e=c.enforestExpressionLoop(),this.rest=c.rest,new T.ArrowExpression({params:d,body:e}))}enforestYieldExpression(){let c=this.matchKeyword('yield'),d=this.peek();if(0===this.rest.size||d&&!this.lineNumberEq(c,d))return new T.YieldExpression({expression:null});let e=!1;this.isPunctuator(this.peek(),'*')&&(e=!0,this.advance());let f=this.enforestExpression();return new(e?T.YieldGeneratorExpression:T.YieldExpression)({expression:f})}enforestSyntaxTemplate(){return new T.SyntaxTemplate({template:this.matchRawDelimiter()})}enforestStaticMemberExpression(){let c=this.term;this.advance();let d=this.matchRawSyntax();return new T.StaticMemberExpression({object:c,property:d})}enforestArrayExpression(){let c=this.matchSquares(),d=[],e=new Enforester(c,(0,_immutable.List)(),this.context);for(;0<e.rest.size;){let f=e.peek();if(e.isPunctuator(f,','))e.advance(),d.push(null);else if(e.isPunctuator(f,'...')){e.advance();let g=e.enforestExpressionLoop();if(null==g)throw e.createError(f,'expecting expression');d.push(new T.SpreadElement({expression:g}))}else{let g=e.enforestExpressionLoop();if(null==g)throw e.createError(f,'expected expression');d.push(g),e.consumeComma()}}return new T.ArrayExpression({elements:(0,_immutable.List)(d)})}enforestObjectExpression(){let c=this.matchCurlies(),d=(0,_immutable.List)(),e=new Enforester(c,(0,_immutable.List)(),this.context),f=null;for(;0<e.rest.size;){let g=e.enforestPropertyDefinition();if(e.consumeComma(),d=d.concat(g),f===g)throw e.createError(g,'invalid syntax in object');f=g}return new T.ObjectExpression({properties:d})}enforestPropertyDefinition(){let{methodOrKey:c,kind:d}=this.enforestMethodDefinition();switch(d){case'method':return c;case'identifier':if(this.isAssign(this.peek())){this.advance();let f=this.enforestExpressionLoop();return new T.BindingPropertyIdentifier({init:f,binding:this.transformDestructuring(c)})}if(!this.isPunctuator(this.peek(),':'))return new T.ShorthandProperty({name:c.value});}this.matchPunctuator(':');let e=this.enforestExpressionLoop();return new T.DataProperty({name:c,expression:e})}enforestMethodDefinition(){let c=this.peek(),d=!1;if(this.isPunctuator(c,'*')&&(d=!0,this.advance()),this.isIdentifier(c,'get')&&this.isPropertyName(this.peek(1))){this.advance();let{name:f}=this.enforestPropertyName();this.matchParens();let g=this.matchCurlies();return{methodOrKey:new T.Getter({name:f,body:g}),kind:'method'}}if(this.isIdentifier(c,'set')&&this.isPropertyName(this.peek(1))){this.advance();let{name:f}=this.enforestPropertyName(),g=new Enforester(this.matchParens(),(0,_immutable.List)(),this.context),h=g.enforestBindingElement(),i=this.matchCurlies();return{methodOrKey:new T.Setter({name:f,param:h,body:i}),kind:'method'}}let{name:e}=this.enforestPropertyName();if(this.isParens(this.peek())){let f=this.matchParens(),g=new Enforester(f,(0,_immutable.List)(),this.context),h=g.enforestFormalParameters(),i=this.matchCurlies();return{methodOrKey:new T.Method({isGenerator:d,name:e,params:h,body:i}),kind:'method'}}return{methodOrKey:e,kind:this.isIdentifier(c)||this.isKeyword(c)?'identifier':'property'}}enforestPropertyName(){let c=this.peek();if(this.isStringLiteral(c)||this.isNumericLiteral(c))return{name:new T.StaticPropertyName({value:this.matchRawSyntax()}),binding:null};if(this.isBrackets(c)){let e=new Enforester(this.matchSquares(),(0,_immutable.List)(),this.context),f=e.enforestExpressionLoop();return{name:new T.ComputedPropertyName({expression:f}),binding:null}}let d=this.matchRawSyntax();return{name:new T.StaticPropertyName({value:d}),binding:new T.BindingIdentifier({name:d})}}enforestFunction({isExpr:c,inDefault:d}){let f,g,e=null,h=!1,i=this.matchRawSyntax(),j=this.peek();this.isPunctuator(j,'*')&&(h=!0,this.advance(),j=this.peek()),this.isParens(j)?d&&(e=new T.BindingIdentifier({name:_syntax2.default.fromIdentifier('*default*',i)})):e=this.enforestBindingIdentifier(),f=this.matchParens(),g=this.matchCurlies();let k=new Enforester(f,(0,_immutable.List)(),this.context),l=k.enforestFormalParameters();return new(c?T.FunctionExpressionE:T.FunctionDeclarationE)({name:e,isGenerator:h,params:l,body:g})}enforestFormalParameters(){let c=[],d=null;for(;0!==this.rest.size;){let e=this.peek();if(this.isPunctuator(e,'...')){this.matchPunctuator('...'),d=this.enforestBindingIdentifier();break}c.push(this.enforestParam()),this.consumeComma()}return new T.FormalParameters({items:(0,_immutable.List)(c),rest:d})}enforestParam(){return this.enforestBindingElement()}enforestUpdateExpression(){let c=this.matchUnaryOperator();return new T.UpdateExpression({isPrefix:!1,operator:c.val(),operand:this.transformDestructuring(this.term)})}enforestUnaryExpression(){let c=this.matchUnaryOperator();return this.opCtx.stack=this.opCtx.stack.push({prec:this.opCtx.prec,combine:this.opCtx.combine}),this.opCtx.prec=14,this.opCtx.combine=d=>{return'++'===c.val()||'--'===c.val()?new T.UpdateExpression({operator:c.val(),operand:this.transformDestructuring(d),isPrefix:!0}):new T.UnaryExpression({operator:c.val(),operand:d})},EXPR_LOOP_OPERATOR}enforestConditionalExpression(){let c=this.opCtx.combine(this.term);if(0<this.opCtx.stack.size){let{prec:g,combine:h}=this.opCtx.stack.last();this.opCtx.stack=this.opCtx.stack.pop(),this.opCtx.prec=g,this.opCtx.combine=h}this.matchPunctuator('?');let d=new Enforester(this.rest,(0,_immutable.List)(),this.context),e=d.enforestExpressionLoop();d.matchPunctuator(':'),d=new Enforester(d.rest,(0,_immutable.List)(),this.context);let f=d.enforestExpressionLoop();return this.rest=d.rest,new T.ConditionalExpression({test:c,consequent:e,alternate:f})}enforestBinaryExpression(){let c=this.term,d=this.peek();if(d instanceof T.RawSyntax&&(0,_operators.operatorLt)(this.opCtx.prec,(0,_operators.getOperatorPrec)(d.value.val()),(0,_operators.getOperatorAssoc)(d.value.val()))){let e=d.value;return this.opCtx.stack=this.opCtx.stack.push({prec:this.opCtx.prec,combine:this.opCtx.combine}),this.opCtx.prec=(0,_operators.getOperatorPrec)(e.val()),this.opCtx.combine=f=>{return new T.BinaryExpression({left:c,operator:e.val(),right:f})},this.advance(),EXPR_LOOP_OPERATOR}let e=this.opCtx.combine(c),{prec:f,combine:g}=this.opCtx.stack.last();return this.opCtx.stack=this.opCtx.stack.pop(),this.opCtx.prec=f,this.opCtx.combine=g,e}enforestTemplateElements(){let c=this.matchTemplate(),d=c.token.items.map(e=>{if(this.isDelimiter(e)){let f=new Enforester(e.inner.slice(1,e.inner.size-1),(0,_immutable.List)(),this.context);return f.enforest('expression')}return new T.TemplateElement({rawValue:e.slice.text})});return d}expandMacro(){for(let c=this.peek();this.isCompiletimeTransform(c);){let d=this.matchRawSyntax(),e=this.getFromCompiletimeEnvironment(d);if(null==e)throw this.createError(d,`The macro ${d.resolve(this.context.phase)} does not have a bound value`);else if('function'!=typeof e.value)throw this.createError(d,`The macro ${d.resolve(this.context.phase)} was not bound to a callable value: ${e.value}`);let f=(0,_scope.freshScope)('u'),g=(0,_scope.freshScope)('i');this.context.useScope=f;let h=new _macroContext2.default(this,d,this.context,f,g),i=(0,_loadSyntax.sanitizeReplacementValues)(e.value.call(null,h));if(!_immutable.List.isList(i))throw this.createError(d,'macro must return a list but got: '+i);let j=new _scopeReducer2.default([{scope:g,phase:_syntax.ALL_PHASES,flip:!0}],this.context.bindings,!0);i=i.map(k=>{if(k instanceof _syntax2.default)return new T.RawSyntax({value:k}).reduce(j);if(!(k instanceof T.default))throw this.createError(d,'macro must return syntax objects or terms but got: '+k);return k.reduce(j)}),this.rest=i.concat(h._rest(this)),c=this.peek()}}consumeSemicolon(){let c=this.peek();c&&this.isPunctuator(c,';')&&this.advance()}consumeComma(){let c=this.peek();c&&this.isPunctuator(c,',')&&this.advance()}safeCheck(c,d,e=null){if(c instanceof T.default){if(c instanceof T.RawSyntax)return c.value&&'function'==typeof c.value.match&&c.value.match(d,e);if(c instanceof T.RawDelimiter)return'delimiter'===d||c.kind===d}return c&&!('function'!=typeof c.match)&&c.match(d,e)}isTerm(c){return c&&c instanceof T.default}isEOF(c){return this.safeCheck(c,'eof')}isIdentifier(c,d=null){return this.safeCheck(c,'identifier',d)}isPropertyName(c){return this.isIdentifier(c)||this.isKeyword(c)||this.isNumericLiteral(c)||this.isStringLiteral(c)||this.isBrackets(c)}isNumericLiteral(c,d=null){return this.safeCheck(c,'number',d)}isStringLiteral(c,d=null){return this.safeCheck(c,'string',d)}isTemplate(c,d=null){return this.safeCheck(c,'template',d)}isSyntaxTemplate(c){return this.safeCheck(c,'syntaxTemplate')}isBooleanLiteral(c,d=null){return this.safeCheck(c,'boolean',d)}isNullLiteral(c,d=null){return this.safeCheck(c,'null',d)}isRegularExpression(c,d=null){return this.safeCheck(c,'regularExpression',d)}isDelimiter(c){return this.safeCheck(c,'delimiter')}isParens(c){return this.safeCheck(c,'parens')}isBraces(c){return this.safeCheck(c,'braces')}isBrackets(c){return this.safeCheck(c,'brackets')}isAssign(c,d=null){return this.safeCheck(c,'assign',d)}isKeyword(c,d=null){return this.safeCheck(c,'keyword',d)}isPunctuator(c,d=null){return this.safeCheck(c,'punctuator',d)}isOperator(c){return(this.safeCheck(c,'punctuator')||this.safeCheck(c,'identifier')||this.safeCheck(c,'keyword'))&&(c instanceof T.RawSyntax&&(0,_operators.isOperator)(c.value)||c instanceof _syntax2.default&&(0,_operators.isOperator)(c))}isUpdateOperator(c){return this.safeCheck(c,'punctuator','++')||this.safeCheck(c,'punctuator','--')}safeResolve(c,d){if(c instanceof T.RawSyntax)return'function'==typeof c.value.resolve?Just(c.value.resolve(d)):Nothing();return c instanceof _syntax2.default?'function'==typeof c.resolve?Just(c.resolve(d)):Nothing():Nothing()}isTransform(c,d){return this.safeResolve(c,this.context.phase).map(e=>this.context.env.get(e)===d||this.context.store.get(e)===d).getOrElse(!1)}isTransformInstance(c,d){return this.safeResolve(c,this.context.phase).map(e=>this.context.env.get(e)instanceof d||this.context.store.get(e)instanceof d).getOrElse(!1)}isFnDeclTransform(c){return this.isTransform(c,_transforms.FunctionDeclTransform)}isVarDeclTransform(c){return this.isTransform(c,_transforms.VariableDeclTransform)}isLetDeclTransform(c){return this.isTransform(c,_transforms.LetDeclTransform)}isConstDeclTransform(c){return this.isTransform(c,_transforms.ConstDeclTransform)}isSyntaxDeclTransform(c){return this.isTransform(c,_transforms.SyntaxDeclTransform)}isSyntaxrecDeclTransform(c){return this.isTransform(c,_transforms.SyntaxrecDeclTransform)}isReturnStmtTransform(c){return this.isTransform(c,_transforms.ReturnStatementTransform)}isWhileTransform(c){return this.isTransform(c,_transforms.WhileTransform)}isForTransform(c){return this.isTransform(c,_transforms.ForTransform)}isSwitchTransform(c){return this.isTransform(c,_transforms.SwitchTransform)}isBreakTransform(c){return this.isTransform(c,_transforms.BreakTransform)}isContinueTransform(c){return this.isTransform(c,_transforms.ContinueTransform)}isDoTransform(c){return this.isTransform(c,_transforms.DoTransform)}isDebuggerTransform(c){return this.isTransform(c,_transforms.DebuggerTransform)}isWithTransform(c){return this.isTransform(c,_transforms.WithTransform)}isTryTransform(c){return this.isTransform(c,_transforms.TryTransform)}isThrowTransform(c){return this.isTransform(c,_transforms.ThrowTransform)}isIfTransform(c){return this.isTransform(c,_transforms.IfTransform)}isNewTransform(c){return this.isTransform(c,_transforms.NewTransform)}isCompiletimeTransform(c){return this.isTransformInstance(c,_transforms.CompiletimeTransform)}isModuleNamespaceTransform(c){return this.isTransformInstance(c,_transforms.ModuleNamespaceTransform)}isVarBindingTransform(c){return this.isTransformInstance(c,_transforms.VarBindingTransform)}getFromCompiletimeEnvironment(c){return this.context.env.has(c.resolve(this.context.phase))?this.context.env.get(c.resolve(this.context.phase)):this.context.store.get(c.resolve(this.context.phase))}lineNumberEq(c,d){return c&&d&&getLineNumber(c)===getLineNumber(d)}matchRawDelimiter(){let c=this.advance();if(c instanceof T.RawDelimiter)return c.inner;throw this.createError(c,'expecting a RawDelimiter')}matchRawSyntax(){let c=this.advance();if(c instanceof T.RawSyntax)return c.value;throw this.createError(c,'expecting a RawSyntax')}matchIdentifier(c){let d=this.peek();if(this.isIdentifier(d,c))return this.matchRawSyntax();throw this.createError(d,'expecting an identifier')}matchKeyword(c){let d=this.peek();if(this.isKeyword(d,c))return this.matchRawSyntax();throw this.createError(d,'expecting '+c)}matchLiteral(){let c=this.peek();if(this.isNumericLiteral(c)||this.isStringLiteral(c)||this.isBooleanLiteral(c)||this.isNullLiteral(c)||this.isTemplate(c)||this.isRegularExpression(c))return this.matchRawSyntax();throw this.createError(c,'expecting a literal')}matchStringLiteral(){let c=this.peek();if(this.isStringLiteral(c))return this.matchRawSyntax();throw this.createError(c,'expecting a string literal')}matchTemplate(){let c=this.peek();if(this.isTemplate(c))return this.matchRawSyntax();throw this.createError(c,'expecting a template literal')}matchParens(){let c=this.peek();if(this.isParens(c)){let d=this.matchRawDelimiter();return d.slice(1,d.size-1)}throw this.createError(c,'expecting parens')}matchCurlies(){let c=this.peek();if(this.isBraces(c)){let d=this.matchRawDelimiter();return d.slice(1,d.size-1)}throw this.createError(c,'expecting curly braces')}matchSquares(){let c=this.peek();if(this.isBrackets(c)){let d=this.matchRawDelimiter();return d.slice(1,d.size-1)}throw this.createError(c,'expecting square braces')}matchUnaryOperator(){let c=this.matchRawSyntax();if((0,_operators.isUnaryOperator)(c))return c;throw this.createError(c,'expecting a unary operator')}matchPunctuator(c){let d=this.matchRawSyntax();if(this.isPunctuator(d)){if('undefined'!=typeof c){if(d.val()===c)return d;throw this.createError(d,'expecting a '+c+' punctuator')}return d}throw this.createError(d,'expecting a punctuator')}createError(c,d){let e='',f=c;return e=0<this.rest.size?this.rest.slice(0,20).map(g=>{return g instanceof T.RawDelimiter?g.inner:_immutable.List.of(g)}).flatten().map(g=>{let h=g instanceof T.RawSyntax?g.value.val():g.toString();return g===f?'__'+h+'__':h}).join(' '):f.toString(),new Error(d+'\n'+e)}}exports.Enforester=Enforester;

