"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Enforester=void 0;var _terms=require("./terms"),_terms2=_interopRequireDefault(_terms),_ramdaFantasy=require("ramda-fantasy"),_transforms=require("./transforms"),_immutable=require("immutable"),_errors=require("./errors"),_operators=require("./operators"),_syntax=require("./syntax"),_syntax2=_interopRequireDefault(_syntax),_scope=require("./scope"),_loadSyntax=require("./load-syntax"),_macroContext=require("./macro-context"),_macroContext2=_interopRequireDefault(_macroContext);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const Just=_ramdaFantasy.Maybe.Just,Nothing=_ramdaFantasy.Maybe.Nothing,EXPR_LOOP_OPERATOR={},EXPR_LOOP_NO_CHANGE={},EXPR_LOOP_EXPANSION={};class Enforester{constructor(e,r,i){this.done=!1,(0,_errors.assert)(_immutable.List.isList(e),"expecting a list of terms to enforest"),(0,_errors.assert)(_immutable.List.isList(r),"expecting a list of terms to enforest"),(0,_errors.assert)(i,"expecting a context to enforest"),this.term=null,this.rest=e,this.prev=r,this.context=i}peek(){let e=0>=arguments.length||arguments[0]===void 0?0:arguments[0];return this.rest.get(e)}advance(){let e=this.rest.first();return this.rest=this.rest.rest(),e}enforest(){let e=0>=arguments.length||void 0===arguments[0]?"Module":arguments[0];if(this.term=null,0===this.rest.size)return this.done=!0,this.term;if(this.isEOF(this.peek()))return this.term=new _terms2.default("EOF",{}),this.advance(),this.term;let r;return r="expression"===e?this.enforestExpressionLoop():this.enforestModule(),0===this.rest.size&&(this.done=!0),r}enforestModule(){return this.enforestBody()}enforestBody(){return this.enforestModuleItem()}enforestModuleItem(){let e=this.peek();return this.isKeyword(e,"import")?(this.advance(),this.enforestImportDeclaration()):this.isKeyword(e,"export")?(this.advance(),this.enforestExportDeclaration()):this.isIdentifier(e,"#")?this.enforestLanguagePragma():this.enforestStatement()}enforestLanguagePragma(){this.matchIdentifier("#"),this.matchIdentifier("lang");let e=this.matchStringLiteral();return this.consumeSemicolon(),new _terms2.default("Pragma",{kind:"lang",items:_immutable.List.of(e)})}enforestExportDeclaration(){let e=this.peek();if(this.isPunctuator(e,"*")){this.advance();let r=this.enforestFromClause();return new _terms2.default("ExportAllFrom",{moduleSpecifier:r})}if(this.isBraces(e)){let r=this.enforestExportClause(),i=null;return this.isIdentifier(this.peek(),"from")&&(i=this.enforestFromClause()),new _terms2.default("ExportFrom",{namedExports:r,moduleSpecifier:i})}if(this.isKeyword(e,"class"))return new _terms2.default("Export",{declaration:this.enforestClass({isExpr:!1})});if(this.isFnDeclTransform(e))return new _terms2.default("Export",{declaration:this.enforestFunction({isExpr:!1,inDefault:!1})});if(this.isKeyword(e,"default")){if(this.advance(),this.isFnDeclTransform(this.peek()))return new _terms2.default("ExportDefault",{body:this.enforestFunction({isExpr:!1,inDefault:!0})});if(this.isKeyword(this.peek(),"class"))return new _terms2.default("ExportDefault",{body:this.enforestClass({isExpr:!1,inDefault:!0})});let r=this.enforestExpressionLoop();return this.consumeSemicolon(),new _terms2.default("ExportDefault",{body:r})}if(this.isVarDeclTransform(e)||this.isLetDeclTransform(e)||this.isConstDeclTransform(e)||this.isSyntaxrecDeclTransform(e)||this.isSyntaxDeclTransform(e))return new _terms2.default("Export",{declaration:this.enforestVariableDeclaration()});throw this.createError(e,"unexpected syntax")}enforestExportClause(){let e=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context),r=[];for(;0!==e.rest.size;)r.push(e.enforestExportSpecifier()),e.consumeComma();return(0,_immutable.List)(r)}enforestExportSpecifier(){let e=this.enforestIdentifier();if(this.isIdentifier(this.peek(),"as")){this.advance();let r=this.enforestIdentifier();return new _terms2.default("ExportSpecifier",{name:e,exportedName:r})}return new _terms2.default("ExportSpecifier",{name:null,exportedName:e})}enforestImportDeclaration(){let e=this.peek(),r=null,i=(0,_immutable.List)(),o=!1;if(this.isStringLiteral(e)){let d=this.advance();return this.consumeSemicolon(),new _terms2.default("Import",{defaultBinding:r,namedImports:i,moduleSpecifier:d,forSyntax:o})}if((this.isIdentifier(e)||this.isKeyword(e))&&(r=this.enforestBindingIdentifier(),!this.isPunctuator(this.peek(),","))){let d=this.enforestFromClause();return this.isKeyword(this.peek(),"for")&&this.isIdentifier(this.peek(1),"syntax")&&(this.advance(),this.advance(),o=!0),new _terms2.default("Import",{defaultBinding:r,moduleSpecifier:d,namedImports:(0,_immutable.List)(),forSyntax:o})}if(this.consumeComma(),e=this.peek(),this.isBraces(e)){let d=this.enforestNamedImports(),f=this.enforestFromClause();return this.isKeyword(this.peek(),"for")&&this.isIdentifier(this.peek(1),"syntax")&&(this.advance(),this.advance(),o=!0),new _terms2.default("Import",{defaultBinding:r,forSyntax:o,namedImports:d,moduleSpecifier:f})}if(this.isPunctuator(e,"*")){let d=this.enforestNamespaceBinding(),f=this.enforestFromClause();return this.isKeyword(this.peek(),"for")&&this.isIdentifier(this.peek(1),"syntax")&&(this.advance(),this.advance(),o=!0),new _terms2.default("ImportNamespace",{defaultBinding:r,forSyntax:o,namespaceBinding:d,moduleSpecifier:f})}throw this.createError(e,"unexpected syntax")}enforestNamespaceBinding(){return this.matchPunctuator("*"),this.matchIdentifier("as"),this.enforestBindingIdentifier()}enforestNamedImports(){let e=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context),r=[];for(;0!==e.rest.size;)r.push(e.enforestImportSpecifiers()),e.consumeComma();return(0,_immutable.List)(r)}enforestImportSpecifiers(){let e=this.peek(),r;if(this.isIdentifier(e)||this.isKeyword(e)){if(r=this.advance(),!this.isIdentifier(this.peek(),"as"))return new _terms2.default("ImportSpecifier",{name:null,binding:new _terms2.default("BindingIdentifier",{name:r})});this.matchIdentifier("as")}else throw this.createError(e,"unexpected token in import specifier");return new _terms2.default("ImportSpecifier",{name:r,binding:this.enforestBindingIdentifier()})}enforestFromClause(){this.matchIdentifier("from");let e=this.matchStringLiteral();return this.consumeSemicolon(),e}enforestStatementListItem(){let e=this.peek();return this.isFnDeclTransform(e)?this.enforestFunctionDeclaration({isExpr:!1}):this.isKeyword(e,"class")?this.enforestClass({isExpr:!1}):this.enforestStatement()}enforestStatement(){let e=this.peek();if(null===this.term&&this.isCompiletimeTransform(e)&&(this.expandMacro(),e=this.peek()),null===this.term&&this.isTerm(e))return this.advance();if(null===this.term&&this.isBraces(e))return this.enforestBlockStatement();if(null===this.term&&this.isWhileTransform(e))return this.enforestWhileStatement();if(null===this.term&&this.isIfTransform(e))return this.enforestIfStatement();if(null===this.term&&this.isForTransform(e))return this.enforestForStatement();if(null===this.term&&this.isSwitchTransform(e))return this.enforestSwitchStatement();if(null===this.term&&this.isBreakTransform(e))return this.enforestBreakStatement();if(null===this.term&&this.isContinueTransform(e))return this.enforestContinueStatement();if(null===this.term&&this.isDoTransform(e))return this.enforestDoStatement();if(null===this.term&&this.isDebuggerTransform(e))return this.enforestDebuggerStatement();if(null===this.term&&this.isWithTransform(e))return this.enforestWithStatement();if(null===this.term&&this.isTryTransform(e))return this.enforestTryStatement();if(null===this.term&&this.isThrowTransform(e))return this.enforestThrowStatement();if(null===this.term&&this.isKeyword(e,"class"))return this.enforestClass({isExpr:!1});if(null===this.term&&this.isFnDeclTransform(e))return this.enforestFunctionDeclaration();if(null===this.term&&this.isIdentifier(e)&&this.isPunctuator(this.peek(1),":"))return this.enforestLabeledStatement();if(null===this.term&&(this.isVarDeclTransform(e)||this.isLetDeclTransform(e)||this.isConstDeclTransform(e)||this.isSyntaxrecDeclTransform(e)||this.isSyntaxDeclTransform(e))){let r=new _terms2.default("VariableDeclarationStatement",{declaration:this.enforestVariableDeclaration()});return this.consumeSemicolon(),r}return null===this.term&&this.isReturnStmtTransform(e)?this.enforestReturnStatement():null===this.term&&this.isPunctuator(e,";")?(this.advance(),new _terms2.default("EmptyStatement",{})):this.enforestExpressionStatement()}enforestLabeledStatement(){let e=this.matchIdentifier();this.matchPunctuator(":");let r=this.enforestStatement();return new _terms2.default("LabeledStatement",{label:e,body:r})}enforestBreakStatement(){this.matchKeyword("break");let e=this.peek(),r=null;return 0===this.rest.size||this.isPunctuator(e,";")?(this.consumeSemicolon(),new _terms2.default("BreakStatement",{label:r})):((this.isIdentifier(e)||this.isKeyword(e,"yield")||this.isKeyword(e,"let"))&&(r=this.enforestIdentifier()),this.consumeSemicolon(),new _terms2.default("BreakStatement",{label:r}))}enforestTryStatement(){this.matchKeyword("try");let e=this.enforestBlock();if(this.isKeyword(this.peek(),"catch")){let r=this.enforestCatchClause();if(this.isKeyword(this.peek(),"finally")){this.advance();let i=this.enforestBlock();return new _terms2.default("TryFinallyStatement",{body:e,catchClause:r,finalizer:i})}return new _terms2.default("TryCatchStatement",{body:e,catchClause:r})}if(this.isKeyword(this.peek(),"finally")){this.advance();let r=this.enforestBlock();return new _terms2.default("TryFinallyStatement",{body:e,catchClause:null,finalizer:r})}throw this.createError(this.peek(),"try with no catch or finally")}enforestCatchClause(){this.matchKeyword("catch");let e=this.matchParens(),r=new Enforester(e,(0,_immutable.List)(),this.context),i=r.enforestBindingTarget(),o=this.enforestBlock();return new _terms2.default("CatchClause",{binding:i,body:o})}enforestThrowStatement(){this.matchKeyword("throw");let e=this.enforestExpression();return this.consumeSemicolon(),new _terms2.default("ThrowStatement",{expression:e})}enforestWithStatement(){this.matchKeyword("with");let e=this.matchParens(),r=new Enforester(e,(0,_immutable.List)(),this.context),i=r.enforestExpression(),o=this.enforestStatement();return new _terms2.default("WithStatement",{object:i,body:o})}enforestDebuggerStatement(){return this.matchKeyword("debugger"),new _terms2.default("DebuggerStatement",{})}enforestDoStatement(){this.matchKeyword("do");let e=this.enforestStatement();this.matchKeyword("while");let r=this.matchParens(),i=new Enforester(r,(0,_immutable.List)(),this.context),o=i.enforestExpression();return this.consumeSemicolon(),new _terms2.default("DoWhileStatement",{body:e,test:o})}enforestContinueStatement(){let e=this.matchKeyword("continue"),r=this.peek(),i=null;return 0===this.rest.size||this.isPunctuator(r,";")?(this.consumeSemicolon(),new _terms2.default("ContinueStatement",{label:i})):(this.lineNumberEq(e,r)&&(this.isIdentifier(r)||this.isKeyword(r,"yield")||this.isKeyword(r,"let"))&&(i=this.enforestIdentifier()),this.consumeSemicolon(),new _terms2.default("ContinueStatement",{label:i}))}enforestSwitchStatement(){this.matchKeyword("switch");let e=this.matchParens(),r=new Enforester(e,(0,_immutable.List)(),this.context),i=r.enforestExpression(),o=this.matchCurlies();if(0===o.size)return new _terms2.default("SwitchStatement",{discriminant:i,cases:(0,_immutable.List)()});r=new Enforester(o,(0,_immutable.List)(),this.context);let d=r.enforestSwitchCases(),f=r.peek();if(r.isKeyword(f,"default")){let c=r.enforestSwitchDefault(),m=r.enforestSwitchCases();return new _terms2.default("SwitchStatementWithDefault",{discriminant:i,preDefaultCases:d,defaultCase:c,postDefaultCases:m})}return new _terms2.default("SwitchStatement",{discriminant:i,cases:d})}enforestSwitchCases(){let e=[];for(;!(0===this.rest.size||this.isKeyword(this.peek(),"default"));)e.push(this.enforestSwitchCase());return(0,_immutable.List)(e)}enforestSwitchCase(){return this.matchKeyword("case"),new _terms2.default("SwitchCase",{test:this.enforestExpression(),consequent:this.enforestSwitchCaseBody()})}enforestSwitchCaseBody(){return this.matchPunctuator(":"),this.enforestStatementListInSwitchCaseBody()}enforestStatementListInSwitchCaseBody(){let e=[];for(;!(0===this.rest.size||this.isKeyword(this.peek(),"default")||this.isKeyword(this.peek(),"case"));)e.push(this.enforestStatementListItem());return(0,_immutable.List)(e)}enforestSwitchDefault(){return this.matchKeyword("default"),new _terms2.default("SwitchDefault",{consequent:this.enforestSwitchCaseBody()})}enforestForStatement(){this.matchKeyword("for");let e=this.matchParens(),r=new Enforester(e,(0,_immutable.List)(),this.context),i,o,d,f,c,m,u;if(r.isPunctuator(r.peek(),";"))return r.advance(),r.isPunctuator(r.peek(),";")||(o=r.enforestExpression()),r.matchPunctuator(";"),0!==r.rest.size&&(f=r.enforestExpression()),new _terms2.default("ForStatement",{init:null,test:o,update:f,body:this.enforestStatement()});if(i=r.peek(),r.isVarDeclTransform(i)||r.isLetDeclTransform(i)||r.isConstDeclTransform(i)){if(d=r.enforestVariableDeclaration(),i=r.peek(),this.isKeyword(i,"in")||this.isIdentifier(i,"of"))return this.isKeyword(i,"in")?(r.advance(),f=r.enforestExpression(),c="ForInStatement"):this.isIdentifier(i,"of")&&(r.advance(),f=r.enforestExpression(),c="ForOfStatement"),new _terms2.default(c,{left:d,right:f,body:this.enforestStatement()});r.matchPunctuator(";"),r.isPunctuator(r.peek(),";")?(r.advance(),o=null):(o=r.enforestExpression(),r.matchPunctuator(";")),u=r.enforestExpression()}else{if(this.isKeyword(r.peek(1),"in")||this.isIdentifier(r.peek(1),"of")){m=r.enforestBindingIdentifier();let l=r.advance();return c=this.isKeyword(l,"in")?"ForInStatement":"ForOfStatement",f=r.enforestExpression(),new _terms2.default(c,{left:m,right:f,body:this.enforestStatement()})}d=r.enforestExpression(),r.matchPunctuator(";"),r.isPunctuator(r.peek(),";")?(r.advance(),o=null):(o=r.enforestExpression(),r.matchPunctuator(";")),u=r.enforestExpression()}return new _terms2.default("ForStatement",{init:d,test:o,update:u,body:this.enforestStatement()})}enforestIfStatement(){this.matchKeyword("if");let e=this.matchParens(),r=new Enforester(e,(0,_immutable.List)(),this.context),i=r.peek(),o=r.enforestExpression();if(null===o)throw r.createError(i,"expecting an expression");let d=this.enforestStatement(),f=null;return this.isKeyword(this.peek(),"else")&&(this.advance(),f=this.enforestStatement()),new _terms2.default("IfStatement",{test:o,consequent:d,alternate:f})}enforestWhileStatement(){this.matchKeyword("while");let e=this.matchParens(),r=new Enforester(e,(0,_immutable.List)(),this.context),i=r.peek(),o=r.enforestExpression();if(null===o)throw r.createError(i,"expecting an expression");let d=this.enforestStatement();return new _terms2.default("WhileStatement",{test:o,body:d})}enforestBlockStatement(){return new _terms2.default("BlockStatement",{block:this.enforestBlock()})}enforestBlock(){return new _terms2.default("Block",{statements:this.matchCurlies()})}enforestClass(e){let r=e.isExpr,i=e.inDefault,o=this.advance(),d=null,f=null,c=r?"ClassExpression":"ClassDeclaration";if(this.isIdentifier(this.peek()))d=this.enforestBindingIdentifier();else if(!r)if(i)d=new _terms2.default("BindingIdentifier",{name:_syntax2.default.fromIdentifier("_default",o)});else throw this.createError(this.peek(),"unexpected syntax");this.isKeyword(this.peek(),"extends")&&(this.advance(),f=this.enforestExpressionLoop());let m=[],u=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context);for(;0!==u.rest.size;){if(u.isPunctuator(u.peek(),";")){u.advance();continue}let y=!1;var l=u.enforestMethodDefinition();let g=l.methodOrKey,E=l.kind;if("identifier"===E&&"static"===g.value.val()){y=!0;var h=u.enforestMethodDefinition();g=h.methodOrKey,E=h.kind}if("method"===E)m.push(new _terms2.default("ClassElement",{isStatic:y,method:g}));else throw this.createError(u.peek(),"Only methods are allowed in classes")}return new _terms2.default(c,{name:d,super:f,elements:(0,_immutable.List)(m)})}enforestBindingTarget(){var e=0>=arguments.length||arguments[0]===void 0?{}:arguments[0];let r=e.allowPunctuator,i=this.peek();if(this.isIdentifier(i)||this.isKeyword(i)||r&&this.isPunctuator(i))return this.enforestBindingIdentifier({allowPunctuator:r});return this.isBrackets(i)?this.enforestArrayBinding():this.isBraces(i)?this.enforestObjectBinding():void(0,_errors.assert)(!1,"not implemented yet")}enforestObjectBinding(){let e=new Enforester(this.matchCurlies(),(0,_immutable.List)(),this.context),r=[];for(;0!==e.rest.size;)r.push(e.enforestBindingProperty()),e.consumeComma();return new _terms2.default("ObjectBinding",{properties:(0,_immutable.List)(r)})}enforestBindingProperty(){let e=this.peek();var r=this.enforestPropertyName();let i=r.name,o=r.binding;if((this.isIdentifier(e)||this.isKeyword(e,"let")||this.isKeyword(e,"yield"))&&!this.isPunctuator(this.peek(),":")){let d=null;if(this.isAssign(this.peek())){this.advance();let f=this.enforestExpressionLoop();d=f}return new _terms2.default("BindingPropertyIdentifier",{binding:o,init:d})}return this.matchPunctuator(":"),o=this.enforestBindingElement(),new _terms2.default("BindingPropertyProperty",{name:i,binding:o})}enforestArrayBinding(){let e=this.matchSquares(),r=new Enforester(e,(0,_immutable.List)(),this.context),i=[],o=null;for(;0!==r.rest.size;){let d;if(r.isPunctuator(r.peek(),","))r.consumeComma(),d=null;else{if(r.isPunctuator(r.peek(),"...")){r.advance(),o=r.enforestBindingTarget();break}else d=r.enforestBindingElement();r.consumeComma()}i.push(d)}return new _terms2.default("ArrayBinding",{elements:(0,_immutable.List)(i),restElement:o})}enforestBindingElement(){let e=this.enforestBindingTarget();if(this.isAssign(this.peek())){this.advance();let r=this.enforestExpressionLoop();e=new _terms2.default("BindingWithDefault",{binding:e,init:r})}return e}enforestBindingIdentifier(){var e=0>=arguments.length||void 0===arguments[0]?{}:arguments[0];let i,r=e.allowPunctuator;return i=r&&this.isPunctuator(this.peek())?this.enforestPunctuator():this.enforestIdentifier(),new _terms2.default("BindingIdentifier",{name:i})}enforestPunctuator(){let e=this.peek();if(this.isPunctuator(e))return this.advance();throw this.createError(e,"expecting a punctuator")}enforestIdentifier(){let e=this.peek();if(this.isIdentifier(e)||this.isKeyword(e))return this.advance();throw this.createError(e,"expecting an identifier")}enforestReturnStatement(){let e=this.advance(),r=this.peek();if(0===this.rest.size||r&&!this.lineNumberEq(e,r))return new _terms2.default("ReturnStatement",{expression:null});let i=null;return this.isPunctuator(r,";")||(i=this.enforestExpression(),(0,_errors.expect)(null!=i,"Expecting an expression to follow return keyword",r,this.rest)),this.consumeSemicolon(),new _terms2.default("ReturnStatement",{expression:i})}enforestVariableDeclaration(){let e,r=this.advance(),i=r,o=this.context.phase;i&&this.context.env.get(i.resolve(o))===_transforms.VariableDeclTransform?e="var":i&&this.context.env.get(i.resolve(o))===_transforms.LetDeclTransform?e="let":i&&this.context.env.get(i.resolve(o))===_transforms.ConstDeclTransform?e="const":i&&this.context.env.get(i.resolve(o))===_transforms.SyntaxDeclTransform?e="syntax":i&&this.context.env.get(i.resolve(o))===_transforms.SyntaxrecDeclTransform&&(e="syntaxrec");let d=(0,_immutable.List)();for(;;){let f=this.enforestVariableDeclarator({isSyntax:"syntax"===e||"syntaxrec"===e}),c=this.peek();if(d=d.concat(f),this.isPunctuator(c,","))this.advance();else break}return new _terms2.default("VariableDeclaration",{kind:e,declarators:d})}enforestVariableDeclarator(e){let r=e.isSyntax,i=this.enforestBindingTarget({allowPunctuator:r}),o=this.peek(),d;if(this.isPunctuator(o,"=")){this.advance();let f=new Enforester(this.rest,(0,_immutable.List)(),this.context);d=f.enforest("expression"),this.rest=f.rest}else d=null;return new _terms2.default("VariableDeclarator",{binding:i,init:d})}enforestExpressionStatement(){let e=this.rest.get(0),r=this.enforestExpression();if(null===r)throw this.createError(e,"not a valid expression");return this.consumeSemicolon(),new _terms2.default("ExpressionStatement",{expression:r})}enforestExpression(){let e=this.enforestExpressionLoop(),r=this.peek();if(this.isPunctuator(r,","))for(;0!==this.rest.size&&!!this.isPunctuator(this.peek(),",");){let i=this.advance(),o=this.enforestExpressionLoop();e=new _terms2.default("BinaryExpression",{left:e,operator:i,right:o})}return this.term=null,e}enforestExpressionLoop(){this.term=null,this.opCtx={prec:0,combine:r=>r,stack:(0,_immutable.List)()};do{let r=this.enforestAssignmentExpression();if(r===EXPR_LOOP_NO_CHANGE&&0<this.opCtx.stack.size){this.term=this.opCtx.combine(this.term);var e=this.opCtx.stack.last();let i=e.prec,o=e.combine;this.opCtx.prec=i,this.opCtx.combine=o,this.opCtx.stack=this.opCtx.stack.pop()}else if(r===EXPR_LOOP_NO_CHANGE)break;else this.term=r===EXPR_LOOP_OPERATOR||r===EXPR_LOOP_EXPANSION?null:r}while(!0);return this.term}enforestAssignmentExpression(){let e=this.peek();if(null===this.term&&this.isCompiletimeTransform(e)&&(this.expandMacro(),e=this.peek()),null===this.term&&this.isTerm(e))return this.advance();if(null===this.term&&this.isKeyword(e,"yield"))return this.enforestYieldExpression();if(null===this.term&&this.isKeyword(e,"class"))return this.enforestClass({isExpr:!0});if(null===this.term&&(this.isIdentifier(e)||this.isParens(e))&&this.isPunctuator(this.peek(1),"=>")&&this.lineNumberEq(e,this.peek(1)))return this.enforestArrowExpression();if(null===this.term&&this.isSyntaxTemplate(e))return this.enforestSyntaxTemplate();if(null===this.term&&this.isSyntaxQuoteTransform(e))return this.enforestSyntaxQuote();if(null===this.term&&this.isParens(e))return new _terms2.default("ParenthesizedExpression",{inner:this.advance().inner()});if(null===this.term&&(this.isKeyword(e,"this")||this.isIdentifier(e)||this.isKeyword(e,"let")||this.isKeyword(e,"yield")||this.isNumericLiteral(e)||this.isStringLiteral(e)||this.isTemplate(e)||this.isBooleanLiteral(e)||this.isNullLiteral(e)||this.isRegularExpression(e)||this.isFnDeclTransform(e)||this.isBraces(e)||this.isBrackets(e)))return this.enforestPrimaryExpression();if(null===this.term&&this.isOperator(e))return this.enforestUnaryExpression();if(null===this.term&&this.isVarBindingTransform(e)){let r=this.getFromCompiletimeEnvironment(e).id;if(r!==e)return this.advance(),this.rest=_immutable.List.of(r).concat(this.rest),EXPR_LOOP_EXPANSION}if(null===this.term&&(this.isNewTransform(e)||this.isKeyword(e,"super"))||this.term&&(this.isPunctuator(e,".")&&(this.isIdentifier(this.peek(1))||this.isKeyword(this.peek(1)))||this.isBrackets(e)||this.isParens(e)))return this.enforestLeftHandSideExpression({allowCall:!0});if(this.term&&this.isTemplate(e))return this.enforestTemplateLiteral();if(this.term&&this.isUpdateOperator(e))return this.enforestUpdateExpression();if(this.term&&this.isOperator(e))return this.enforestBinaryExpression();if(this.term&&this.isAssign(e)){let r=this.transformDestructuring(this.term),i=this.advance(),o=new Enforester(this.rest,(0,_immutable.List)(),this.context),d=o.enforest("expression");return this.rest=o.rest,"="===i.val()?new _terms2.default("AssignmentExpression",{binding:r,expression:d}):new _terms2.default("CompoundAssignmentExpression",{binding:r,operator:i.val(),expression:d})}return this.term&&this.isPunctuator(e,"?")?this.enforestConditionalExpression():EXPR_LOOP_NO_CHANGE}enforestPrimaryExpression(){let e=this.peek();return null===this.term&&this.isKeyword(e,"this")?this.enforestThisExpression():null===this.term&&(this.isIdentifier(e)||this.isKeyword(e,"let")||this.isKeyword(e,"yield"))?this.enforestIdentifierExpression():null===this.term&&this.isNumericLiteral(e)?this.enforestNumericLiteral():null===this.term&&this.isStringLiteral(e)?this.enforestStringLiteral():null===this.term&&this.isTemplate(e)?this.enforestTemplateLiteral():null===this.term&&this.isBooleanLiteral(e)?this.enforestBooleanLiteral():null===this.term&&this.isNullLiteral(e)?this.enforestNullLiteral():null===this.term&&this.isRegularExpression(e)?this.enforestRegularExpressionLiteral():null===this.term&&this.isFnDeclTransform(e)?this.enforestFunctionExpression():null===this.term&&this.isBraces(e)?this.enforestObjectExpression():null===this.term&&this.isBrackets(e)?this.enforestArrayExpression():void(0,_errors.assert)(!1,"Not a primary expression")}enforestLeftHandSideExpression(e){let r=e.allowCall,i=this.peek();for(this.isKeyword(i,"super")?(this.advance(),this.term=new _terms2.default("Super",{})):this.isNewTransform(i)&&(this.term=this.enforestNewExpression());;)if(i=this.peek(),this.isParens(i)){if(!r){if(this.term&&((0,_terms.isIdentifierExpression)(this.term)||(0,_terms.isStaticMemberExpression)(this.term)||(0,_terms.isComputedMemberExpression)(this.term)))return this.term;this.term=this.enforestExpressionLoop()}else this.term=this.enforestCallExpression();}else if(this.isBrackets(i))this.term=this.term?this.enforestComputedMemberExpression():this.enforestPrimaryExpression();else if(this.isPunctuator(i,".")&&(this.isIdentifier(this.peek(1))||this.isKeyword(this.peek(1))))this.term=this.enforestStaticMemberExpression();else if(this.isTemplate(i))this.term=this.enforestTemplateLiteral();else if(this.isBraces(i))this.term=this.enforestPrimaryExpression();else if(this.isIdentifier(i))this.term=new _terms2.default("IdentifierExpression",{name:this.enforestIdentifier()});else break;return this.term}enforestBooleanLiteral(){return new _terms2.default("LiteralBooleanExpression",{value:this.advance()})}enforestTemplateLiteral(){return new _terms2.default("TemplateExpression",{tag:this.term,elements:this.enforestTemplateElements()})}enforestStringLiteral(){return new _terms2.default("LiteralStringExpression",{value:this.advance()})}enforestNumericLiteral(){let e=this.advance();return e.val()===1/0?new _terms2.default("LiteralInfinityExpression",{}):new _terms2.default("LiteralNumericExpression",{value:e})}enforestIdentifierExpression(){return new _terms2.default("IdentifierExpression",{name:this.advance()})}enforestRegularExpressionLiteral(){let e=this.advance(),r=e.token.value.lastIndexOf("/"),i=e.token.value.slice(1,r),o=e.token.value.slice(r+1);return new _terms2.default("LiteralRegExpExpression",{pattern:i,flags:o})}enforestNullLiteral(){return this.advance(),new _terms2.default("LiteralNullExpression",{})}enforestThisExpression(){return new _terms2.default("ThisExpression",{stx:this.advance()})}enforestArgumentList(){let e=[];for(;0<this.rest.size;){let r;this.isPunctuator(this.peek(),"...")?(this.advance(),r=new _terms2.default("SpreadElement",{expression:this.enforestExpressionLoop()})):r=this.enforestExpressionLoop(),0<this.rest.size&&this.matchPunctuator(","),e.push(r)}return(0,_immutable.List)(e)}enforestNewExpression(){if(this.matchKeyword("new"),this.isPunctuator(this.peek(),".")&&this.isIdentifier(this.peek(1),"target"))return this.advance(),this.advance(),new _terms2.default("NewTargetExpression",{});let r,e=this.enforestLeftHandSideExpression({allowCall:!1});return r=this.isParens(this.peek())?this.matchParens():(0,_immutable.List)(),new _terms2.default("NewExpression",{callee:e,arguments:r})}enforestComputedMemberExpression(){let e=new Enforester(this.matchSquares(),(0,_immutable.List)(),this.context);return new _terms2.default("ComputedMemberExpression",{object:this.term,expression:e.enforestExpression()})}transformDestructuring(e){switch(e.type){case"IdentifierExpression":return new _terms2.default("BindingIdentifier",{name:e.name});case"ParenthesizedExpression":return 1===e.inner.size&&this.isIdentifier(e.inner.get(0))?new _terms2.default("BindingIdentifier",{name:e.inner.get(0)}):e;case"DataProperty":return new _terms2.default("BindingPropertyProperty",{name:e.name,binding:this.transformDestructuringWithDefault(e.expression)});case"ShorthandProperty":return new _terms2.default("BindingPropertyIdentifier",{binding:new _terms2.default("BindingIdentifier",{name:e.name}),init:null});case"ObjectExpression":return new _terms2.default("ObjectBinding",{properties:e.properties.map(r=>this.transformDestructuring(r))});case"ArrayExpression":{let r=e.elements.last();return null!=r&&"SpreadElement"===r.type?new _terms2.default("ArrayBinding",{elements:e.elements.slice(0,-1).map(i=>i&&this.transformDestructuringWithDefault(i)),restElement:this.transformDestructuringWithDefault(r.expression)}):new _terms2.default("ArrayBinding",{elements:e.elements.map(i=>i&&this.transformDestructuringWithDefault(i)),restElement:null})}case"StaticPropertyName":return new _terms2.default("BindingIdentifier",{name:e.value});case"ComputedMemberExpression":case"StaticMemberExpression":case"ArrayBinding":case"BindingIdentifier":case"BindingPropertyIdentifier":case"BindingPropertyProperty":case"BindingWithDefault":case"ObjectBinding":return e;}(0,_errors.assert)(!1,"not implemented yet for "+e.type)}transformDestructuringWithDefault(e){switch(e.type){case"AssignmentExpression":return new _terms2.default("BindingWithDefault",{binding:this.transformDestructuring(e.binding),init:e.expression});}return this.transformDestructuring(e)}enforestCallExpression(){let e=this.advance();return new _terms2.default("CallExpression",{callee:this.term,arguments:e.inner()})}enforestArrowExpression(){let e;if(this.isIdentifier(this.peek()))e=new Enforester(_immutable.List.of(this.advance()),(0,_immutable.List)(),this.context);else{let o=this.matchParens();e=new Enforester(o,(0,_immutable.List)(),this.context)}let r=e.enforestFormalParameters();this.matchPunctuator("=>");let i;return this.isBraces(this.peek())?i=this.matchCurlies():(e=new Enforester(this.rest,(0,_immutable.List)(),this.context),i=e.enforestExpressionLoop(),this.rest=e.rest),new _terms2.default("ArrowExpression",{params:r,body:i})}enforestYieldExpression(){let e=this.matchKeyword("yield"),r=this.peek();if(0===this.rest.size||r&&!this.lineNumberEq(e,r))return new _terms2.default("YieldExpression",{expression:null});let i=!1;this.isPunctuator(this.peek(),"*")&&(i=!0,this.advance());let o=this.enforestExpression(),d=i?"YieldGeneratorExpression":"YieldExpression";return new _terms2.default(d,{expression:o})}enforestSyntaxTemplate(){return new _terms2.default("SyntaxTemplate",{template:this.advance()})}enforestSyntaxQuote(){let e=this.advance();return new _terms2.default("SyntaxQuote",{name:e,template:new _terms2.default("TemplateExpression",{tag:new _terms2.default("IdentifierExpression",{name:e}),elements:this.enforestTemplateElements()})})}enforestStaticMemberExpression(){let e=this.term;this.advance();let r=this.advance();return new _terms2.default("StaticMemberExpression",{object:e,property:r})}enforestArrayExpression(){let e=this.advance(),r=[],i=new Enforester(e.inner(),(0,_immutable.List)(),this.context);for(;0<i.rest.size;){let o=i.peek();if(i.isPunctuator(o,","))i.advance(),r.push(null);else if(i.isPunctuator(o,"...")){i.advance();let d=i.enforestExpressionLoop();if(null==d)throw i.createError(o,"expecting expression");r.push(new _terms2.default("SpreadElement",{expression:d}))}else{let d=i.enforestExpressionLoop();if(null==d)throw i.createError(o,"expected expression");r.push(d),i.consumeComma()}}return new _terms2.default("ArrayExpression",{elements:(0,_immutable.List)(r)})}enforestObjectExpression(){let e=this.advance(),r=(0,_immutable.List)(),i=new Enforester(e.inner(),(0,_immutable.List)(),this.context),o=null;for(;0<i.rest.size;){let d=i.enforestPropertyDefinition();if(i.consumeComma(),r=r.concat(d),o===d)throw i.createError(d,"invalid syntax in object");o=d}return new _terms2.default("ObjectExpression",{properties:r})}enforestPropertyDefinition(){var e=this.enforestMethodDefinition();let r=e.methodOrKey,i=e.kind;switch(i){case"method":return r;case"identifier":if(this.isAssign(this.peek())){this.advance();let d=this.enforestExpressionLoop();return new _terms2.default("BindingPropertyIdentifier",{init:d,binding:this.transformDestructuring(r)})}if(!this.isPunctuator(this.peek(),":"))return new _terms2.default("ShorthandProperty",{name:r.value});}this.matchPunctuator(":");let o=this.enforestExpressionLoop();return new _terms2.default("DataProperty",{name:r,expression:o})}enforestMethodDefinition(){let e=this.peek(),r=!1;if(this.isPunctuator(e,"*")&&(r=!0,this.advance()),this.isIdentifier(e,"get")&&this.isPropertyName(this.peek(1))){this.advance();var i=this.enforestPropertyName();let c=i.name;this.matchParens();let m=this.matchCurlies();return{methodOrKey:new _terms2.default("Getter",{name:c,body:m}),kind:"method"}}if(this.isIdentifier(e,"set")&&this.isPropertyName(this.peek(1))){this.advance();var o=this.enforestPropertyName();let c=o.name,m=new Enforester(this.matchParens(),(0,_immutable.List)(),this.context),u=m.enforestBindingElement(),l=this.matchCurlies();return{methodOrKey:new _terms2.default("Setter",{name:c,param:u,body:l}),kind:"method"}}var d=this.enforestPropertyName();let f=d.name;if(this.isParens(this.peek())){let c=this.matchParens(),m=new Enforester(c,(0,_immutable.List)(),this.context),u=m.enforestFormalParameters(),l=this.matchCurlies();return{methodOrKey:new _terms2.default("Method",{isGenerator:r,name:f,params:u,body:l}),kind:"method"}}return{methodOrKey:f,kind:this.isIdentifier(e)||this.isKeyword(e)?"identifier":"property"}}enforestPropertyName(){let e=this.peek();if(this.isStringLiteral(e)||this.isNumericLiteral(e))return{name:new _terms2.default("StaticPropertyName",{value:this.advance()}),binding:null};if(this.isBrackets(e)){let i=new Enforester(this.matchSquares(),(0,_immutable.List)(),this.context),o=i.enforestExpressionLoop();return{name:new _terms2.default("ComputedPropertyName",{expression:o}),binding:null}}let r=this.advance();return{name:new _terms2.default("StaticPropertyName",{value:r}),binding:new _terms2.default("BindingIdentifier",{name:r})}}enforestFunction(e){let r=e.isExpr,i=e.inDefault,o=null,d,f,c=!1,m=this.advance(),u=this.peek(),l=r?"FunctionExpression":"FunctionDeclaration";this.isPunctuator(u,"*")&&(c=!0,this.advance(),u=this.peek()),this.isParens(u)?i&&(o=new _terms2.default("BindingIdentifier",{name:_syntax2.default.fromIdentifier("*default*",m)})):o=this.enforestBindingIdentifier(),d=this.matchParens(),f=this.matchCurlies();let h=new Enforester(d,(0,_immutable.List)(),this.context),y=h.enforestFormalParameters();return new _terms2.default(l,{name:o,isGenerator:c,params:y,body:f})}enforestFunctionExpression(){let r,i,e=null,o=!1;this.advance();let d=this.peek();this.isPunctuator(d,"*")&&(o=!0,this.advance(),d=this.peek()),this.isParens(d)||(e=this.enforestBindingIdentifier()),r=this.matchParens(),i=this.matchCurlies();let f=new Enforester(r,(0,_immutable.List)(),this.context),c=f.enforestFormalParameters();return new _terms2.default("FunctionExpression",{name:e,isGenerator:o,params:c,body:i})}enforestFunctionDeclaration(){let e,r,i,o=!1;this.advance();let d=this.peek();this.isPunctuator(d,"*")&&(o=!0,this.advance()),e=this.enforestBindingIdentifier(),r=this.matchParens(),i=this.matchCurlies();let f=new Enforester(r,(0,_immutable.List)(),this.context),c=f.enforestFormalParameters();return new _terms2.default("FunctionDeclaration",{name:e,isGenerator:o,params:c,body:i})}enforestFormalParameters(){let e=[],r=null;for(;0!==this.rest.size;){let i=this.peek();if(this.isPunctuator(i,"...")){this.matchPunctuator("..."),r=this.enforestBindingIdentifier();break}e.push(this.enforestParam()),this.consumeComma()}return new _terms2.default("FormalParameters",{items:(0,_immutable.List)(e),rest:r})}enforestParam(){return this.enforestBindingElement()}enforestUpdateExpression(){let e=this.matchUnaryOperator();return new _terms2.default("UpdateExpression",{isPrefix:!1,operator:e.val(),operand:this.transformDestructuring(this.term)})}enforestUnaryExpression(){let e=this.matchUnaryOperator();return this.opCtx.stack=this.opCtx.stack.push({prec:this.opCtx.prec,combine:this.opCtx.combine}),this.opCtx.prec=14,this.opCtx.combine=r=>{return"++"===e.val()||"--"===e.val()?new _terms2.default("UpdateExpression",{operator:e.val(),operand:this.transformDestructuring(r),isPrefix:!0}):new _terms2.default("UnaryExpression",{operator:e.val(),operand:r})},EXPR_LOOP_OPERATOR}enforestConditionalExpression(){let e=this.opCtx.combine(this.term);if(0<this.opCtx.stack.size){var r=this.opCtx.stack.last();let f=r.prec,c=r.combine;this.opCtx.stack=this.opCtx.stack.pop(),this.opCtx.prec=f,this.opCtx.combine=c}this.matchPunctuator("?");let i=new Enforester(this.rest,(0,_immutable.List)(),this.context),o=i.enforestExpressionLoop();i.matchPunctuator(":"),i=new Enforester(i.rest,(0,_immutable.List)(),this.context);let d=i.enforestExpressionLoop();return this.rest=i.rest,new _terms2.default("ConditionalExpression",{test:e,consequent:o,alternate:d})}enforestBinaryExpression(){let e=this.term,r=this.peek(),i=r.val(),o=(0,_operators.getOperatorPrec)(i),d=(0,_operators.getOperatorAssoc)(i);if((0,_operators.operatorLt)(this.opCtx.prec,o,d))return this.opCtx.stack=this.opCtx.stack.push({prec:this.opCtx.prec,combine:this.opCtx.combine}),this.opCtx.prec=o,this.opCtx.combine=c=>{return new _terms2.default("BinaryExpression",{left:e,operator:r,right:c})},this.advance(),EXPR_LOOP_OPERATOR;let c=this.opCtx.combine(e);var f=this.opCtx.stack.last();let m=f.prec,u=f.combine;return this.opCtx.stack=this.opCtx.stack.pop(),this.opCtx.prec=m,this.opCtx.combine=u,c}enforestTemplateElements(){let e=this.matchTemplate(),r=e.token.items.map(i=>{if(this.isDelimiter(i)){let o=new Enforester(i.inner(),(0,_immutable.List)(),this.context);return o.enforest("expression")}return new _terms2.default("TemplateElement",{rawValue:i.slice.text})});return r}expandMacro(){for(let e=this.peek();this.isCompiletimeTransform(e);){let r=this.advance(),i=this.getFromCompiletimeEnvironment(r);if(null==i||"function"!=typeof i.value)throw this.createError(r,"the macro name was not bound to a value that could be invoked");let o=(0,_scope.freshScope)("u"),d=(0,_scope.freshScope)("i");this.context.useScope=o;let f=new _macroContext2.default(this,r,this.context,o,d),c=(0,_loadSyntax.sanitizeReplacementValues)(i.value.call(null,f));if(!_immutable.List.isList(c))throw this.createError(r,"macro must return a list but got: "+c);c=c.map(m=>{if(!(m&&"function"==typeof m.addScope))throw this.createError(r,"macro must return syntax objects or terms but got: "+m);return m.addScope(d,this.context.bindings,_syntax.ALL_PHASES,{flip:!0})}),this.rest=c.concat(f._rest(this)),e=this.peek()}}consumeSemicolon(){let e=this.peek();e&&this.isPunctuator(e,";")&&this.advance()}consumeComma(){let e=this.peek();e&&this.isPunctuator(e,",")&&this.advance()}safeCheck(e,r){let i=2>=arguments.length||arguments[2]===void 0?null:arguments[2];return e&&!("function"!=typeof e.match)&&e.match(r,i)}isTerm(e){return e&&e instanceof _terms2.default}isEOF(e){return this.safeCheck(e,"eof")}isIdentifier(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"identifier",r)}isPropertyName(e){return this.isIdentifier(e)||this.isKeyword(e)||this.isNumericLiteral(e)||this.isStringLiteral(e)||this.isBrackets(e)}isNumericLiteral(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"number",r)}isStringLiteral(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"string",r)}isTemplate(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"template",r)}isSyntaxTemplate(e){return this.safeCheck(e,"syntaxTemplate")}isBooleanLiteral(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"boolean",r)}isNullLiteral(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"null",r)}isRegularExpression(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"regularExpression",r)}isDelimiter(e){return this.safeCheck(e,"delimiter")}isParens(e){return this.safeCheck(e,"parens")}isBraces(e){return this.safeCheck(e,"braces")}isBrackets(e){return this.safeCheck(e,"brackets")}isAssign(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"assign",r)}isKeyword(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"keyword",r)}isPunctuator(e){let r=1>=arguments.length||arguments[1]===void 0?null:arguments[1];return this.safeCheck(e,"punctuator",r)}isOperator(e){return(this.safeCheck(e,"punctuator")||this.safeCheck(e,"identifier")||this.safeCheck(e,"keyword"))&&(0,_operators.isOperator)(e)}isUpdateOperator(e){return this.safeCheck(e,"punctuator","++")||this.safeCheck(e,"punctuator","--")}safeResolve(e,r){return e&&"function"==typeof e.resolve?Just(e.resolve(r)):Nothing()}isTransform(e,r){return this.safeResolve(e,this.context.phase).map(i=>this.context.env.get(i)===r||this.context.store.get(i)===r).getOrElse(!1)}isTransformInstance(e,r){return this.safeResolve(e,this.context.phase).map(i=>this.context.env.get(i)instanceof r||this.context.store.get(i)instanceof r).getOrElse(!1)}isFnDeclTransform(e){return this.isTransform(e,_transforms.FunctionDeclTransform)}isVarDeclTransform(e){return this.isTransform(e,_transforms.VariableDeclTransform)}isLetDeclTransform(e){return this.isTransform(e,_transforms.LetDeclTransform)}isConstDeclTransform(e){return this.isTransform(e,_transforms.ConstDeclTransform)}isSyntaxDeclTransform(e){return this.isTransform(e,_transforms.SyntaxDeclTransform)}isSyntaxrecDeclTransform(e){return this.isTransform(e,_transforms.SyntaxrecDeclTransform)}isSyntaxQuoteTransform(e){return this.isTransform(e,_transforms.SyntaxQuoteTransform)}isReturnStmtTransform(e){return this.isTransform(e,_transforms.ReturnStatementTransform)}isWhileTransform(e){return this.isTransform(e,_transforms.WhileTransform)}isForTransform(e){return this.isTransform(e,_transforms.ForTransform)}isSwitchTransform(e){return this.isTransform(e,_transforms.SwitchTransform)}isBreakTransform(e){return this.isTransform(e,_transforms.BreakTransform)}isContinueTransform(e){return this.isTransform(e,_transforms.ContinueTransform)}isDoTransform(e){return this.isTransform(e,_transforms.DoTransform)}isDebuggerTransform(e){return this.isTransform(e,_transforms.DebuggerTransform)}isWithTransform(e){return this.isTransform(e,_transforms.WithTransform)}isTryTransform(e){return this.isTransform(e,_transforms.TryTransform)}isThrowTransform(e){return this.isTransform(e,_transforms.ThrowTransform)}isIfTransform(e){return this.isTransform(e,_transforms.IfTransform)}isNewTransform(e){return this.isTransform(e,_transforms.NewTransform)}isCompiletimeTransform(e){return this.isTransformInstance(e,_transforms.CompiletimeTransform)}isVarBindingTransform(e){return this.isTransformInstance(e,_transforms.VarBindingTransform)}getFromCompiletimeEnvironment(e){return this.context.env.has(e.resolve(this.context.phase))?this.context.env.get(e.resolve(this.context.phase)):this.context.store.get(e.resolve(this.context.phase))}lineNumberEq(e,r){return e&&r&&e.lineNumber()===r.lineNumber()}matchIdentifier(e){let r=this.advance();if(this.isIdentifier(r,e))return r;throw this.createError(r,"expecting an identifier")}matchKeyword(e){let r=this.advance();if(this.isKeyword(r,e))return r;throw this.createError(r,"expecting "+e)}matchLiteral(){let e=this.advance();if(this.isNumericLiteral(e)||this.isStringLiteral(e)||this.isBooleanLiteral(e)||this.isNullLiteral(e)||this.isTemplate(e)||this.isRegularExpression(e))return e;throw this.createError(e,"expecting a literal")}matchStringLiteral(){let e=this.advance();if(this.isStringLiteral(e))return e;throw this.createError(e,"expecting a string literal")}matchTemplate(){let e=this.advance();if(this.isTemplate(e))return e;throw this.createError(e,"expecting a template literal")}matchParens(){let e=this.advance();if(this.isParens(e))return e.inner();throw this.createError(e,"expecting parens")}matchCurlies(){let e=this.advance();if(this.isBraces(e))return e.inner();throw this.createError(e,"expecting curly braces")}matchSquares(){let e=this.advance();if(this.isBrackets(e))return e.inner();throw this.createError(e,"expecting sqaure braces")}matchUnaryOperator(){let e=this.advance();if((0,_operators.isUnaryOperator)(e))return e;throw this.createError(e,"expecting a unary operator")}matchPunctuator(e){let r=this.advance();if(this.isPunctuator(r)){if("undefined"!=typeof e){if(r.val()===e)return r;throw this.createError(r,"expecting a "+e+" punctuator")}return r}throw this.createError(r,"expecting a punctuator")}createError(e,r){let i="",o=e;return i=0<this.rest.size?this.rest.slice(0,20).map(d=>{return this.isDelimiter(d)?d.inner():_immutable.List.of(d)}).flatten().map(d=>{return d===o?"__"+d.val()+"__":d.val()}).join(" "):o.toString(),new Error(r+"\n"+i)}}exports.Enforester=Enforester;

