'use strict';Object.defineProperty(exports,'__esModule',{value:!0}),exports.sanitizeReplacementValues=sanitizeReplacementValues,exports.evalRuntimeValues=evalRuntimeValues,exports.evalCompiletimeValue=evalCompiletimeValue;var _ramda=require('ramda'),_=_interopRequireWildcard(_ramda),_immutable=require('immutable'),_parseReducer=require('./parse-reducer.js'),_parseReducer2=_interopRequireDefault(_parseReducer),_shiftReducer=require('shift-reducer'),_shiftReducer2=_interopRequireDefault(_shiftReducer),_serializer=require('./serializer'),_syntax=require('./syntax'),_syntax2=_interopRequireDefault(_syntax),_shiftCodegen=require('shift-codegen'),_shiftCodegen2=_interopRequireDefault(_shiftCodegen),_terms=require('./terms'),_terms2=_interopRequireDefault(_terms),_shiftReader=require('./shift-reader'),_shiftReader2=_interopRequireDefault(_shiftReader),_macroContext=require('./macro-context'),_templateProcessor=require('./template-processor'),_vm=require('vm'),_vm2=_interopRequireDefault(_vm);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b.default=a,b}function sanitizeReplacementValues(a){if(Array.isArray(a))return sanitizeReplacementValues((0,_immutable.List)(a));if(_immutable.List.isList(a))return a.map(sanitizeReplacementValues);if(null==a)throw new Error('replacement values for syntax template must not be null or undefined');else if('function'==typeof a.next)return sanitizeReplacementValues((0,_immutable.List)(a));return(0,_macroContext.unwrap)(a)}function evalRuntimeValues(a,b){let c=a.reduce((h,i)=>{if((0,_terms.isExport)(i)){if((0,_terms.isVariableDeclaration)(i.declaration))return h.concat(new _terms2.default('VariableDeclarationStatement',{declaration:i.declaration})).concat(i.declaration.declarators.map(j=>{return new _terms2.default('ExpressionStatement',{expression:new _terms2.default('AssignmentExpression',{binding:new _terms2.default('StaticMemberExpression',{object:new _terms2.default('IdentifierExpression',{name:_syntax2.default.fromIdentifier('exports')}),property:j.binding.name}),expression:new _terms2.default('IdentifierExpression',{name:j.binding.name})})})}));}else if((0,_terms.isImport)(i))return h;return h.concat(i)},(0,_immutable.List)()),d=(0,_shiftReducer2.default)(new _parseReducer2.default(b,!1),new _terms2.default('Module',{directives:(0,_immutable.List)(),items:c}).gen(!1)),e=(0,_shiftCodegen2.default)(d,new _shiftCodegen.FormattedCodeGen),f=b.transform(e,{babelrc:!0,filename:b.filename}),g={};return b.store.set('exports',g),_vm2.default.runInContext(f.code,b.store.getNodeContext()),g}function evalCompiletimeValue(a,b){let c=(0,_serializer.makeDeserializer)(b.bindings),d={syntaxQuote:function(m){for(var n=arguments.length,o=Array(1<n?n-1:0),p=1;p<n;p++)o[p-1]=arguments[p];let q=c.read(_.last(o)),r=new _shiftReader2.default(m,q,_.take(o.length-1,o));return r.read()},syntaxTemplate:function(m){for(var n=arguments.length,o=Array(1<n?n-1:0),p=1;p<n;p++)o[p-1]=arguments[p];return(0,_templateProcessor.replaceTemplate)(c.read(m),sanitizeReplacementValues(o))}},e=(0,_immutable.List)(Object.keys(d)),f=e.map(l=>d[l]).toArray(),g=(0,_shiftReducer2.default)(new _parseReducer2.default(b),new _terms2.default('Module',{directives:(0,_immutable.List)(),items:_immutable.List.of(new _terms2.default('ExpressionStatement',{expression:new _terms2.default('FunctionExpression',{isGenerator:!1,name:null,params:new _terms2.default('FormalParameters',{items:e.map(l=>{return new _terms2.default('BindingIdentifier',{name:_syntax2.default.from('identifier',l)})}),rest:null}),body:new _terms2.default('FunctionBody',{directives:_immutable.List.of(new _terms2.default('Directive',{rawValue:'use strict'})),statements:_immutable.List.of(new _terms2.default('ReturnStatement',{expression:a}))})})}))})),h=(0,_shiftCodegen2.default)(g,new _shiftCodegen.FormattedCodeGen),i=b.transform(h,{babelrc:!0,filename:b.filename}),j=_vm2.default.runInContext(i.code,b.store.getNodeContext());return j.apply(void 0,f)}

