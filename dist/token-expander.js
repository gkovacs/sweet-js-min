'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _sweetSpec = require('sweet-spec');

var S = _interopRequireWildcard(_sweetSpec);

var _immutable = require('immutable');

var _enforester = require('./enforester');

var _termExpander = require('./term-expander.js');

var _termExpander2 = _interopRequireDefault(_termExpander);

var _env = require('./env');

var _env2 = _interopRequireDefault(_env);

var _ramda = require('ramda');

var _ = _interopRequireWildcard(_ramda);

var _terms = require('./terms');

var T = _interopRequireWildcard(_terms);

var _symbol = require('./symbol');

var _transforms = require('./transforms');

var _loadSyntax = require('./load-syntax');

var _scope = require('./scope');

var _syntax = require('./syntax');

var _astDispatcher = require('./ast-dispatcher');

var _astDispatcher2 = _interopRequireDefault(_astDispatcher);

var _syntax2 = require('./syntax.js');

var _syntax3 = _interopRequireDefault(_syntax2);

var _scopeReducer = require('./scope-reducer');

var _scopeReducer2 = _interopRequireDefault(_scopeReducer);

var _moduleVisitor = require('./module-visitor');

var _moduleVisitor2 = _interopRequireDefault(_moduleVisitor);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

class RegisterBindingsReducer extends S.default.CloneReducer {

  constructor(useScope, phase, skipDup, bindings, env) {
    super();
    this.useScope = useScope;
    this.phase = phase;
    this.bindings = bindings;
    this.skipDup = skipDup;
    this.env = env;
  }

  reduceBindingIdentifier(t, s) {
    let newName = s.name.removeScope(this.useScope, this.phase);
    let newBinding = (0, _symbol.gensym)(newName.val());
    this.bindings.add(newName, {
      binding: newBinding,
      phase: this.phase,
      skipDup: this.skipDup
    });
    this.env.set(newBinding.toString(), new _transforms.VarBindingTransform(newName));
    return t.extend({
      name: newName
    });
  }
}

class RegisterSyntaxBindingsReducer extends S.default.CloneReducer {

  constructor(useScope, phase, bindings, env, val) {
    super();
    this.useScope = useScope;
    this.phase = phase;
    this.bindings = bindings;
    this.env = env;
    this.val = val;
  }

  reduceBindingIdentifier(t, s) {
    let newName = s.name.removeScope(this.useScope, this.phase);
    let newBinding = (0, _symbol.gensym)(newName.val());
    this.bindings.add(newName, {
      binding: newBinding,
      phase: this.phase,
      skipDup: false
    });
    let resolvedName = newName.resolve(this.phase);
    this.env.set(resolvedName, new _transforms.CompiletimeTransform(this.val));
    return t.extend({
      name: newName
    });
  }
}

class TokenExpander extends _astDispatcher2.default {
  constructor(context) {
    super('expand', false);
    this.context = context;
  }

  expand(stxl) {
    let result = [];
    if (stxl.size === 0) {
      return (0, _immutable.List)(result);
    }
    let prev = (0, _immutable.List)();
    let enf = new _enforester.Enforester(stxl, prev, this.context);

    while (!enf.done) {
      result.push(this.dispatch(enf.enforest()));
    }

    return (0, _immutable.List)(result);
  }

  expandVariableDeclarationStatement(term) {
    return term.extend({
      declaration: this.registerVariableDeclaration(term.declaration)
    });
  }

  expandFunctionDeclaration(term) {
    return this.registerFunctionOrClass(term);
  }

  // TODO: think about function expressions

  registerImport(term) {
    let path = term.moduleSpecifier.val();
    let mod;
    let visitor = new _moduleVisitor2.default(this.context);
    if (term.forSyntax) {
      mod = this.context.loader.get(path, this.context.phase + 1, this.context.cwd);
      this.context.store = visitor.visit(mod, this.context.phase + 1, this.context.store);
      this.context.store = visitor.invoke(mod, this.context.phase + 1, this.context.store);
    } else {
      mod = this.context.loader.get(path, this.context.phase, this.context.cwd);
      this.context.store = visitor.visit(mod, this.context.phase, this.context.store);
    }
    (0, _moduleVisitor.bindImports)(term, mod, this.context.phase, this.context);
    return term;
  }

  expandImport(term) {
    return this.registerImport(term);
  }

  expandImportNamespace(term) {
    return this.registerImport(term);
  }

  expandExport(term) {
    if (T.isFunctionDeclaration(term.declaration) || T.isClassDeclaration(term.declaration)) {
      return term.extend({
        declaration: this.registerFunctionOrClass(term.declaration)
      });
    } else if (T.isVariableDeclaration(term.declaration)) {
      return term.extend({
        declaration: this.registerVariableDeclaration(term.declaration)
      });
    }
    return term;
  }

  registerFunctionOrClass(term) {
    let red = new RegisterBindingsReducer(this.context.useScope, this.context.phase, false, this.context.bindings, this.context.env);
    return term.extend({
      name: term.name.reduce(red)
    });
  }

  registerVariableDeclaration(term) {
    if (term.kind === 'syntax' || term.kind === 'syntaxrec') {
      return this.registerSyntaxDeclaration(term);
    }
    let red = new RegisterBindingsReducer(this.context.useScope, this.context.phase, term.kind === 'var', this.context.bindings, this.context.env);
    return term.extend({
      declarators: term.declarators.map(decl => {
        return decl.extend({
          binding: decl.binding.reduce(red)
        });
      })
    });
  }

  registerSyntaxDeclaration(term) {
    if (term.kind === 'syntax') {
      // syntax id^{a, b} = <init>^{a, b}
      // ->
      // syntaxrec id^{a,b,c} = function() { return <<id^{a}>> }
      // syntaxrec id^{a,b} = <init>^{a,b,c}
      let scope = (0, _scope.freshScope)('nonrec');
      let scopeReducer = new _scopeReducer2.default([{ scope: scope, phase: _syntax.ALL_PHASES, flip: false }], this.context.bindings);
      term = term.extend({
        declarators: term.declarators.map(decl => {
          let name = decl.binding.name;
          let nameAdded = name.addScope(scope, this.context.bindings, _syntax.ALL_PHASES);
          let nameRemoved = name.removeScope(this.context.currentScope[this.context.currentScope.length - 1], this.context.phase);
          let newBinding = (0, _symbol.gensym)(name.val());
          this.context.bindings.addForward(nameAdded, nameRemoved, newBinding, this.context.phase);
          return decl.extend({
            init: decl.init.reduce(scopeReducer)
          });
        })
      });
    }
    // for syntax declarations we need to load the compiletime value
    // into the environment
    return term.extend({
      declarators: term.declarators.map(decl => {
        // each compiletime value needs to be expanded with a fresh
        // environment and in the next higher phase
        let syntaxExpander = new _termExpander2.default(_.merge(this.context, {
          phase: this.context.phase + 1,
          env: new _env2.default(),
          store: this.context.store
        }));

        let init = syntaxExpander.expand(decl.init);
        let val = (0, _loadSyntax.evalCompiletimeValue)(init, _.merge(this.context, {
          phase: this.context.phase + 1
        }));
        let red = new RegisterSyntaxBindingsReducer(this.context.useScope, this.context.phase, this.context.bindings, this.context.env, val);
        return decl.extend({ binding: decl.binding.reduce(red), init });
      })
    });
  }

  // registerSyntaxDeclarator(term) {
  //
  // }
}
exports.default = TokenExpander;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90b2tlbi1leHBhbmRlci5qcyJdLCJuYW1lcyI6WyJTIiwiXyIsIlQiLCJSZWdpc3RlckJpbmRpbmdzUmVkdWNlciIsIkNsb25lUmVkdWNlciIsImNvbnN0cnVjdG9yIiwidXNlU2NvcGUiLCJwaGFzZSIsInNraXBEdXAiLCJiaW5kaW5ncyIsImVudiIsInJlZHVjZUJpbmRpbmdJZGVudGlmaWVyIiwidCIsInMiLCJuZXdOYW1lIiwibmFtZSIsInJlbW92ZVNjb3BlIiwibmV3QmluZGluZyIsInZhbCIsImFkZCIsImJpbmRpbmciLCJzZXQiLCJ0b1N0cmluZyIsImV4dGVuZCIsIlJlZ2lzdGVyU3ludGF4QmluZGluZ3NSZWR1Y2VyIiwicmVzb2x2ZWROYW1lIiwicmVzb2x2ZSIsIlRva2VuRXhwYW5kZXIiLCJjb250ZXh0IiwiZXhwYW5kIiwic3R4bCIsInJlc3VsdCIsInNpemUiLCJwcmV2IiwiZW5mIiwiZG9uZSIsInB1c2giLCJkaXNwYXRjaCIsImVuZm9yZXN0IiwiZXhwYW5kVmFyaWFibGVEZWNsYXJhdGlvblN0YXRlbWVudCIsInRlcm0iLCJkZWNsYXJhdGlvbiIsInJlZ2lzdGVyVmFyaWFibGVEZWNsYXJhdGlvbiIsImV4cGFuZEZ1bmN0aW9uRGVjbGFyYXRpb24iLCJyZWdpc3RlckZ1bmN0aW9uT3JDbGFzcyIsInJlZ2lzdGVySW1wb3J0IiwicGF0aCIsIm1vZHVsZVNwZWNpZmllciIsIm1vZCIsInZpc2l0b3IiLCJmb3JTeW50YXgiLCJsb2FkZXIiLCJnZXQiLCJjd2QiLCJzdG9yZSIsInZpc2l0IiwiaW52b2tlIiwiZXhwYW5kSW1wb3J0IiwiZXhwYW5kSW1wb3J0TmFtZXNwYWNlIiwiZXhwYW5kRXhwb3J0IiwiaXNGdW5jdGlvbkRlY2xhcmF0aW9uIiwiaXNDbGFzc0RlY2xhcmF0aW9uIiwiaXNWYXJpYWJsZURlY2xhcmF0aW9uIiwicmVkIiwicmVkdWNlIiwia2luZCIsInJlZ2lzdGVyU3ludGF4RGVjbGFyYXRpb24iLCJkZWNsYXJhdG9ycyIsIm1hcCIsImRlY2wiLCJzY29wZSIsInNjb3BlUmVkdWNlciIsImZsaXAiLCJuYW1lQWRkZWQiLCJhZGRTY29wZSIsIm5hbWVSZW1vdmVkIiwiY3VycmVudFNjb3BlIiwibGVuZ3RoIiwiYWRkRm9yd2FyZCIsImluaXQiLCJzeW50YXhFeHBhbmRlciIsIm1lcmdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQTs7SUFBa0JBLEM7O0FBQ2xCOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7SUFBWUMsQzs7QUFDWjs7SUFBWUMsQzs7QUFDWjs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7Ozs7QUFHQSxNQUFNQyx1QkFBTixTQWxCa0JILENBa0JvQixTQUFLSSxZQUEzQyxDQUF3RDs7QUFPdERDLGNBQVlDLFFBQVosRUFBMkJDLEtBQTNCLEVBQTBDQyxPQUExQyxFQUE0REMsUUFBNUQsRUFBMkVDLEdBQTNFLEVBQXFGO0FBQ25GO0FBQ0EsU0FBS0osUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxLQUFMLEdBQWFBLEtBQWI7QUFDQSxTQUFLRSxRQUFMLEdBQWdCQSxRQUFoQjtBQUNBLFNBQUtELE9BQUwsR0FBZUEsT0FBZjtBQUNBLFNBQUtFLEdBQUwsR0FBV0EsR0FBWDtBQUNEOztBQUVEQywwQkFBd0JDLENBQXhCLEVBQWlDQyxDQUFqQyxFQUFzRDtBQUNwRCxRQUFJQyxVQUFVRCxFQUFFRSxJQUFGLENBQU9DLFdBQVAsQ0FBbUIsS0FBS1YsUUFBeEIsRUFBa0MsS0FBS0MsS0FBdkMsQ0FBZDtBQUNBLFFBQUlVLGFBQWEsb0JBQU9ILFFBQVFJLEdBQVIsRUFBUCxDQUFqQjtBQUNBLFNBQUtULFFBQUwsQ0FBY1UsR0FBZCxDQUFrQkwsT0FBbEIsRUFBMkI7QUFDekJNLGVBQVNILFVBRGdCO0FBRXpCVixhQUFPLEtBQUtBLEtBRmE7QUFHekJDLGVBQVMsS0FBS0E7QUFIVyxLQUEzQjtBQUtBLFNBQUtFLEdBQUwsQ0FB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QUFZLEVBQUVILFNBQVNpRCxLQUFLakQsT0FBTCxDQUFhNEMsTUFBYixDQUFvQkQsR0FBcEIsQ0FBWCxFQUFxQ2dCLElBQXJDLEVBQVosQ0FBUDtBQUNELE9BcEJZO0FBREksS0FBWixDQUFQO0FBdUJEOztBQUVEO0FBQ0E7QUFDQTtBQXpKdUQ7a0JBQXBDcEQsYSIsImZpbGUiOiJ0b2tlbi1leHBhbmRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5pbXBvcnQgVGVybSwgKiBhcyBTIGZyb20gJ3N3ZWV0LXNwZWMnO1xuaW1wb3J0IHsgTGlzdCB9IGZyb20gJ2ltbXV0YWJsZSc7XG5pbXBvcnQgeyAgRW5mb3Jlc3RlciB9IGZyb20gJy4vZW5mb3Jlc3Rlcic7XG5pbXBvcnQgVGVybUV4cGFuZGVyIGZyb20gJy4vdGVybS1leHBhbmRlci5qcyc7XG5pbXBvcnQgRW52IGZyb20gJy4vZW52JztcbmltcG9ydCAqIGFzIF8gZnJvbSAncmFtZGEnO1xuaW1wb3J0ICogYXMgVCBmcm9tICcuL3Rlcm1zJztcbmltcG9ydCB7IGdlbnN5bSB9IGZyb20gJy4vc3ltYm9sJztcbmltcG9ydCB7IFZhckJpbmRpbmdUcmFuc2Zvcm0sIENvbXBpbGV0aW1lVHJhbnNmb3JtIH0gZnJvbSAnLi90cmFuc2Zvcm1zJztcbmltcG9ydCB7IGV2YWxDb21waWxldGltZVZhbHVlIH0gZnJvbSAnLi9sb2FkLXN5bnRheCc7XG5pbXBvcnQgeyAgZnJlc2hTY29wZSB9IGZyb20gJy4vc2NvcGUnO1xuaW1wb3J0IHsgQUxMX1BIQVNFUyB9IGZyb20gJy4vc3ludGF4JztcbmltcG9ydCBBU1REaXNwYXRjaGVyIGZyb20gJy4vYXN0LWRpc3BhdGNoZXInO1xuaW1wb3J0IFN5bnRheCBmcm9tICcuL3N5bnRheC5qcyc7XG5pbXBvcnQgU2NvcGVSZWR1Y2VyIGZyb20gJy4vc2NvcGUtcmVkdWNlcic7XG5pbXBvcnQgTW9kdWxlVmlzaXRvciwgeyBiaW5kSW1wb3J0cyB9IGZyb20gJy4vbW9kdWxlLXZpc2l0b3InO1xuXG5cbmNsYXNzIFJlZ2lzdGVyQmluZGluZ3NSZWR1Y2VyIGV4dGVuZHMgVGVybS5DbG9uZVJlZHVjZXIge1xuICB1c2VTY29wZTogYW55O1xuICBwaGFzZTogbnVtYmVyO1xuICBiaW5kaW5nczogYW55O1xuICBza2lwRHVwOiBib29sZWFuO1xuICBlbnY6IEVudjtcblxuICBjb25zdHJ1Y3Rvcih1c2VTY29wZTogYW55LCBwaGFzZTogbnVtYmVyLCBza2lwRHVwOiBib29sZWFuLCBiaW5kaW5nczogYW55LCBlbnY6IEVudikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy51c2VTY29wZSA9IHVzZVNjb3BlO1xuICAgIHRoaXMucGhhc2UgPSBwaGFzZTtcbiAgICB0aGlzLmJpbmRpbmdzID0gYmluZGluZ3M7XG4gICAgdGhpcy5za2lwRHVwID0gc2tpcER1cDtcbiAgICB0aGlzLmVudiA9IGVudjtcbiAgfVxuXG4gIHJlZHVjZUJpbmRpbmdJZGVudGlmaWVyKHQ6IFRlcm0sIHM6IHsgbmFtZTogU3ludGF4IH0pIHtcbiAgICBsZXQgbmV3TmFtZSA9IHMubmFtZS5yZW1vdmVTY29wZSh0aGlzLnVzZVNjb3BlLCB0aGlzLnBoYXNlKTtcbiAgICBsZXQgbmV3QmluZGluZyA9IGdlbnN5bShuZXdOYW1lLnZhbCgpKTtcbiAgICB0aGlzLmJpbmRpbmdzLmFkZChuZXdOYW1lLCB7XG4gICAgICBiaW5kaW5nOiBuZXdCaW5kaW5nLFxuICAgICAgcGhhc2U6IHRoaXMucGhhc2UsXG4gICAgICBza2lwRHVwOiB0aGlzLnNraXBEdXBcbiAgICB9KTtcbiAgICB0aGlzLmVudi5zZXQobmV3QmluZGluZy50b1N0cmluZygpLCBuZXcgVmFyQmluZGluZ1RyYW5zZm9ybShuZXdOYW1lKSk7XG4gICAgcmV0dXJuIHQuZXh0ZW5kKHtcbiAgICAgIG5hbWU6IG5ld05hbWVcbiAgICB9KTtcbiAgfVxufVxuXG5jbGFzcyBSZWdpc3RlclN5bnRheEJpbmRpbmdzUmVkdWNlciBleHRlbmRzIFRlcm0uQ2xvbmVSZWR1Y2VyIHtcbiAgdXNlU2NvcGU6IGFueTtcbiAgcGhhc2U6IG51bWJlcjtcbiAgYmluZGluZ3M6IGFueTtcbiAgZW52OiBFbnY7XG4gIHZhbDogYW55O1xuXG4gIGNvbnN0cnVjdG9yKHVzZVNjb3BlOiBhbnksIHBoYXNlOiBudW1iZXIsIGJpbmRpbmdzOiBhbnksIGVudjogRW52LCB2YWw6IGFueSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy51c2VTY29wZSA9IHVzZVNjb3BlO1xuICAgIHRoaXMucGhhc2UgPSBwaGFzZTtcbiAgICB0aGlzLmJpbmRpbmdzID0gYmluZGluZ3M7XG4gICAgdGhpcy5lbnYgPSBlbnY7XG4gICAgdGhpcy52YWwgPSB2YWw7XG4gIH1cblxuICByZWR1Y2VCaW5kaW5nSWRlbnRpZmllcih0OiBUZXJtLCBzOiB7IG5hbWU6IFN5bnRheCB9KSB7XG4gICAgbGV0IG5ld05hbWUgPSBzLm5hbWUucmVtb3ZlU2NvcGUodGhpcy51c2VTY29wZSwgdGhpcy5waGFzZSk7XG4gICAgbGV0IG5ld0JpbmRpbmcgPSBnZW5zeW0obmV3TmFtZS52YWwoKSk7XG4gICAgdGhpcy5iaW5kaW5ncy5hZGQobmV3TmFtZSwge1xuICAgICAgYmluZGluZzogbmV3QmluZGluZyxcbiAgICAgIHBoYXNlOiB0aGlzLnBoYXNlLFxuICAgICAgc2tpcER1cDogZmFsc2VcbiAgICB9KTtcbiAgICBsZXQgcmVzb2x2ZWROYW1lID0gbmV3TmFtZS5yZXNvbHZlKHRoaXMucGhhc2UpO1xuICAgIHRoaXMuZW52LnNldChyZXNvbHZlZE5hbWUsIG5ldyBDb21waWxldGltZVRyYW5zZm9ybSh0aGlzLnZhbCkpO1xuICAgIHJldHVybiB0LmV4dGVuZCh7XG4gICAgICBuYW1lOiBuZXdOYW1lXG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVG9rZW5FeHBhbmRlciBleHRlbmRzIEFTVERpc3BhdGNoZXIge1xuICBjb25zdHJ1Y3Rvcihjb250ZXh0OiBhbnkpIHtcbiAgICBzdXBlcignZXhwYW5kJywgZmFsc2UpO1xuICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XG4gIH1cblxuICBleHBhbmQoc3R4bDogTGlzdDxTeW50YXg+KSB7XG4gICAgbGV0IHJlc3VsdCA9IFtdO1xuICAgIGlmIChzdHhsLnNpemUgPT09IDApIHtcbiAgICAgIHJldHVybiBMaXN0KHJlc3VsdCk7XG4gICAgfVxuICAgIGxldCBwcmV2ID0gTGlzdCgpO1xuICAgIGxldCBlbmYgPSBuZXcgRW5mb3Jlc3RlcihzdHhsLCBwcmV2LCB0aGlzLmNvbnRleHQpO1xuXG4gICAgd2hpbGUgKCFlbmYuZG9uZSkge1xuICAgICAgcmVzdWx0LnB1c2godGhpcy5kaXNwYXRjaChlbmYuZW5mb3Jlc3QoKSkpO1xuICAgIH1cblxuICAgIHJldHVybiBMaXN0KHJlc3VsdCk7XG4gIH1cblxuICBleHBhbmRWYXJpYWJsZURlY2xhcmF0aW9uU3RhdGVtZW50KHRlcm06IFMuVmFyaWFibGVEZWNsYXJhdGlvblN0YXRlbWVudCkge1xuICAgIHJldHVybiB0ZXJtLmV4dGVuZCh7XG4gICAgICBkZWNsYXJhdGlvbjogdGhpcy5yZWdpc3RlclZhcmlhYmxlRGVjbGFyYXRpb24odGVybS5kZWNsYXJhdGlvbilcbiAgICB9KTtcbiAgfVxuXG4gIGV4cGFuZEZ1bmN0aW9uRGVjbGFyYXRpb24odGVybTogVGVybSkge1xuICAgIHJldHVybiB0aGlzLnJlZ2lzdGVyRnVuY3Rpb25PckNsYXNzKHRlcm0pO1xuICB9XG5cbiAgLy8gVE9ETzogdGhpbmsgYWJvdXQgZnVuY3Rpb24gZXhwcmVzc2lvbnNcblxuICByZWdpc3RlckltcG9ydCh0ZXJtOiBTLkltcG9ydCB8IFMuSW1wb3J0TmFtZXNwYWNlKSB7XG4gICAgbGV0IHBhdGggPSB0ZXJtLm1vZHVsZVNwZWNpZmllci52YWwoKTtcbiAgICBsZXQgbW9kO1xuICAgIGxldCB2aXNpdG9yID0gbmV3IE1vZHVsZVZpc2l0b3IodGhpcy5jb250ZXh0KTtcbiAgICBpZiAodGVybS5mb3JTeW50YXgpIHtcbiAgICAgIG1vZCA9IHRoaXMuY29udGV4dC5sb2FkZXIuZ2V0KHBhdGgsIHRoaXMuY29udGV4dC5waGFzZSArIDEsIHRoaXMuY29udGV4dC5jd2QpO1xuICAgICAgdGhpcy5jb250ZXh0LnN0b3JlID0gdmlzaXRvci52aXNpdChtb2QsIHRoaXMuY29udGV4dC5waGFzZSArIDEsIHRoaXMuY29udGV4dC5zdG9yZSk7XG4gICAgICB0aGlzLmNvbnRleHQuc3RvcmUgPSB2aXNpdG9yLmludm9rZShtb2QsIHRoaXMuY29udGV4dC5waGFzZSArIDEsIHRoaXMuY29udGV4dC5zdG9yZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG1vZCA9IHRoaXMuY29udGV4dC5sb2FkZXIuZ2V0KHBhdGgsIHRoaXMuY29udGV4dC5waGFzZSwgdGhpcy5jb250ZXh0LmN3ZCk7XG4gICAgICB0aGlzLmNvbnRleHQuc3RvcmUgPSB2aXNpdG9yLnZpc2l0KG1vZCwgdGhpcy5jb250ZXh0LnBoYXNlLCB0aGlzLmNvbnRleHQuc3RvcmUpO1xuICAgIH1cbiAgICBiaW5kSW1wb3J0cyh0ZXJtLCBtb2QsIHRoaXMuY29udGV4dC5waGFzZSwgdGhpcy5jb250ZXh0KTtcbiAgICByZXR1cm4gdGVybTtcbiAgfVxuXG4gIGV4cGFuZEltcG9ydCh0ZXJtOiBTLkltcG9ydCkge1xuICAgIHJldHVybiB0aGlzLnJlZ2lzdGVySW1wb3J0KHRlcm0pO1xuICB9XG5cbiAgZXhwYW5kSW1wb3J0TmFtZXNwYWNlKHRlcm06IFMuSW1wb3J0TmFtZXNwYWNlKSB7XG4gICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJJbXBvcnQodGVybSk7XG4gIH1cblxuICBleHBhbmRFeHBvcnQodGVybTogVGVybSkge1xuICAgIGlmIChULmlzRnVuY3Rpb25EZWNsYXJhdGlvbih0ZXJtLmRlY2xhcmF0aW9uKSB8fCBULmlzQ2xhc3NEZWNsYXJhdGlvbih0ZXJtLmRlY2xhcmF0aW9uKSkge1xuICAgICAgcmV0dXJuIHRlcm0uZXh0ZW5kKHtcbiAgICAgICAgZGVjbGFyYXRpb246IHRoaXMucmVnaXN0ZXJGdW5jdGlvbk9yQ2xhc3ModGVybS5kZWNsYXJhdGlvbilcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoVC5pc1ZhcmlhYmxlRGVjbGFyYXRpb24odGVybS5kZWNsYXJhdGlvbikpIHtcbiAgICAgIHJldHVybiB0ZXJtLmV4dGVuZCh7XG4gICAgICAgIGRlY2xhcmF0aW9uOiB0aGlzLnJlZ2lzdGVyVmFyaWFibGVEZWNsYXJhdGlvbih0ZXJtLmRlY2xhcmF0aW9uKVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB0ZXJtO1xuICB9XG5cbiAgcmVnaXN0ZXJGdW5jdGlvbk9yQ2xhc3ModGVybTogVGVybSkge1xuICAgIGxldCByZWQgPSBuZXcgUmVnaXN0ZXJCaW5kaW5nc1JlZHVjZXIoXG4gICAgICB0aGlzLmNvbnRleHQudXNlU2NvcGUsXG4gICAgICB0aGlzLmNvbnRleHQucGhhc2UsXG4gICAgICBmYWxzZSxcbiAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncyxcbiAgICAgIHRoaXMuY29udGV4dC5lbnZcbiAgICApO1xuICAgIHJldHVybiB0ZXJtLmV4dGVuZCh7XG4gICAgICBuYW1lOiB0ZXJtLm5hbWUucmVkdWNlKHJlZClcbiAgICB9KTtcbiAgfVxuXG4gIHJlZ2lzdGVyVmFyaWFibGVEZWNsYXJhdGlvbih0ZXJtOiBUZXJtKSB7XG4gICAgaWYgKHRlcm0ua2luZCA9PT0gJ3N5bnRheCcgfHwgdGVybS5raW5kID09PSAnc3ludGF4cmVjJykge1xuICAgICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJTeW50YXhEZWNsYXJhdGlvbih0ZXJtKTtcbiAgICB9XG4gICAgbGV0IHJlZCA9IG5ldyBSZWdpc3RlckJpbmRpbmdzUmVkdWNlcihcbiAgICAgIHRoaXMuY29udGV4dC51c2VTY29wZSxcbiAgICAgIHRoaXMuY29udGV4dC5waGFzZSxcbiAgICAgIHRlcm0ua2luZCA9PT0gJ3ZhcicsXG4gICAgICB0aGlzLmNvbnRleHQuYmluZGluZ3MsXG4gICAgICB0aGlzLmNvbnRleHQuZW52XG4gICAgKTtcbiAgICByZXR1cm4gdGVybS5leHRlbmQoe1xuICAgICAgZGVjbGFyYXRvcnM6IHRlcm0uZGVjbGFyYXRvcnMubWFwKGRlY2wgPT4ge1xuICAgICAgICByZXR1cm4gZGVjbC5leHRlbmQoe1xuICAgICAgICAgIGJpbmRpbmc6IGRlY2wuYmluZGluZy5yZWR1Y2UocmVkKVxuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgfSk7XG4gIH1cblxuICByZWdpc3RlclN5bnRheERlY2xhcmF0aW9uKHRlcm06IFRlcm0pIHtcbiAgICBpZiAodGVybS5raW5kID09PSAnc3ludGF4Jykge1xuICAgICAgLy8gc3ludGF4IGlkXnthLCBifSA9IDxpbml0Pl57YSwgYn1cbiAgICAgIC8vIC0+XG4gICAgICAvLyBzeW50YXhyZWMgaWRee2EsYixjfSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gPDxpZF57YX0+PiB9XG4gICAgICAvLyBzeW50YXhyZWMgaWRee2EsYn0gPSA8aW5pdD5ee2EsYixjfVxuICAgICAgbGV0IHNjb3BlID0gZnJlc2hTY29wZSgnbm9ucmVjJyk7XG4gICAgICBsZXQgc2NvcGVSZWR1Y2VyID0gbmV3IFNjb3BlUmVkdWNlcihbeyBzY29wZTogc2NvcGUsIHBoYXNlOiBBTExfUEhBU0VTLCBmbGlwOiBmYWxzZSB9XSwgdGhpcy5jb250ZXh0LmJpbmRpbmdzKTtcbiAgICAgIHRlcm0gPSB0ZXJtLmV4dGVuZCh7XG4gICAgICAgIGRlY2xhcmF0b3JzOiB0ZXJtLmRlY2xhcmF0b3JzLm1hcChkZWNsID0+IHtcbiAgICAgICAgICBsZXQgbmFtZSA9IGRlY2wuYmluZGluZy5uYW1lO1xuICAgICAgICAgIGxldCBuYW1lQWRkZWQgPSBuYW1lLmFkZFNjb3BlKHNjb3BlLCB0aGlzLmNvbnRleHQuYmluZGluZ3MsIEFMTF9QSEFTRVMpO1xuICAgICAgICAgIGxldCBuYW1lUmVtb3ZlZCA9IG5hbWUucmVtb3ZlU2NvcGUodGhpcy5jb250ZXh0LmN1cnJlbnRTY29wZVt0aGlzLmNvbnRleHQuY3VycmVudFNjb3BlLmxlbmd0aCAtIDFdLCB0aGlzLmNvbnRleHQucGhhc2UpO1xuICAgICAgICAgIGxldCBuZXdCaW5kaW5nID0gZ2Vuc3ltKG5hbWUudmFsKCkpO1xuICAgICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncy5hZGRGb3J3YXJkKG5hbWVBZGRlZCwgbmFtZVJlbW92ZWQsIG5ld0JpbmRpbmcsIHRoaXMuY29udGV4dC5waGFzZSk7XG4gICAgICAgICAgcmV0dXJuIGRlY2wuZXh0ZW5kKHtcbiAgICAgICAgICAgIGluaXQ6IGRlY2wuaW5pdC5yZWR1Y2Uoc2NvcGVSZWR1Y2VyKVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIGZvciBzeW50YXggZGVjbGFyYXRpb25zIHdlIG5lZWQgdG8gbG9hZCB0aGUgY29tcGlsZXRpbWUgdmFsdWVcbiAgICAvLyBpbnRvIHRoZSBlbnZpcm9ubWVudFxuICAgIHJldHVybiB0ZXJtLmV4dGVuZCh7XG4gICAgICBkZWNsYXJhdG9yczogdGVybS5kZWNsYXJhdG9ycy5tYXAoZGVjbCA9PiB7XG4gICAgICAgIC8vIGVhY2ggY29tcGlsZXRpbWUgdmFsdWUgbmVlZHMgdG8gYmUgZXhwYW5kZWQgd2l0aCBhIGZyZXNoXG4gICAgICAgIC8vIGVudmlyb25tZW50IGFuZCBpbiB0aGUgbmV4dCBoaWdoZXIgcGhhc2VcbiAgICAgICAgbGV0IHN5bnRheEV4cGFuZGVyID0gbmV3IFRlcm1FeHBhbmRlcihfLm1lcmdlKHRoaXMuY29udGV4dCwge1xuICAgICAgICAgIHBoYXNlOiB0aGlzLmNvbnRleHQucGhhc2UgKyAxLFxuICAgICAgICAgIGVudjogbmV3IEVudigpLFxuICAgICAgICAgIHN0b3JlOiB0aGlzLmNvbnRleHQuc3RvcmVcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIGxldCBpbml0ID0gc3ludGF4RXhwYW5kZXIuZXhwYW5kKGRlY2wuaW5pdCk7XG4gICAgICAgIGxldCB2YWwgPSBldmFsQ29tcGlsZXRpbWVWYWx1ZShpbml0LCBfLm1lcmdlKHRoaXMuY29udGV4dCwge1xuICAgICAgICAgIHBoYXNlOiB0aGlzLmNvbnRleHQucGhhc2UgKyAxXG4gICAgICAgIH0pKTtcbiAgICAgICAgbGV0IHJlZCA9IG5ldyBSZWdpc3RlclN5bnRheEJpbmRpbmdzUmVkdWNlcihcbiAgICAgICAgICB0aGlzLmNvbnRleHQudXNlU2NvcGUsXG4gICAgICAgICAgdGhpcy5jb250ZXh0LnBoYXNlLFxuICAgICAgICAgIHRoaXMuY29udGV4dC5iaW5kaW5ncyxcbiAgICAgICAgICB0aGlzLmNvbnRleHQuZW52LFxuICAgICAgICAgIHZhbCk7XG4gICAgICAgIHJldHVybiBkZWNsLmV4dGVuZCh7IGJpbmRpbmc6IGRlY2wuYmluZGluZy5yZWR1Y2UocmVkKSwgaW5pdCB9KTtcbiAgICAgIH0pXG4gICAgfSk7XG4gIH1cblxuICAvLyByZWdpc3RlclN5bnRheERlY2xhcmF0b3IodGVybSkge1xuICAvL1xuICAvLyB9XG59XG4iXX0=